---
import type { Producto } from '../types';
import '@splidejs/splide/css/core.css';
import '@splidejs/splide/css/theme.css';

interface Props {
  products: Producto[];
  lang?: 'es' | 'pt';
}

const { products = [], lang = 'es' } = Astro.props;
---

<div class="product-carousel-wrapper">
  {products.length > 0 ? (
    <div class="splide product-carousel" id="product-carousel" data-products={JSON.stringify(products)}>
      <div class="splide__track">
        <ul class="splide__list">
          {products.map((product) => (
            <li class="splide__slide">
              <div class="product-card" data-product-id={product.id}>
                {product.imagen_saco?.url && (
                  <div class="product-image-wrapper">
                    <img
                      src={product.imagen_saco.url}
                      alt={product.imagen_saco.alt || product.nombre}
                      class="product-image"
                      loading="lazy"
                    />
                  </div>
                )}
                <div class="product-info">
                  <h3 class="product-name">{product.nombre}</h3>
                  {product.claim && (
                    <p class="product-claim">{product.claim}</p>
                  )}
                  <button
                    class="btn btn-primary product-view-btn"
                    data-product-id={product.id}
                    aria-label={`Ver detalles de ${product.nombre}`}
                  >
                    {lang === 'es' ? 'Ver detalles' : 'Ver detalhes'}
                  </button>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </div>
      <div class="splide__arrows">
        <button class="splide__arrow splide__arrow--prev" aria-label="Anterior"></button>
        <button class="splide__arrow splide__arrow--next" aria-label="Siguiente"></button>
      </div>
      <ul class="splide__pagination"></ul>
    </div>
  ) : (
    <div class="product-carousel-empty">
      <p>{lang === 'es' ? 'No se encontraron productos con los filtros seleccionados.' : 'Nenhum produto encontrado com os filtros selecionados.'}</p>
    </div>
  )}
</div>

<script>
  import Splide from '@splidejs/splide';

  document.addEventListener('DOMContentLoaded', () => {
    const carouselElement = document.getElementById('product-carousel');
    if (carouselElement) {
      const splide = new Splide(carouselElement, {
        type: 'loop',
        perPage: 4,
        perMove: 1,
        gap: '1.5rem',
        pagination: true,
        arrows: true,
        breakpoints: {
          1024: {
            perPage: 3,
          },
          768: {
            perPage: 2,
          },
          640: {
            perPage: 1,
          },
        },
      });
      splide.mount();
    }

    // Listen for product card clicks
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const productCard = target.closest('.product-card') as HTMLElement;
      const viewBtn = target.closest('.product-view-btn') as HTMLElement;
      
      if (productCard || viewBtn) {
        const productId = (productCard?.getAttribute('data-product-id') || 
                          viewBtn?.getAttribute('data-product-id')) || '';
        if (productId) {
          const event = new CustomEvent('productClick', {
            detail: { productId },
          });
          document.dispatchEvent(event);
        }
      }
    });
  });
</script>

<style>
  .product-carousel-wrapper {
    margin: var(--spacing-8) 0;
  }

  .product-carousel {
    padding: var(--spacing-4) 0;
  }

  .product-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .product-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .product-image-wrapper {
    width: 100%;
    aspect-ratio: 1;
    overflow: hidden;
    background-color: var(--color-gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: var(--spacing-4);
  }

  .product-info {
    padding: var(--spacing-4);
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: var(--spacing-2);
  }

  .product-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin: 0;
  }

  .product-claim {
    font-size: var(--font-size-sm);
    color: var(--color-gray-600);
    margin: 0;
    flex: 1;
  }

  .product-view-btn {
    margin-top: auto;
    width: 100%;
  }

  .product-carousel-empty {
    text-align: center;
    padding: var(--spacing-12);
    color: var(--color-gray-600);
  }

  /* Splide customizations */
  :global(.product-carousel .splide__arrow) {
    background-color: var(--color-dekalb-primary);
    opacity: 1;
  }

  :global(.product-carousel .splide__arrow:hover) {
    background-color: var(--color-dekalb-primary-dark);
  }

  :global(.product-carousel .splide__arrow--prev) {
    left: -1rem;
  }

  :global(.product-carousel .splide__arrow--next) {
    right: -1rem;
  }

  :global(.product-carousel .splide__pagination__page) {
    background-color: var(--color-gray-400);
    opacity: 1;
  }

  :global(.product-carousel .splide__pagination__page.is-active) {
    background-color: var(--color-dekalb-primary);
  }

  @media (max-width: 767px) {
    :global(.product-carousel .splide__arrow) {
      display: none;
    }
  }
</style>

