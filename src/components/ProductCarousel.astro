---
import type { Producto } from "../types";

interface Props {
  products: Producto[];
  lang?: "es" | "pt";
  carouselId?: string;
}

const {
  products = [],
  lang = "es",
  carouselId = "product-carousel",
} = Astro.props;
---

<div class="product-carousel-wrapper">
  {
    products.length > 0 ? (
      <div
        class="product-carousel-container"
        id={carouselId}
        data-products={JSON.stringify(products)}
      >
        <div
          class="product-carousel-track"
          id={`${carouselId}-track`}
        >
          {products.map((product) => (
            <div
              class="product-card"
              data-product-id={product.id}
            >
              {product.imagen_saco?.url && (
                <div class="product-image-wrapper">
                  <img
                    src={product.imagen_saco.url}
                    alt={product.imagen_saco.alt || product.nombre}
                    class="product-image"
                    loading="lazy"
                  />
                </div>
              )}
              {/* <div class="product-info">
              <h3 class="product-name">{product.nombre}</h3>
              {product.claim && (
                <p class="product-claim">{product.claim}</p>
              )}
              <button
                class="btn btn-primary product-view-btn"
                data-product-id={product.id}
                aria-label={`Ver detalles de ${product.nombre}`}
              >
                {lang === 'es' ? 'Ver detalles' : 'Ver detalhes'}
              </button>
            </div> */}
            </div>
          ))}
        </div>
        {products.length > 4 && (
          <div class="carousel-controls">
            <button
              class="carousel-button carousel-button-prev"
              aria-label="Anterior"
              id={`${carouselId}-prev`}
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M15 18l-6-6 6-6" />
              </svg>
            </button>
            <button
              class="carousel-button carousel-button-next"
              aria-label="Siguiente"
              id={`${carouselId}-next`}
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M9 18l6-6-6-6" />
              </svg>
            </button>
          </div>
        )}
      </div>
    ) : (
      <div class="product-carousel-empty">
        <p>
          {lang === "es"
            ? "No se encontraron productos con los filtros seleccionados."
            : "Nenhum produto encontrado com os filtros selecionados."}
        </p>
      </div>
    )
  }
</div>

<script define:vars={{ productsJson: JSON.stringify(products), carouselId }}>
  const CAROUSEL_ID = carouselId || "product-carousel";
  let currentProducts = JSON.parse(productsJson);
  let carouselTrack = null;
  let scrollPosition = 0;

  function updateCarousel(newProducts, isFiltered = false) {
    console.log(
      "ðŸ”„ [Carousel] Updating with products:",
      newProducts.length,
      "isFiltered:",
      isFiltered
    );
    currentProducts = newProducts;

    const carouselElement = document.getElementById(CAROUSEL_ID);
    const trackElement = document.getElementById(`${CAROUSEL_ID}-track`);

    if (!carouselElement || !trackElement) {
      console.error("âŒ [Carousel] Carousel elements not found");
      return;
    }

    // Update data attribute
    carouselElement.dataset.products = JSON.stringify(newProducts);

    // Clear and rebuild HTML
    trackElement.innerHTML = newProducts
      .map(
        (product) => `
      <div class="product-card" data-product-id="${product.id}">
        ${
          product.imagen_saco?.url
            ? `
          <div class="product-image-wrapper">
            <img
              src="${product.imagen_saco.url}"
              alt="${product.imagen_saco.alt || product.nombre}"
              class="product-image"
              loading="lazy"
            />
          </div>
        `
            : ""
        }
        <div class="product-info">
          <h3 class="product-name">${product.nombre}</h3>
          ${product.claim ? `<p class="product-claim">${product.claim}</p>` : ""}
          <button
            class="btn btn-primary product-view-btn"
            data-product-id="${product.id}"
            aria-label="Ver detalles de ${product.nombre}"
          >
            Ver detalles
          </button>
        </div>
      </div>
    `
      )
      .join("");

    // Center filtered results only if filters are active
    if (isFiltered) {
      // Wait for DOM to update before calculating scroll position
      setTimeout(() => {
        centerFilteredResults(trackElement, newProducts.length);
      }, 50);
    } else {
      // Reset styles when showing all products
      setTimeout(() => {
        trackElement.style.paddingLeft = "";
        trackElement.style.paddingRight = "";
        trackElement.style.display = "";
        trackElement.style.justifyContent = "";
        trackElement.scrollLeft = 0;
        scrollPosition = 0;
      }, 50);
    }

    // Update controls visibility
    const controls = carouselElement.querySelector(".carousel-controls");
    if (controls) {
      controls.style.display = newProducts.length > 4 ? "flex" : "none";
    }

    console.log("âœ… [Carousel] Updated with", newProducts.length, "products");
  }

  // Center filtered results in the carousel
  function centerFilteredResults(trackElement, productCount) {
    if (!trackElement || productCount === 0) {
      // Reset padding and display if no products
      trackElement.style.paddingLeft = "";
      trackElement.style.paddingRight = "";
      trackElement.style.display = "";
      trackElement.style.justifyContent = "";
      return;
    }

    const trackWidth = trackElement.clientWidth;
    const isDesktop = window.innerWidth >= 1024;

    // Wait a bit more for grid to layout properly
    setTimeout(() => {
      const firstCard = trackElement.querySelector(".product-card");
      if (!firstCard) {
        trackElement.style.paddingLeft = "";
        trackElement.style.paddingRight = "";
        trackElement.style.display = "";
        trackElement.style.justifyContent = "";
        return;
      }

      const cardWidth = firstCard.offsetWidth;
      let targetScrollPosition = 0;

      if (isDesktop) {
        // Desktop: 3 columns visible in grid
        // Each column takes up (trackWidth / 3) space
        const columnWidth = trackWidth / 3;

        if (productCount === 1) {
          // Center the single product in the middle column (position 2 of 3)
          // Switch to flexbox temporarily to center properly
          trackElement.style.display = "flex";
          trackElement.style.justifyContent = "center";
          trackElement.style.paddingLeft = `${columnWidth}px`;
          trackElement.style.paddingRight = `${columnWidth}px`;
          targetScrollPosition = 0;
        } else {
          // Multiple products: start from center position (position 2) and extend right
          // Position the first product in the center column using padding
          trackElement.style.display = "grid";
          trackElement.style.justifyContent = "";
          const paddingNeeded = columnWidth;
          trackElement.style.paddingLeft = `${Math.max(0, paddingNeeded)}px`;
          trackElement.style.paddingRight = "";
          targetScrollPosition = 0;
        }
      } else {
        // Mobile/Tablet: center single product, or start from center for multiple
        if (productCount === 1) {
          // Center the single product using flexbox
          trackElement.style.display = "flex";
          trackElement.style.justifyContent = "center";
          trackElement.style.paddingLeft = "";
          trackElement.style.paddingRight = "";
          targetScrollPosition = 0;
        } else {
          // For multiple products on mobile, start from a centered position
          trackElement.style.display = "grid";
          trackElement.style.justifyContent = "";
          const paddingNeeded = trackWidth / 2 - cardWidth / 2;
          trackElement.style.paddingLeft = `${Math.max(0, paddingNeeded)}px`;
          trackElement.style.paddingRight = "";
          targetScrollPosition = 0;
        }
      }

      // Reset scroll position
      scrollPosition = targetScrollPosition;
      trackElement.scrollTo({
        left: targetScrollPosition,
        behavior: "smooth",
      });

      console.log("ðŸŽ¯ [Carousel] Centered results:", {
        productCount,
        targetScrollPosition,
        isDesktop,
        trackWidth,
        cardWidth,
        paddingLeft: trackElement.style.paddingLeft,
      });
    }, 100);
  }

  // Function to update which card is in the center (desktop only) - disabled for 3-column layout
  function updateCenterCard() {
    // No longer needed with 3-column grid layout
    return;
  }

  function scrollCarousel(direction) {
    if (!carouselTrack) return;

    const cardWidth =
      carouselTrack.querySelector(".product-card")?.offsetWidth || 0;
    const gap = 24; // 1.5rem = 24px
    const scrollAmount = cardWidth + gap;

    scrollPosition += direction === "next" ? scrollAmount : -scrollAmount;

    // Clamp scroll position
    const maxScroll = carouselTrack.scrollWidth - carouselTrack.clientWidth;
    scrollPosition = Math.max(0, Math.min(scrollPosition, maxScroll));

    carouselTrack.scrollTo({
      left: scrollPosition,
      behavior: "smooth",
    });

    // Center card detection disabled for 3-column layout
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("ðŸŽ  [Carousel] DOMContentLoaded, initializing...", CAROUSEL_ID);
    carouselTrack = document.getElementById(`${CAROUSEL_ID}-track`);

    if (!carouselTrack) {
      console.error(
        "âŒ [Carousel] Track element not found:",
        `${CAROUSEL_ID}-track`
      );
      return;
    }

    // Setup navigation buttons
    const prevBtn = document.getElementById(`${CAROUSEL_ID}-prev`);
    const nextBtn = document.getElementById(`${CAROUSEL_ID}-next`);

    if (prevBtn) {
      prevBtn.addEventListener("click", () => scrollCarousel("prev"));
    }
    if (nextBtn) {
      nextBtn.addEventListener("click", () => scrollCarousel("next"));
    }

    // Update controls visibility
    const carouselElement = document.getElementById(CAROUSEL_ID);
    if (carouselElement) {
      const controls = carouselElement.querySelector(".carousel-controls");
      if (controls) {
        controls.style.display = currentProducts.length > 4 ? "flex" : "none";
      }
    }

    // Center card detection disabled for 3-column layout

    console.log("âœ… [Carousel] Initialized");
  });

  // Listen for product updates - only update if this carousel is visible
  document.addEventListener("updateProducts", (e) => {
    console.log("ðŸ”„ [Carousel] Received updateProducts event:", e.detail);
    const carouselElement = document.getElementById(CAROUSEL_ID);
    if (!carouselElement) return;

    // Check if this carousel is visible
    const rect = carouselElement.getBoundingClientRect();
    const isVisible =
      rect.width > 0 &&
      rect.height > 0 &&
      window.getComputedStyle(carouselElement).display !== "none";

    if (isVisible && e.detail && e.detail.products) {
      console.log("ðŸ”„ [Carousel] Updating visible carousel:", CAROUSEL_ID);
      const isFiltered = e.detail.isFiltered || false;
      updateCarousel(e.detail.products, isFiltered);
    } else {
      console.log(
        "âš ï¸ [Carousel] Carousel not visible, skipping update:",
        CAROUSEL_ID
      );
    }
  });

  // Listen for product card clicks
  document.addEventListener("click", (e) => {
    const target = e.target;
    const productCard = target.closest(".product-card");
    const viewBtn = target.closest(".product-view-btn");

    if (productCard || viewBtn) {
      const productId =
        productCard?.getAttribute("data-product-id") ||
        viewBtn?.getAttribute("data-product-id") ||
        "";
      if (productId) {
        const event = new CustomEvent("productClick", {
          detail: { productId },
        });
        document.dispatchEvent(event);
      }
    }
  });
</script>

<style>
  .product-carousel-wrapper {
    margin: var(--spacing-8) 0;
    position: relative;
  }

  .product-carousel-container {
    position: relative;
    padding: var(--spacing-4) 0;
  }

  .product-carousel-track {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--spacing-6);
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: var(--color-gray-400) var(--color-gray-100);
    -webkit-overflow-scrolling: touch;
    padding: var(--spacing-2) 0;
  }

  .product-carousel-track::-webkit-scrollbar {
    height: 8px;
  }

  .product-carousel-track::-webkit-scrollbar-track {
    background: var(--color-gray-100);
    border-radius: var(--radius-md);
  }

  .product-carousel-track::-webkit-scrollbar-thumb {
    background: var(--color-gray-400);
    border-radius: var(--radius-md);
  }

  .product-carousel-track::-webkit-scrollbar-thumb:hover {
    background: var(--color-bayer-secondary);
  }

  /* Mobile: single column scroll */
  @media (max-width: 767px) {
    .product-carousel-track {
      grid-template-columns: 1fr;
      gap: var(--spacing-4);
    }
  }

  /* Tablet: 2 columns */
  @media (min-width: 768px) and (max-width: 1023px) {
    .product-carousel-track {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Desktop: 3 visible cards with transparent background */
  @media (min-width: 1024px) {
    .product-carousel-track {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-6);
      overflow-x: auto;
      padding: var(--spacing-4);
      width: 100%;
    }

    .product-card {
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      overflow: visible;
      min-width: 0;
      padding: 0;
    }

    .product-image-wrapper {
      background: transparent;
      overflow: visible;
    }

    .product-image {
      object-fit: contain;
      object-position: center;
    }
  }

  .product-card {
    background: transparent;
    border-radius: 0;
    overflow: visible;
    box-shadow: none;
    transition: all var(--transition-base);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 100%;
    min-width: 280px;
    padding: 0;
  }

  .product-card:hover {
    box-shadow: none;
  }

  .product-image-wrapper {
    width: 100%;
    aspect-ratio: 1;
    overflow: visible;
    background-color: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: var(--spacing-4);
  }

  .product-info {
    padding: var(--spacing-4);
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: var(--spacing-2);
  }

  .product-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin: 0;
  }

  .product-claim {
    font-size: var(--font-size-sm);
    color: var(--color-gray-600);
    margin: 0;
    flex: 1;
  }

  .product-view-btn {
    margin-top: auto;
    width: 100%;
  }

  .product-carousel-empty {
    text-align: center;
    padding: var(--spacing-12);
    color: var(--color-gray-600);
  }

  .carousel-controls {
    display: flex;
    justify-content: center;
    gap: var(--spacing-4);
    margin-top: var(--spacing-6);
  }

  .carousel-button {
    background: var(--gradient-button-primary);
    color: var(--color-white);
    border: none;
    border-radius: var(--radius-full);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-md);
  }

  .carousel-button:hover {
    opacity: 0.9;
    transform: scale(1.05);
  }

  .carousel-button:active {
    transform: scale(0.95);
  }

  .carousel-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 767px) {
    .carousel-controls {
      display: none;
    }

    .product-carousel-track {
      scroll-snap-type: x mandatory;
    }

    .product-card {
      scroll-snap-align: start;
    }
  }
</style>
