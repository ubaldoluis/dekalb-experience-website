---
interface Props {
  /**
   * Optional extra class names for the wrapper element.
   * Keep this component as a minimal reusable primitive.
   */
  class?: string;
}

const { class: className } = Astro.props;
---

<div
  class={className}
  data-scroll-reveal
>
  <slot />
</div>

<script>
  const REVEAL_ATTR = "data-scroll-reveal";
  const REVEALED_CLASS = "is-scroll-revealed";

  declare global {
    interface Window {
      __scrollRevealInit?: boolean;
    }
  }

  function initScrollReveal() {
    if (window.__scrollRevealInit) return;
    window.__scrollRevealInit = true;

    const elements = Array.from(
      document.querySelectorAll(`[${REVEAL_ATTR}]`)
    ) as HTMLElement[];

    if (elements.length === 0) return;

    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    ).matches;

    if (prefersReducedMotion) {
      elements.forEach((el) => el.classList.add(REVEALED_CLASS));
      return;
    }

    const observer = new IntersectionObserver(
      (entries, obs) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) return;
          const el = entry.target as HTMLElement;
          el.classList.add(REVEALED_CLASS);
          obs.unobserve(el);
        });
      },
      {
        threshold: 0.15,
        rootMargin: "0px 0px -10% 0px",
      }
    );

    elements.forEach((el) => observer.observe(el));
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initScrollReveal, {
      once: true,
    });
  } else {
    initScrollReveal();
  }
</script>

<style is:global>
  [data-scroll-reveal] {
    opacity: 0;
    transform: translateY(16px);
    transition: opacity 500ms ease, transform 500ms ease;
    will-change: opacity, transform;
  }

  [data-scroll-reveal].is-scroll-revealed {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    [data-scroll-reveal] {
      opacity: 1;
      transform: none;
      transition: none;
      will-change: auto;
    }
  }
</style>

