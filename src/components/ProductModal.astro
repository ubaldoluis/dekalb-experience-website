---
import type { Producto } from '../types';

interface Props {
  product?: Producto | null;
  lang?: 'es' | 'pt';
}

const { product = null, lang = 'es' } = Astro.props;

const translations = {
  es: {
    close: 'Cerrar',
    description: 'DESCRIPCIÃ“N',
    characteristics: 'CARACTERÃSTICAS',
    recommendations: 'Recomendaciones',
    pdfGuide: 'GuÃ­a en PDF',
    cycle: 'CICLO/RM',
    grainType: 'Tipo de Grano',
    flowering: 'FloraciÃ³n',
    earInsertion: 'InserciÃ³n de mazorca',
    productionPotential: 'Potencial de producciÃ³n',
    adaptability: 'Adaptabilidad',
    fallResistance: 'Resistencia a la caÃ­da',
    virusTolerance: 'Tolerancia a virus',
    stayGreen: 'Stay-green',
    highDensityResponse: 'Respuesta a alta densidad',
    grainQuality: 'Calidad de grano',
  },
  pt: {
    close: 'Fechar',
    description: 'DESCRIÃ‡ÃƒO',
    characteristics: 'CARACTERÃSTICAS',
    recommendations: 'RecomendaÃ§Ãµes',
    pdfGuide: 'Guia em PDF',
    cycle: 'CICLO/RM',
    grainType: 'Tipo de GrÃ£o',
    flowering: 'FloraÃ§Ã£o',
    earInsertion: 'InserÃ§Ã£o de espiga',
    productionPotential: 'Potencial de produÃ§Ã£o',
    adaptability: 'Adaptabilidade',
    fallResistance: 'ResistÃªncia ao acamamento',
    virusTolerance: 'TolerÃ¢ncia a vÃ­rus',
    stayGreen: 'Stay-green',
    highDensityResponse: 'Resposta a alta densidade',
    grainQuality: 'Qualidade do grÃ£o',
  },
};

const t = translations[lang];

const featureLabels = {
  potencial_produccion: { es: 'Potencial de producciÃ³n', pt: 'Potencial de produÃ§Ã£o' },
  adaptabilidad: { es: 'Adaptabilidad', pt: 'Adaptabilidade' },
  resistencia_caida: { es: 'Resistencia a la caÃ­da', pt: 'ResistÃªncia ao acamamento' },
  tolerancia_virus: { es: 'Tolerancia a virus', pt: 'TolerÃ¢ncia a vÃ­rus' },
  stay_green: { es: 'Stay-green', pt: 'Stay-green' },
  respuesta_alta_densidad: { es: 'Respuesta a alta densidad', pt: 'Resposta a alta densidade' },
  calidad_grano: { es: 'Calidad de grano', pt: 'Qualidade do grÃ£o' },
  contenido_aceite: { es: 'Contenido de aceite', pt: 'Teor de Ã³leo' },
  tolerancia_dehiscencia: { es: 'Tolerancia a dehiscencia', pt: 'TolerÃ¢ncia Ã  deiscÃªncia' },
  sanidad: { es: 'Sanidad', pt: 'Sanidade' },
  tolerancia_sequia: { es: 'Tolerancia a la sequÃ­a', pt: 'TolerÃ¢ncia Ã  seca' },
  implantacion: { es: 'ImplantaciÃ³n', pt: 'ImplantaÃ§Ã£o' },
};

const featureOrderBySeed = {
  maiz: [
    'potencial_produccion',
    'adaptabilidad',
    'resistencia_caida',
    'tolerancia_virus',
    'stay_green',
    'respuesta_alta_densidad',
    'calidad_grano',
  ],
  colza: [
    'potencial_produccion',
    'contenido_aceite',
    'tolerancia_dehiscencia',
    'sanidad',
    'adaptabilidad',
    'tolerancia_sequia',
    'implantacion',
  ],
};

const orderedFeatures = (product && product.caracteristicas && product.tipo_semilla && featureOrderBySeed[product.tipo_semilla])
  ? featureOrderBySeed[product.tipo_semilla].map((k) => {
      return product.caracteristicas.find((c) => c.clave === k);
    }).filter(Boolean)
  : [];

// Parse ciclo_rm to extract cycle and rm values
const parseCicloRM = (cicloRM) => {
  if (!cicloRM) return { cycle: '', rm: '' };
  const parts = cicloRM.split('/');
  return {
    cycle: (parts[0] && parts[0].trim()) || '',
    rm: (parts[1] && parts[1].trim()) || '',
  };
};

const cicloRM = product ? parseCicloRM(product.ciclo_rm) : { cycle: '', rm: '' };

// Helper function to check if a value exists and is not empty
// More robust validation to handle all edge cases
function hasValue(val) {
  // Check for null, undefined, or falsy values
  if (val === null || val === undefined || val === false) return false;
  
  // If it's not a string, convert it to string first
  const strVal = typeof val === 'string' ? val : String(val);
  
  // Check if trimmed string has content
  const trimmed = strVal.trim();
  if (trimmed.length === 0) return false;
  
  // Additional check: if it's just whitespace or special characters
  if (trimmed === '' || trimmed === 'null' || trimmed === 'undefined') return false;
  
  return true;
}

// Check if product has any basic characteristics with values
const hasBasicCharacteristics = product && (
  hasValue(product.tipo_grano) || 
  hasValue(product.floracion_texto) || 
  hasValue(product.insercion_mazorca)
);

// Check if we should show characteristics section
const shouldShowCharacteristics = hasBasicCharacteristics || (orderedFeatures && orderedFeatures.length > 0);
---

<dialog class="product-modal" id="product-modal" aria-labelledby="modal-title" aria-modal="true">
  <div class="modal-content" id="modal-content-container">
  {product ? (
    <>
      <!-- Left Column: Image -->
      <div class="modal-image-section">
        <a 
          href="#"
          class="modal-close-btn" 
          id="modal-close" 
          aria-label={t.close}
          role="button"
          onclick="event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); const modal = document.getElementById('product-modal'); if (modal && window.__modalCloseHandler) { window.__modalCloseHandler.setClosing(true); modal.close(); document.body.style.overflow = ''; setTimeout(() => { window.__modalCloseHandler.setClosing(false); }, 100); } return false;"
        >
          <div class="modal-close-circle">
            <svg width="19" height="19" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>
        {product.imagen_saco?.url && (
          <div class="modal-image-wrapper">
            <img
              src={product.imagen_saco.url}
              alt={product.imagen_saco.alt || product.nombre}
              class="modal-product-image"
              loading="lazy"
            />
          </div>
        )}
      </div>

      <!-- Right Column: Content -->
      <div class="modal-info-section">
        <div class="modal-scroll-content">
          <!-- Header: Title and CICLO/RM -->
          <div class="modal-header">
            <h2 id="modal-title" class="modal-title">{product.nombre}</h2>
            {product.ciclo_rm && (
              <div class="modal-ciclo-rm">
                <div class="ciclo-rm-container">
                  <div class="ciclo-rm-left">
                    <span class="ciclo-rm-label">{t.cycle}</span>
                  </div>
                  <div class="ciclo-rm-right">
                    <span class="ciclo-rm-value">{cicloRM.cycle}/{cicloRM.rm}</span>
                  </div>
                </div>
              </div>
            )}
          </div>

          <!-- Description Section -->
          {product.descripcion_popup && (
            <div class="modal-section">
              <h3 class="modal-section-title">{t.description}</h3>
              <p class="modal-description-text">{product.descripcion_popup}</p>
            </div>
          )}

          <!-- Separator Line -->
          {(product.descripcion_popup || product.ciclo_rm) && (
            <div class="modal-separator"></div>
          )}

          <!-- Characteristics Section -->
          {shouldShowCharacteristics && (
            <div class="modal-section">
              <h3 class="modal-section-title">{t.characteristics}</h3>
              
              <!-- Basic Details (MaÃ­z) -->
              {product.tipo_semilla === 'maiz' && hasBasicCharacteristics && (
                <div class="modal-characteristics-list">
                  {hasValue(product.tipo_grano) && (
                    <div class="modal-characteristic-item">
                      <span class="characteristic-label">{t.grainType}</span>
                      <span class="characteristic-value">{product.tipo_grano}</span>
                    </div>
                  )}
                  {hasValue(product.floracion_texto) && (
                    <div class="modal-characteristic-item">
                      <span class="characteristic-label">{t.flowering}</span>
                      <span class="characteristic-value">{product.floracion_texto}</span>
                    </div>
                  )}
                  {hasValue(product.insercion_mazorca) && (
                    <div class="modal-characteristic-item">
                      <span class="characteristic-label">{t.earInsertion}</span>
                      <span class="characteristic-value">{product.insercion_mazorca}</span>
                    </div>
                  )}
                </div>
              )}

              <!-- Features with Progress Bars -->
              {orderedFeatures.length > 0 && (
                <div class="modal-features-list">
                  {orderedFeatures.map((feat) => {
                    const label =
                      feat.label_custom ||
                      featureLabels[feat.clave]?.[lang] ||
                      feat.clave;
                    const value = Math.max(0, Math.min(10, Number(feat.valor) || 0));
                    const percent = (value / 10) * 100;
                    return (
                      <div class="modal-feature-item">
                        <span class="feature-label">{label}</span>
                        <div class="feature-progress-container">
                          <div class="feature-progress-bar">
                            <div 
                              class="feature-progress-fill" 
                              style={{ width: `${percent}%` }}
                            ></div>
                          </div>
                          <span class="feature-value">{value}/10</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          <!-- Separator Line -->
          {product.recomendaciones_uso && (
            <div class="modal-separator"></div>
          )}

          <!-- Recommendations Section -->
          {product.recomendaciones_uso && (
            <div class="modal-recommendations-section">
              <h3 class="modal-recommendations-title">{t.recommendations}</h3>
              <p class="modal-recommendations-text">{product.recomendaciones_uso}</p>
            </div>
          )}

          <!-- Separator Line -->
          <div class="modal-separator"></div>

          <!-- PDF Guide Button -->
          <a 
            href={product.guia_pdf?.url || '#'} 
            class="modal-pdf-button"
            target={product.guia_pdf?.url ? "_blank" : undefined}
            rel={product.guia_pdf?.url ? "noopener noreferrer" : undefined}
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>{t.pdfGuide}</span>
          </a>
        </div>
      </div>
    </>
  ) : (
    <div class="modal-loading">
      <p>{lang === 'es' ? 'Cargando producto...' : 'Carregando produto...'}</p>
    </div>
  )}
  </div>
</dialog>

<script define:vars={{ lang }}>
  // Track the last click target to determine if close was intentional
  let lastClickTarget = null;
  let isClosingIntentionally = false;
  
  // Wait for DOM to be ready
  function initModal() {
    const modal = document.getElementById('product-modal');
    const closeBtn = document.getElementById('modal-close');
    
    if (!modal) {
      console.error('âŒ [Modal] Modal element not found');
      return;
    }
    
    // Store current language globally
    window.__currentLang = lang;
    console.log('âœ… [Modal] Initialized with lang:', lang);
    
    // Track all clicks globally to know what was clicked
    document.addEventListener('click', (e) => {
      if (modal && modal.open) {
        lastClickTarget = e.target;
      }
    }, true);

  function updateModalContent(product) {
    if (!product || !modal) {
      console.error('âŒ [Modal] Missing product or modal:', { product: !!product, modal: !!modal });
      return;
    }

    console.log('ðŸ” [Modal] Updating with product:', {
      nombre: product.nombre,
      id: product.id,
      ciclo_rm: product.ciclo_rm
    });

    const modalContent = document.getElementById('modal-content-container');
    if (!modalContent) {
      console.error('âŒ [Modal] Modal content container not found');
      return;
    }

    // Parse ciclo_rm
    const parseCicloRM = (cicloRM) => {
      if (!cicloRM) return { cycle: '', rm: '' };
      const parts = cicloRM.split('/');
      return {
        cycle: (parts[0] && parts[0].trim()) || '',
        rm: (parts[1] && parts[1].trim()) || '',
      };
    };

    const cicloRM = parseCicloRM(product.ciclo_rm);

    // Helper function to check if a value exists and is not empty
    // More robust validation to handle all edge cases
    const hasValue = (val) => {
      // Check for null, undefined, or falsy values
      if (val === null || val === undefined || val === false) return false;
      
      // If it's not a string, convert it to string first
      const strVal = typeof val === 'string' ? val : String(val);
      
      // Check if trimmed string has content
      const trimmed = strVal.trim();
      if (trimmed.length === 0) return false;
      
      // Additional check: if it's just whitespace or special characters
      if (trimmed === '' || trimmed === 'null' || trimmed === 'undefined') return false;
      
      return true;
    };
    
    // Debug: Log characteristic values for troubleshooting
    console.log('ðŸ” [Modal] Characteristic values for', product.codigo || product.nombre, ':', {
      tipo_grano: product.tipo_grano,
      tipo_grano_type: typeof product.tipo_grano,
      tipo_grano_hasValue: hasValue(product.tipo_grano),
      floracion_texto: product.floracion_texto,
      floracion_texto_type: typeof product.floracion_texto,
      floracion_texto_hasValue: hasValue(product.floracion_texto),
      insercion_mazorca: product.insercion_mazorca,
      insercion_mazorca_type: typeof product.insercion_mazorca,
      insercion_mazorca_hasValue: hasValue(product.insercion_mazorca),
    });

    // Feature labels mapping
    const featureLabels = {
      potencial_produccion: { es: 'Potencial de producciÃ³n', pt: 'Potencial de produÃ§Ã£o' },
      adaptabilidad: { es: 'Adaptabilidad', pt: 'Adaptabilidade' },
      resistencia_caida: { es: 'Resistencia a la caÃ­da', pt: 'ResistÃªncia ao acamamento' },
      tolerancia_virus: { es: 'Tolerancia a virus', pt: 'TolerÃ¢ncia a vÃ­rus' },
      stay_green: { es: 'Stay-green', pt: 'Stay-green' },
      respuesta_alta_densidad: { es: 'Respuesta a alta densidad', pt: 'Resposta a alta densidade' },
      calidad_grano: { es: 'Calidad de grano', pt: 'Qualidade do grÃ£o' },
      contenido_aceite: { es: 'Contenido de aceite', pt: 'Teor de Ã³leo' },
      tolerancia_dehiscencia: { es: 'Tolerancia a dehiscencia', pt: 'TolerÃ¢ncia Ã  deiscÃªncia' },
      sanidad: { es: 'Sanidad', pt: 'Sanidade' },
      tolerancia_sequia: { es: 'Tolerancia a la sequÃ­a', pt: 'TolerÃ¢ncia Ã  seca' },
      implantacion: { es: 'ImplantaciÃ³n', pt: 'ImplantaÃ§Ã£o' },
    };

    const featureOrderBySeed = {
      maiz: [
        'potencial_produccion',
        'adaptabilidad',
        'resistencia_caida',
        'tolerancia_virus',
        'stay_green',
        'respuesta_alta_densidad',
        'calidad_grano',
      ],
      colza: [
        'potencial_produccion',
        'contenido_aceite',
        'tolerancia_dehiscencia',
        'sanidad',
        'adaptabilidad',
        'tolerancia_sequia',
        'implantacion',
      ],
    };

    const orderedFeatures = (product.caracteristicas && product.tipo_semilla && featureOrderBySeed[product.tipo_semilla])
      ? featureOrderBySeed[product.tipo_semilla].map((k) => {
          return product.caracteristicas.find((c) => c.clave === k);
        }).filter(Boolean)
      : [];

    const currentLang = window.__currentLang || lang || 'es';
    const translations = {
      es: {
        description: 'DESCRIPCIÃ“N',
        characteristics: 'CARACTERÃSTICAS',
        recommendations: 'Recomendaciones',
        pdfGuide: 'GuÃ­a en PDF',
        cycle: 'CICLO/RM',
        grainType: 'Tipo de Grano',
        flowering: 'FloraciÃ³n',
        earInsertion: 'InserciÃ³n de mazorca',
      },
      pt: {
        description: 'DESCRIÃ‡ÃƒO',
        characteristics: 'CARACTERÃSTICAS',
        recommendations: 'RecomendaÃ§Ãµes',
        pdfGuide: 'Guia em PDF',
        cycle: 'CICLO/RM',
        grainType: 'Tipo de GrÃ£o',
        flowering: 'FloraÃ§Ã£o',
        earInsertion: 'InserÃ§Ã£o de espiga',
      },
    };
    const t = translations[currentLang] || translations.es;

    // âœ… SECURITY: Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // âœ… SECURITY: Validate image URL
    function isValidImageUrl(url) {
      if (!url || typeof url !== 'string') return false;
      try {
        const urlObj = new URL(url);
        if (!['http:', 'https:'].includes(urlObj.protocol)) return false;
        const allowedDomains = ['prismic.io', 'images.prismic.io', 'cdn.prismic.io', 'dekalb-experience.com'];
        const hostname = urlObj.hostname.toLowerCase();
        return allowedDomains.some(domain => hostname === domain || hostname.endsWith('.' + domain));
      } catch {
        return false;
      }
    }

    // Build HTML content with escaped values
    const productNombre = escapeHtml(product.nombre || product.id || 'Producto sin nombre');
    const productDescripcion = escapeHtml(product.descripcion_popup || '');
    const productTipoGrano = escapeHtml(product.tipo_grano || '');
    const productFloracion = escapeHtml(product.floracion_texto || '');
    const productInsercion = escapeHtml(product.insercion_mazorca || '');
    const productRecomendaciones = escapeHtml(product.recomendaciones_uso || '');
    const imagenUrl = (product.imagen_saco && product.imagen_saco.url && isValidImageUrl(product.imagen_saco.url)) 
      ? product.imagen_saco.url 
      : '';
    const imagenAlt = escapeHtml(product.imagen_saco?.alt || product.nombre || '');
    const pdfUrl = (product.guia_pdf && product.guia_pdf.url) ? escapeHtml(product.guia_pdf.url) : '#';

    let html = `
      <div class="modal-image-section">
        <a 
          href="#"
          class="modal-close-btn" 
          id="modal-close" 
          aria-label="${lang === 'es' ? 'Cerrar' : 'Fechar'}"
          role="button"
          onclick="event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); const modal = document.getElementById('product-modal'); if (modal && window.__modalCloseHandler) { window.__modalCloseHandler.setClosing(true); modal.close(); document.body.style.overflow = ''; setTimeout(() => { window.__modalCloseHandler.setClosing(false); }, 100); } return false;"
        >
          <div class="modal-close-circle">
            <svg width="19" height="19" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>
        ${imagenUrl ? `
          <div class="modal-image-wrapper">
            <img
              src="${imagenUrl}"
              alt="${imagenAlt}"
              class="modal-product-image"
              loading="lazy"
            />
          </div>
        ` : ''}
      </div>
      <div class="modal-info-section">
        <div class="modal-scroll-content">
          <div class="modal-header">
            <h2 id="modal-title" class="modal-title">${productNombre}</h2>
            ${product.ciclo_rm ? `
              <div class="modal-ciclo-rm">
                <div class="ciclo-rm-container">
                  <div class="ciclo-rm-left">
                    <span class="ciclo-rm-label">${t.cycle}</span>
                  </div>
                  <div class="ciclo-rm-right">
                    <span class="ciclo-rm-value">${cicloRM.cycle}/${cicloRM.rm}</span>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
          ${product.descripcion_popup ? `
            <div class="modal-section">
              <h3 class="modal-section-title">${t.description}</h3>
              <p class="modal-description-text">${productDescripcion}</p>
            </div>
          ` : ''}
          ${(product.descripcion_popup || product.ciclo_rm) ? '<div class="modal-separator"></div>' : ''}
          ${((hasValue(product.tipo_grano) || hasValue(product.floracion_texto) || hasValue(product.insercion_mazorca)) || orderedFeatures.length > 0) ? `
            <div class="modal-section">
              <h3 class="modal-section-title">${t.characteristics}</h3>
              ${product.tipo_semilla === 'maiz' && (hasValue(product.tipo_grano) || hasValue(product.floracion_texto) || hasValue(product.insercion_mazorca)) ? `
                <div class="modal-characteristics-list">
                  ${hasValue(product.tipo_grano) ? `<div class="modal-characteristic-item"><span class="characteristic-label">${t.grainType}</span><span class="characteristic-value">${productTipoGrano}</span></div>` : ''}
                  ${hasValue(product.floracion_texto) ? `<div class="modal-characteristic-item"><span class="characteristic-label">${t.flowering}</span><span class="characteristic-value">${productFloracion}</span></div>` : ''}
                  ${hasValue(product.insercion_mazorca) ? `<div class="modal-characteristic-item"><span class="characteristic-label">${t.earInsertion}</span><span class="characteristic-value">${productInsercion}</span></div>` : ''}
                </div>
              ` : ''}
              ${orderedFeatures.length > 0 ? `
                <div class="modal-features-list">
                  ${orderedFeatures.map((feat) => {
                    const featLabel = featureLabels[feat.clave];
                    const label = feat.label_custom || (featLabel && featLabel[currentLang]) || feat.clave;
                    const value = Math.max(0, Math.min(10, Number(feat.valor) || 0));
                    const percent = (value / 10) * 100;
                    return `
                      <div class="modal-feature-item">
                        <span class="feature-label">${escapeHtml(label)}</span>
                        <div class="feature-progress-container">
                          <div class="feature-progress-bar">
                            <div class="feature-progress-fill" style="width: ${percent}%"></div>
                          </div>
                          <span class="feature-value">${value}/10</span>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}
          ${product.recomendaciones_uso ? '<div class="modal-separator"></div>' : ''}
          ${product.recomendaciones_uso ? `
            <div class="modal-recommendations-section">
              <h3 class="modal-recommendations-title">${t.recommendations}</h3>
              <p class="modal-recommendations-text">${productRecomendaciones}</p>
            </div>
          ` : ''}
          <div class="modal-separator"></div>
          <a href="${pdfUrl}" class="modal-pdf-button" ${(product.guia_pdf && product.guia_pdf.url) ? 'target="_blank" rel="noopener noreferrer"' : ''}>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>${t.pdfGuide}</span>
          </a>
        </div>
      </div>
    `;

    modalContent.innerHTML = html;

    // Set up close button FIRST, before any other listeners
    const newCloseBtn = modalContent.querySelector('#modal-close');
    if (newCloseBtn) {
      console.log('ðŸ”´ [Modal] Setting up close button:', newCloseBtn);
      
      // Force z-index to be high but not interfere with filter dropdown (z-index: 1000)
      newCloseBtn.style.zIndex = '1000';
      newCloseBtn.style.position = 'absolute';
      newCloseBtn.style.pointerEvents = 'auto';
      
      // CRITICAL: Add listener in capture phase FIRST with highest priority
      // This MUST execute before any other listeners that might block it
      // Use a flag to prevent multiple executions
      let isHandlingClose = false;
      const forceCloseHandler = (e) => {
        if (isHandlingClose) {
          e.stopImmediatePropagation();
          e.stopPropagation();
          e.preventDefault();
          return false;
        }
        isHandlingClose = true;
        
        console.log('ðŸ”´ðŸ”´ðŸ”´ [Modal] Close button CAPTURE handler executed');
        e.stopImmediatePropagation(); // Stop ALL other listeners
        e.stopPropagation();
        e.preventDefault();
        
        // EXACT copy of backdrop click behavior - set BOTH flags
        // Set the closure variable directly AND through the handler
        isClosingIntentionally = true;
        if (window.__modalCloseHandler) {
          window.__modalCloseHandler.setClosing(true);
        }
        
        // Call closeModal() which is the same function backdrop uses
        const modal = document.getElementById('product-modal');
        if (modal) {
          modal.close();
          document.body.style.overflow = '';
        }
        
        // Reset flags after delay, exactly like backdrop click
        setTimeout(() => {
          isHandlingClose = false;
          isClosingIntentionally = false;
          if (window.__modalCloseHandler) {
            window.__modalCloseHandler.setClosing(false);
          }
        }, 200);
        
        return false;
      };
      
      // Add in capture phase FIRST - this executes BEFORE any other listeners
      newCloseBtn.addEventListener('click', forceCloseHandler, true);
      
      // Also add in bubbling phase as backup
      newCloseBtn.addEventListener('click', forceCloseHandler, false);
      
      // Also add mousedown as backup (fires before click)
      newCloseBtn.addEventListener('mousedown', forceCloseHandler, true);
      
      // Also set onclick attribute as additional fallback
      newCloseBtn.setAttribute('onclick', `
        console.log('ðŸ”´ðŸ”´ðŸ”´ [Modal] onclick inline executed');
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        const modal = document.getElementById('product-modal');
        if (modal && window.__modalCloseHandler) {
          window.__modalCloseHandler.setClosing(true);
          modal.close();
          document.body.style.overflow = '';
          setTimeout(() => {
            window.__modalCloseHandler.setClosing(false);
          }, 100);
        }
        return false;
      `);
    }

    // CRITICAL: Prevent clicks inside modal content from propagating to dialog
    // BUT do this AFTER setting up the close button
    // IMPORTANT: Only prevent if click is INSIDE the modal, not outside (like filter dropdown)
    const newModalContent = modalContent.querySelector('.modal-content');
    if (newModalContent) {
      // Only prevent if NOT clicking on close button AND click is inside modal
      const preventHandler = (e) => {
        // CRITICAL: Check if click is actually inside the modal content
        // Don't interfere with clicks outside the modal (like filter dropdown)
        const modal = document.getElementById('product-modal');
        if (!modal || !modal.contains(e.target)) {
          return; // Click is outside modal, don't interfere
        }
        
        const closeBtnEl = newModalContent.querySelector('#modal-close');
        // CRITICAL: Check if click originated from or is on close button
        if (closeBtnEl && (
          closeBtnEl === e.target || 
          closeBtnEl.contains(e.target) ||
          e.target.closest('#modal-close')
        )) {
          return; // Don't prevent - let close button handle it
        }
        e.stopPropagation();
      };
      
      // Use bubbling phase (not capture) so close button handler executes first
      // AND so it doesn't interfere with clicks outside the modal
      newModalContent.addEventListener('click', preventHandler, false);
    }

    // Center content vertically if it's shorter than container
    const scrollContent = modalContent.querySelector('.modal-scroll-content');
    if (scrollContent) {
      // Wait for content to render and images to load
      setTimeout(() => {
        const scrollHeight = scrollContent.scrollHeight;
        const clientHeight = scrollContent.clientHeight;
        console.log('ðŸ“ [Modal] Scroll check:', { 
          scrollHeight, 
          clientHeight, 
          canScroll: scrollHeight > clientHeight,
          computedHeight: window.getComputedStyle(scrollContent).height,
          parentHeight: scrollContent.parentElement?.clientHeight
        });
        if (scrollHeight < clientHeight) {
          scrollContent.style.justifyContent = 'center';
        } else {
          scrollContent.style.justifyContent = 'flex-start';
        }
      }, 200);
    }

    // Close button is already set up above (line 493), no need to set it up again here
  }

  function openModal() {
    if (modal) {
      modal.showModal();
      document.body.style.overflow = 'hidden';
      
      // Ensure click prevention is active after opening modal
      // IMPORTANT: Only prevent clicks INSIDE the modal, not outside (like filter dropdown)
      setTimeout(() => {
        const modalContentEl = modal.querySelector('.modal-content');
        if (modalContentEl) {
          // Use bubbling phase (not capture) to avoid interfering with clicks outside modal
          const preventHandler = (e) => {
            // CRITICAL: Only prevent if click is actually inside the modal
            if (!modal.contains(e.target)) {
              return; // Click is outside modal, don't interfere
            }
            
            const closeBtnEl = modalContentEl.querySelector('#modal-close');
            // Don't prevent if clicking on close button
            if (closeBtnEl && (
              closeBtnEl === e.target || 
              closeBtnEl.contains(e.target) ||
              e.target.closest('#modal-close')
            )) {
              return; // Let close button handle it
            }
            
            e.stopPropagation();
          };
          
          modalContentEl.addEventListener('click', preventHandler, false);
        }
      }, 0);
    }
  }

  function closeModal() {
    const modal = document.getElementById('product-modal');
    if (modal) {
      modal.close();
      document.body.style.overflow = '';
    }
  }

    // Listen for product click events
    document.addEventListener('productClick', (e) => {
      const customEvent = e;
      const productId = (customEvent.detail && customEvent.detail.productId) || null;
      
      if (!productId) {
        console.error('âŒ [Modal] No productId in event:', customEvent);
        return;
      }

      console.log('ðŸ”„ [Modal] Product clicked:', productId);
      
      const allProducts = window.__allProducts || [];
      console.log('ðŸ“¦ [Modal] All products available:', allProducts.length);
      
      const product = allProducts.find((p) => p.id === productId);
      
      if (product) {
        console.log('âœ… [Modal] Product found, updating modal:', product.nombre);
        updateModalContent(product);
        openModal();
      } else {
        console.error('âŒ [Modal] Product not found:', productId);
        console.log('Available product IDs:', allProducts.map(function(p) { return p.id; }));
      }
    });

    // Close button - handle clicks to close the modal
    // Set up FIRST before any other listeners
    if (closeBtn) {
      console.log('ðŸ”´ [Modal] Setting up static close button:', closeBtn);
      
      // Force z-index to be high but not interfere with filter dropdown (z-index: 1000)
      closeBtn.style.zIndex = '1000';
      closeBtn.style.position = 'absolute';
      closeBtn.style.pointerEvents = 'auto';
      
      // CRITICAL: Add listener in capture phase FIRST with highest priority
      const forceCloseHandler = (e) => {
        console.log('ðŸ”´ðŸ”´ðŸ”´ [Modal] Static close button CAPTURE handler executed');
        e.stopImmediatePropagation(); // Stop ALL other listeners
        e.stopPropagation();
        e.preventDefault();
        
        // EXACT copy of backdrop click behavior (lines 713-717)
        isClosingIntentionally = true;
        closeModal();
        setTimeout(() => {
          isClosingIntentionally = false;
        }, 100);
        
        return false;
      };
      
      // Add in capture phase FIRST - this executes BEFORE any other listeners
      closeBtn.addEventListener('click', forceCloseHandler, true);
      
      // Also add in bubbling phase as backup
      closeBtn.addEventListener('click', forceCloseHandler, false);
      
      // Also add mousedown as backup (fires before click)
      closeBtn.addEventListener('mousedown', forceCloseHandler, true);
      
      // Also set onclick attribute as additional fallback
      closeBtn.setAttribute('onclick', `
        console.log('ðŸ”´ðŸ”´ðŸ”´ [Modal] Static onclick inline executed');
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        const modal = document.getElementById('product-modal');
        if (modal && window.__modalCloseHandler) {
          window.__modalCloseHandler.setClosing(true);
          modal.close();
          document.body.style.overflow = '';
          setTimeout(() => {
            window.__modalCloseHandler.setClosing(false);
          }, 100);
        }
        return false;
      `);
    }

    // Handle clicks on dialog - close only if clicking on backdrop (dialog itself), not on content
    if (modal) {
      modal.addEventListener('click', (e) => {
        const modalContentEl = modal.querySelector('.modal-content');
        const closeBtnEl = modal.querySelector('#modal-close');
        
        // CRITICAL: Check for close button FIRST, before checking modal-content
        // The close button is inside modal-content, so we need to check it first
        if (closeBtnEl && (
          closeBtnEl === e.target || 
          closeBtnEl.contains(e.target) ||
          e.target.closest('#modal-close')
        )) {
          // If click is on close button, handle it exactly like backdrop click
          console.log('ðŸ”´ [Modal] Dialog click detected on close button, closing...');
          isClosingIntentionally = true;
          closeModal();
          setTimeout(() => {
            isClosingIntentionally = false;
          }, 100);
          return;
        }
        
        // If click is inside modal-content (but not on close button), prevent closing
        if (modalContentEl && (modalContentEl === e.target || modalContentEl.contains(e.target))) {
          e.stopPropagation();
          return;
        }
        
        // If click is directly on the dialog element (backdrop area), close
        if (e.target === modal) {
          isClosingIntentionally = true;
          closeModal();
          setTimeout(() => { isClosingIntentionally = false; }, 100);
        }
      }, false); // Use bubbling phase so close button handler fires first
    }

    // Intercept dialog close event and reopen if click was inside content
    if (modal) {
      modal.addEventListener('close', () => {
        // If we're closing intentionally (button, escape, backdrop), allow it
        if (isClosingIntentionally) {
          return;
        }
        
        const modalContentEl = modal.querySelector('.modal-content');
        
        // If the last click was inside modal-content, reopen the modal
        if (lastClickTarget && modalContentEl && modalContentEl.contains(lastClickTarget)) {
          // Reopen immediately
          setTimeout(() => {
            if (modal) {
              modal.showModal();
            }
          }, 0);
          return;
        }
        
        // If click was on close button, allow close (should be handled by isClosingIntentionally)
        if (lastClickTarget && lastClickTarget.closest('#modal-close')) {
          return;
        }
        
        // If click was on dialog backdrop, allow close (should be handled by isClosingIntentionally)
        if (lastClickTarget === modal) {
          return;
        }
        
        // Otherwise, reopen (click was probably inside content)
        setTimeout(() => {
          if (modal) {
            modal.showModal();
          }
        }, 0);
      });
      
      // Escape key - always allow close
      modal.addEventListener('cancel', (e) => {
        e.preventDefault();
        isClosingIntentionally = true;
        closeModal();
        setTimeout(() => { isClosingIntentionally = false; }, 100);
      });
    }

    // Prevent clicks inside modal content from propagating to dialog
    // BUT exclude the close button - use bubbling phase only
    // IMPORTANT: Only prevent if click is INSIDE the modal, not outside (like filter dropdown)
    const modalContentContainer = document.getElementById('modal-content-container');
    if (modalContentContainer) {
      const preventHandler = (e) => {
        // CRITICAL: Check if click is actually inside the modal
        // Don't interfere with clicks outside the modal (like filter dropdown)
        const modal = document.getElementById('product-modal');
        if (!modal || !modal.contains(e.target)) {
          return; // Click is outside modal, don't interfere
        }
        
        const closeBtnEl = modalContentContainer.querySelector('#modal-close');
        // CRITICAL: Check if click is on close button
        if (closeBtnEl && (
          closeBtnEl === e.target || 
          closeBtnEl.contains(e.target) ||
          e.target.closest('#modal-close')
        )) {
          return; // Don't prevent - let close button handle it
        }
        e.stopPropagation();
      };
      
      // Use bubbling phase (not capture) so close button handler executes first
      // AND so it doesn't interfere with clicks outside the modal
      modalContentContainer.addEventListener('click', preventHandler, false);
    }

    // Export functions for external use
    window.openProductModal = openModal;
    window.closeProductModal = closeModal;
    window.updateProductModal = updateModalContent;
    
    // Global function to force close modal (for onclick handlers)
    window.forceCloseProductModal = function() {
      console.log('ðŸ”´ðŸ”´ðŸ”´ [Modal] forceCloseProductModal called');
      const modal = document.getElementById('product-modal');
      console.log('ðŸ”´ Modal element:', modal);
      if (modal) {
        console.log('ðŸ”´ Closing modal...');
        modal.close();
        document.body.style.overflow = '';
      }
    };
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initModal);
  } else {
    initModal();
  }
  
  // Removed global listener - it was causing interference
  // The button's own listeners should handle it correctly
</script>

<style is:global>
  .product-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    max-width: none;
    max-height: none;
    margin: 0;
    padding: 0;
    border: none;
    background: transparent;
    z-index: 9999;
  }

  .product-modal::backdrop {
    background: rgba(48, 48, 48, 0.6);
  }

  /* Removed .modal-backdrop - using dialog::backdrop instead */

  .modal-content {
    position: relative;
    background: #ffffff;
    width: 1196px;
    max-width: 90vw;
    max-height: 90vh;
    margin: 5vh auto;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: row;
    z-index: 10;
    pointer-events: auto;
  }

  /* Left Column: Image Section */
  .modal-image-section {
    position: relative;
    width: 500px;
    min-width: 500px;
    max-width: 500px;
    background: linear-gradient(180deg, #e7e7e7 0%, #ffffff 100%);
    border-radius: 0 36px 0 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 48px 32px;
    overflow: hidden;
  }

  .modal-close-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 1000 !important; /* Higher than modal-content but lower than filter dropdown (1000) */
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    text-decoration: none;
    display: inline-block;
    pointer-events: auto !important;
  }
  
  .modal-close-btn * {
    pointer-events: none; /* Let clicks on children bubble to link */
  }

  .modal-close-circle {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(220, 220, 220, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #313639;
    transition: all 0.2s ease;
  }

  .modal-close-btn:hover .modal-close-circle {
    background: rgba(220, 220, 220, 0.8);
  }

  .modal-image-wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    max-width: 400px;
    max-height: 500px;
  }

  /* Right Column: Content Section */
  .modal-info-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
    max-height: 90vh;
  }

  .modal-scroll-content {
    padding: 48px;
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1 1 auto;
    min-height: 0;
    max-height: 90vh;
    display: flex !important;
    flex-direction: column !important;
    -webkit-overflow-scrolling: touch;
  }

  /* Header */
  .modal-header {
    margin-bottom: 0;
  }

  .modal-title {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 32px !important;
    font-weight: 700;
    line-height: 32px;
    letter-spacing: 0.64px;
    color: #009DDB !important;
    margin: 0 0 1rem 0;
  }

  /* CICLO/RM Toggle */
  .modal-ciclo-rm {
    margin-top: 0;
    margin-bottom: 1.5rem;
  }

  .ciclo-rm-container {
    display: flex;
    width: 346px;
    height: 56px;
    border-radius: 100px;
    border: 1px solid #009DDB;
    overflow: hidden;
    background: #ffffff;
  }

  .ciclo-rm-left {
    flex: 1;
    background: #009DDB;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
  }

  .ciclo-rm-label {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 20px;
    letter-spacing: 0.4px;
    color: #ffffff;
  }

  .ciclo-rm-right {
    flex: 1;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
  }

  .ciclo-rm-value {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 20px;
    letter-spacing: 0.4px;
    color: #009DDB !important;
  }

  /* Sections */
  .modal-section {
    margin-bottom: 0;
  }

  .modal-section-title {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 22px;
    letter-spacing: 0;
    color: #00527f;
    margin: 0 0 1rem 0;
  }

  .modal-description-text {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 16px;
    font-weight: 400;
    line-height: 20.8px;
    letter-spacing: 0;
    color: #313639;
    margin: 0;
  }

  /* Separator */
  .modal-separator {
    width: 100%;
    height: 1px;
    background: #e9e7e4;
    margin: 1.2rem 0;
  }

  /* Characteristics List */
  .modal-characteristics-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-bottom: 0;
  }

  .modal-characteristic-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 16px;
    margin-bottom: .9rem;
  }

  .modal-characteristic-item:last-child {
    margin-bottom: 1rem;
  }

  .characteristic-label {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 14px;
    font-weight: 700;
    line-height: 18.2px;
    letter-spacing: 0;
    color: #313639;
    min-width: 180px;
    flex-shrink: 0;
  }

  .characteristic-value {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 14px;
    font-weight: 400;
    line-height: 18.2px;
    letter-spacing: 0;
    color: #313639;
    flex: 1;
  }

  /* Features List with Progress Bars */
  .modal-features-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-top: 0;
  }

  .modal-feature-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 16px;
    margin-bottom: .9rem;
  }

  .modal-feature-item:last-child {
    margin-bottom: 0;
  }

  .feature-label {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 14px;
    font-weight: 700;
    line-height: 18.2px;
    letter-spacing: 0;
    color: #313639;
    min-width: 180px;
    flex-shrink: 0;
  }

  .feature-progress-container {
    display: flex;
    align-items: center;
    gap: 16px;
    flex: 1;
    min-width: 0;
  }

  .feature-progress-bar {
    position: relative;
    flex: 1;
    height: 19px;
    background: #d9d9d9;
    border-radius: 100px;
    overflow: hidden;
  }

  .feature-progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    /* Use gradient image - fallback to CSS gradient if image not available */
    background-image: url('/gradiente-barras.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    /* Fallback gradient if image not found */
    background-color: transparent;
    border-radius: 100px;
    min-width: 0;
  }

  /* Fallback gradient when image is not available */
  .feature-progress-fill:not([style*="background-image"]) {
    background: linear-gradient(90deg, #f2d400 0%, #a8d600 50%, #009ddb 100%);
  }

  .feature-value {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 10px;
    font-weight: 300;
    line-height: 10px;
    letter-spacing: 0;
    color: #000000;
    white-space: nowrap;
    min-width: 30px;
    text-align: right;
  }

  /* Recommendations Section */
  .modal-recommendations-section {
    background: rgba(233, 231, 228, 0.5);
    border-radius: 12px;
    padding: 24px 16px;
    margin-bottom: 0;
  }

  .modal-recommendations-title {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 20px;
    font-weight: 700;
    line-height: 26px;
    letter-spacing: 0;
    color: #00527f;
    margin: 0 0 16px 0;
  }

  .modal-recommendations-text {
    font-family: 'Bayer Sans', sans-serif;
    font-size: 16px;
    font-weight: 400;
    line-height: 20.8px;
    letter-spacing: 0;
    color: #313639;
    margin: 0;
  }

  /* PDF Button */
  .modal-pdf-button {
    width: 254px;
    height: 48px;
    border-radius: 26px;
    background: linear-gradient(90deg, #009ddb 30%, #005475 100%);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: opacity 0.2s ease;
    font-family: 'Bayer Sans', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    line-height: 48px;
    letter-spacing: 0;
    color: #ffffff;
    padding: 0;
    text-decoration: none;
  }

  .modal-pdf-button:hover {
    opacity: 0.9;
  }

  .modal-pdf-button:not([href]) {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .modal-pdf-button svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    flex-shrink: 0;
  }

  .modal-loading {
    padding: 48px;
    text-align: center;
    color: #313639;
  }

  /* Mobile Styles */
  @media (max-width: 767px) {
    .modal-content {
      width: 100%;
      max-width: 100%;
      max-height: 100vh;
      margin: 0;
      border-radius: 0;
      flex-direction: column;
    }

    .modal-image-section {
      width: 100%;
      min-width: 100%;
      max-width: 100%;
      border-radius: 0;
      padding: 32px 24px;
      min-height: 300px;
      max-height: 40vh;
    }

    .modal-info-section {
      max-height: 60vh;
    }

    .modal-scroll-content {
      padding: 24px;
      max-height: 60vh;
    }

    .modal-title {
      font-size: 24px;
      line-height: 28px;
    }

    .ciclo-rm-container {
      width: 100%;
      max-width: 346px;
    }

    .modal-close-btn {
      top: 16px;
      left: 16px;
    }

    .modal-close-circle {
      width: 40px;
      height: 40px;
    }
  }
</style>
