---
interface Solution {
  id: string;
  name: string;
  description: string;
  logo: string;
  icon?: string;
  link?: string;
}

interface Props {
  solutions: Solution[];
  lang?: "es" | "pt";
}

const { solutions = [], lang = "es" } = Astro.props;
---

<div class="solutions-carousel-wrapper">
  {
    solutions.length > 0 ? (
      <div
        class="solutions-carousel-container"
        id="solutions-carousel"
      >
        {solutions.length > 1 && (
          <button
            class="carousel-button carousel-button-prev"
            aria-label="Anterior"
            id="solutions-carousel-prev"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
        )}
        <div
          class="solutions-carousel-track"
          id="solutions-carousel-track"
        >
          {solutions.map((solution) => (
            <div
              class="solution-card"
              data-solution-id={solution.id}
            >
              {solution.icon && (
                <div class="solution-icon">
                  <img
                    src={solution.icon}
                    alt=""
                    aria-hidden="true"
                  />
                </div>
              )}
              {solution.logo && (
                <div class="solution-logo">
                  <img
                    src={solution.logo}
                    alt={solution.name}
                  />
                </div>
              )}
              {solution.description && (
                <p class="solution-description">{solution.description}</p>
              )}
            </div>
          ))}
        </div>
        {solutions.length > 1 && (
          <button
            class="carousel-button carousel-button-next"
            aria-label="Siguiente"
            id="solutions-carousel-next"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 18l6-6-6-6" />
            </svg>
          </button>
        )}
      </div>
    ) : null
  }
</div>

<script>
  let carouselTrack: HTMLElement | null = null;
  let scrollPosition = 0;

  function initSolutionsCarousel() {
    carouselTrack = document.getElementById(
      "solutions-carousel-track"
    ) as HTMLElement;
    if (!carouselTrack) return;

    const prevButton = document.getElementById(
      "solutions-carousel-prev"
    ) as HTMLButtonElement | null;
    const nextButton = document.getElementById(
      "solutions-carousel-next"
    ) as HTMLButtonElement | null;

    if (prevButton) {
      prevButton.addEventListener("click", () => {
        scrollCarousel("prev");
      });
    }

    if (nextButton) {
      nextButton.addEventListener("click", () => {
        scrollCarousel("next");
      });
    }

    // Listen to scroll events to update button states
    carouselTrack.addEventListener("scroll", handleScroll);

    // Initial state
    updateControlsVisibility();
  }

  function scrollCarousel(direction: "prev" | "next") {
    if (!carouselTrack) return;

    const cardWidth =
      carouselTrack.querySelector(".solution-card")?.getBoundingClientRect()
        .width || 0;
    const gap = 24; // 1.5rem = 24px
    const scrollAmount = cardWidth + gap;

    scrollPosition += direction === "next" ? scrollAmount : -scrollAmount;

    // Clamp scroll position
    const maxScroll = carouselTrack.scrollWidth - carouselTrack.clientWidth;
    scrollPosition = Math.max(0, Math.min(scrollPosition, maxScroll));

    carouselTrack.scrollTo({
      left: scrollPosition,
      behavior: "smooth",
    });
  }

  function updateControlsVisibility() {
    if (!carouselTrack) return;

    const prevButton = document.getElementById(
      "solutions-carousel-prev"
    ) as HTMLButtonElement | null;
    const nextButton = document.getElementById(
      "solutions-carousel-next"
    ) as HTMLButtonElement | null;

    // Update button states based on scroll position
    if (prevButton) {
      prevButton.disabled = scrollPosition <= 0;
    }

    if (nextButton) {
      const maxScroll = carouselTrack.scrollWidth - carouselTrack.clientWidth;
      nextButton.disabled = scrollPosition >= maxScroll - 1; // -1 for rounding errors
    }
  }

  function handleScroll() {
    if (!carouselTrack) return;
    scrollPosition = carouselTrack.scrollLeft;
    updateControlsVisibility();
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSolutionsCarousel);
  } else {
    initSolutionsCarousel();
  }

  // Update controls visibility on resize
  window.addEventListener("resize", updateControlsVisibility);
</script>

<style>
  .solutions-carousel-wrapper {
    width: 100%;
    margin-top: var(--spacing-8);
    position: relative;
  }

  .solutions-carousel-container {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
  }

  .solutions-carousel-track {
    display: flex;
    gap: var(--spacing-6);
    overflow-x: auto;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    padding: var(--spacing-2) 0;
    flex: 1;
    width: 100%;
  }

  .solutions-carousel-track::-webkit-scrollbar {
    height: 8px;
  }

  .solutions-carousel-track::-webkit-scrollbar-track {
    background: var(--color-gray-100);
    border-radius: var(--radius-md);
  }

  .solutions-carousel-track::-webkit-scrollbar-thumb {
    background: var(--color-gray-400);
    border-radius: var(--radius-md);
  }

  .solutions-carousel-track::-webkit-scrollbar-thumb:hover {
    background: var(--color-bayer-secondary);
  }

  .solution-card {
    background: var(--gradient-card-solutions);
    padding: var(--spacing-6);
    border-radius: var(--card-border-radius);
    box-shadow: var(--shadow-md);
    text-align: center;
    transition: all var(--transition-base);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-4);
    flex: 0 0 auto;
    width: calc(100% - var(--spacing-6));
    max-width: 344px;
    scroll-snap-align: start;
  }

  .solution-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .solution-icon {
    width: 104px;
    height: 104px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    flex-shrink: 0;
  }

  .solution-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .solution-logo {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: var(--spacing-2) 0;
  }

  .solution-logo img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }

  .solution-description {
    font-size: var(--font-size-base-sm);
    color: var(--color-text-primary);
    margin: 0;
    line-height: var(--line-height-relaxed);
    text-align: center;
  }

  .carousel-button {
    background: var(--color-white);
    color: var(--color-bayer-secondary);
    border: 2px solid var(--color-bayer-secondary);
    border-radius: var(--radius-full);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-md);
    flex-shrink: 0;
  }

  .carousel-button svg {
    width: 20px;
    height: 20px;
    stroke: var(--color-bayer-secondary);
  }

  .carousel-button:hover {
    background: var(--color-bayer-secondary);
    color: var(--color-white);
    transform: scale(1.05);
  }

  .carousel-button:hover svg {
    stroke: var(--color-white);
  }

  .carousel-button:active {
    transform: scale(0.95);
  }

  .carousel-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  @media (max-width: 767px) {
    .carousel-button {
      display: none;
    }

    .solution-card {
      width: calc(100vw - var(--spacing-8));
      max-width: 344px;
    }
  }

  /* Tablet: 2 columns visible */
  @media (min-width: 768px) and (max-width: 1023px) {
    .solution-card {
      width: calc((100% - var(--spacing-6)) / 2);
      max-width: 344px;
    }
  }

  /* Desktop: 4 columns visible with scroll */
  @media (min-width: 1024px) {
    .solutions-carousel-wrapper {
      max-width: 1600px;
      margin-left: auto;
      margin-right: auto;
      padding: 0 var(--spacing-8);
    }

    .solutions-carousel-container {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--spacing-4);
    }

    .carousel-button {
      display: flex;
      flex-shrink: 0;
    }

    .solutions-carousel-track {
      flex: 1;
      width: auto;
    }

    .solution-card {
      width: calc((100% - (3 * var(--spacing-6))) / 4);
      max-width: 344px;
      min-width: 280px;
    }
  }

  @media (min-width: 1440px) {
    .solutions-carousel-wrapper {
      padding: 0 var(--spacing-12);
    }
  }
</style>
