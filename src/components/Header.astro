---
import { getLocalizedPath } from "../utils/i18n";
import type { Idioma } from "../types";

interface Props {
  lang?: Idioma;
}

const { lang = "es" } = Astro.props;

// Translations
const translations = {
  es: {
    semillas: "Semillas",
    preceon: "Preceon",
    soluciones: "Soluciones",
    calculadora: "Calculadora de densidad",
    recursos: "Recursos",
    solucionesItems: {
      maiz: "Maíz",
      colza: "Colza",
      fieldview: "Fieldview",
      proteccion: "Protección de cultivo",
    },
    maizItems: {
      acceleron: "Acceleron",
      fieldshield: "Fieldshield",
      siloextra: "Siloextra",
      preceon: "Preceon",
    },
    recursosItems: {
      noticias: "Noticias",
      dekalbInforma: "DEKALB informa",
      catalogos: "Descarga Catálogos",
    },
  },
  pt: {
    semillas: "Sementes",
    preceon: "Preceon",
    soluciones: "Soluções",
    calculadora: "Calculadora de densidades",
    recursos: "Recursos",
    solucionesItems: {
      maiz: "Milho",
      colza: "Colza",
      fieldview: "Fieldview",
      proteccion: "Proteção de cultivo",
    },
    maizItems: {
      acceleron: "Acceleron",
      fieldshield: "Fieldshield",
      siloextra: "Siloextra",
      preceon: "Preceon",
    },
    recursosItems: {
      noticias: "Notícias",
      dekalbInforma: "DEKALB informa",
      catalogos: "Download de Catálogos",
    },
  },
};

const t = translations[lang] || translations.es;

// Navigation items structure
const navItems = [
  {
    label: t.semillas,
    path: "/#productos",
    type: "link",
  },
  // {
  //   label: t.preceon,
  //   path: "/preceon",
  //   type: "link",
  // },
  {
    label: t.soluciones,
    type: "dropdown",
    id: "soluciones-dropdown",
    items: [
      {
        label: t.solucionesItems.maiz,
        type: "dropdown",
        id: "maiz-dropdown",
        items: [
          { label: t.maizItems.acceleron, path: "/acceleron" },
          { label: t.maizItems.fieldshield, path: "/fieldshield" },
          { label: t.maizItems.siloextra, path: "/siloextra" },
          { label: t.maizItems.preceon, path: "/preceon" },
        ],
      },
      { label: t.solucionesItems.colza, path: "/colza" },
      { label: t.solucionesItems.fieldview, path: "/fieldview" },
      { label: t.solucionesItems.proteccion, path: "/proteccion-cultivo" },
    ],
  },
  {
    label: t.calculadora,
    path: "/calculadora",
    type: "link",
  },
  {
    label: t.recursos,
    type: "dropdown",
    id: "recursos-dropdown",
    items: [
      { label: t.recursosItems.noticias, path: "/blog" },
      { label: t.recursosItems.dekalbInforma, path: "/blog" },
      { label: t.recursosItems.catalogos, path: "/catalogo" },
    ],
  },
];

const currentPath = Astro.url.pathname;
const otherLang = lang === "es" ? "pt" : "es";
const otherLangPath = currentPath
  .replace(`/${lang}`, `/${otherLang}`)
  .replace(/^\/$/, `/${otherLang}`);

// Helper function to check if path is active
function isPathActive(path: string, currentPath: string): boolean {
  if (path === "/") {
    return (
      currentPath === "/" ||
      currentPath === `/${lang}` ||
      currentPath === `/${otherLang}`
    );
  }
  if (path.startsWith("/#")) {
    return false; // Hash links are not active by pathname
  }
  return currentPath === path || currentPath.startsWith(path);
}

// Helper function to check if any nested item is active
function hasActiveNestedItem(
  items: any[],
  currentPath: string,
  lang: Idioma
): boolean {
  return items.some((item) => {
    if (item.type === "dropdown") {
      return hasActiveNestedItem(item.items, currentPath, lang);
    }
    if (item.path) {
      const subPath = getLocalizedPath(item.path, lang);
      return isPathActive(subPath, currentPath);
    }
    return false;
  });
}
---

<header
  class="header"
  role="banner"
>
  <div class="container header-container">
    <!-- Left: Both logos -->
    <div class="header-left">
      <a
        href="https://www.bayer.com"
        class="logo-link"
        aria-label="Bayer"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img
          src="/logo-bayer.svg"
          alt="Bayer"
          class="logo-bayer"
          width="80"
          height="40"
        />
      </a>
      <a
        href={getLocalizedPath("/", lang)}
        class="logo-link"
        aria-label="DEKALB Experience - Inicio"
      >
        <img
          src="/logo-dekalb.svg"
          alt="DEKALB"
          class="logo-dekalb"
          width="120"
          height="40"
        />
      </a>
    </div>

    <!-- Right: Navigation -->
    <nav
      class="header-nav-right"
      aria-label="Navegación principal"
    >
      <button
        class="mobile-menu-toggle"
        aria-label="Abrir menú"
        aria-expanded="false"
        id="mobile-menu-toggle"
      >
        <span class="hamburger"></span>
        <span class="hamburger"></span>
        <span class="hamburger"></span>
      </button>

      <ul
        class="nav-list"
        id="nav-list"
      >
        {
          navItems.map((item) => {
            if (item.type === "link") {
              const itemPath = getLocalizedPath(item.path, lang);
              const isActive = isPathActive(itemPath, currentPath);
              return (
                <li>
                  <a
                    href={itemPath}
                    class:list={["nav-link", { "nav-link-active": isActive }]}
                  >
                    {item.label}
                  </a>
                </li>
              );
            } else if (item.type === "dropdown") {
              const hasActiveChild = hasActiveNestedItem(
                item.items,
                currentPath,
                lang
              );
              return (
                <li class="nav-item-dropdown">
                  <button
                    class:list={[
                      "nav-link",
                      "nav-link-dropdown",
                      { "nav-link-active": hasActiveChild },
                    ]}
                    aria-expanded="false"
                    aria-haspopup="true"
                    data-dropdown={item.id}
                  >
                    {item.label}
                    <svg
                      class="dropdown-arrow"
                      width="13"
                      height="13"
                      viewBox="0 0 13 13"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M3.5 5L6.5 8L9.5 5"
                        stroke="currentColor"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                  <ul
                    class="dropdown-menu"
                    data-dropdown-menu={item.id}
                  >
                    {item.items.map((subItem) => {
                      if (subItem.type === "dropdown") {
                        const hasActiveNested = hasActiveNestedItem(
                          subItem.items,
                          currentPath,
                          lang
                        );
                        return (
                          <li class="dropdown-item-nested">
                            <button
                              class:list={[
                                "dropdown-item",
                                "dropdown-item-nested-trigger",
                                { "dropdown-item-active": hasActiveNested },
                              ]}
                              aria-expanded="false"
                              aria-haspopup="true"
                              data-dropdown={subItem.id}
                            >
                              {subItem.label}
                              <svg
                                class="dropdown-arrow dropdown-arrow-nested"
                                width="13"
                                height="13"
                                viewBox="0 0 13 13"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path
                                  d="M3.5 5L6.5 8L9.5 5"
                                  stroke="currentColor"
                                  stroke-width="1.5"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                />
                              </svg>
                            </button>
                            <ul
                              class="dropdown-menu dropdown-menu-nested"
                              data-dropdown-menu={subItem.id}
                            >
                              {subItem.items.map((nestedItem) => {
                                const nestedPath = getLocalizedPath(
                                  nestedItem.path,
                                  lang
                                );
                                const isActive = isPathActive(
                                  nestedPath,
                                  currentPath
                                );
                                return (
                                  <li>
                                    <a
                                      href={nestedPath}
                                      class:list={[
                                        "dropdown-item",
                                        { "dropdown-item-active": isActive },
                                      ]}
                                    >
                                      {nestedItem.label}
                                    </a>
                                  </li>
                                );
                              })}
                            </ul>
                          </li>
                        );
                      } else {
                        const subPath = getLocalizedPath(subItem.path, lang);
                        const isActive = isPathActive(subPath, currentPath);
                        return (
                          <li>
                            <a
                              href={subPath}
                              class:list={[
                                "dropdown-item",
                                { "dropdown-item-active": isActive },
                              ]}
                            >
                              {subItem.label}
                            </a>
                          </li>
                        );
                      }
                    })}
                  </ul>
                </li>
              );
            }
          })
        }

        <!-- Language selector -->
        <li class="nav-item-lang">
          <a
            href={otherLangPath}
            class="lang-link"
            aria-label={lang === "es"
              ? "Cambiar a Portugués"
              : "Cambiar a Español"}
          >
            {lang === "es" ? "ES" : "PT"} | {lang === "es" ? "PT" : "ES"}
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<script>
  // Mobile menu toggle
  const menuToggle = document.getElementById("mobile-menu-toggle");
  const navList = document.getElementById("nav-list");

  if (menuToggle && navList) {
    menuToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = menuToggle.getAttribute("aria-expanded") === "true";
      menuToggle.setAttribute("aria-expanded", String(!isExpanded));
      navList.classList.toggle("nav-list-open");
      menuToggle.classList.toggle("mobile-menu-toggle-open");
    });

    // Close menu when clicking outside
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      if (!menuToggle.contains(target) && !navList.contains(target)) {
        menuToggle.setAttribute("aria-expanded", "false");
        navList.classList.remove("nav-list-open");
        menuToggle.classList.remove("mobile-menu-toggle-open");
      }
    });

    // Close menu on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && navList.classList.contains("nav-list-open")) {
        menuToggle.setAttribute("aria-expanded", "false");
        navList.classList.remove("nav-list-open");
        menuToggle.classList.remove("mobile-menu-toggle-open");
      }
    });
  }

  // Desktop dropdowns functionality
  function initDropdowns() {
    const dropdownTriggers = document.querySelectorAll("[data-dropdown]");
    const dropdownMenus = document.querySelectorAll("[data-dropdown-menu]");

    dropdownTriggers.forEach((trigger) => {
      const dropdownId = trigger.getAttribute("data-dropdown");
      const menu = document.querySelector(
        `[data-dropdown-menu="${dropdownId}"]`
      ) as HTMLElement;

      if (!menu) return;

      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        const isExpanded = trigger.getAttribute("aria-expanded") === "true";
        const isNested = trigger.closest(".dropdown-menu") !== null;

        // Close all other dropdowns at the same level
        dropdownTriggers.forEach((otherTrigger) => {
          const otherIsNested = otherTrigger.closest(".dropdown-menu") !== null;
          if (otherTrigger !== trigger && otherIsNested === isNested) {
            // Only close siblings, not parent/child dropdowns
            const otherParent = otherTrigger.closest(
              ".nav-item-dropdown, .dropdown-item-nested"
            );
            const currentParent = trigger.closest(
              ".nav-item-dropdown, .dropdown-item-nested"
            );
            if (otherParent === currentParent) {
              otherTrigger.setAttribute("aria-expanded", "false");
              const otherId = otherTrigger.getAttribute("data-dropdown");
              const otherMenu = document.querySelector(
                `[data-dropdown-menu="${otherId}"]`
              ) as HTMLElement;
              if (otherMenu) {
                otherMenu.classList.remove("dropdown-menu-open");
              }
            }
          }
        });

        // Toggle current dropdown
        trigger.setAttribute("aria-expanded", String(!isExpanded));
        if (!isExpanded) {
          menu.classList.add("dropdown-menu-open");
        } else {
          menu.classList.remove("dropdown-menu-open");
        }
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener("click", (e) => {
      const target = e.target as Node;
      let clickedInsideDropdown = false;

      dropdownTriggers.forEach((trigger) => {
        if (trigger.contains(target)) {
          clickedInsideDropdown = true;
        }
      });

      dropdownMenus.forEach((menu) => {
        if (menu.contains(target)) {
          clickedInsideDropdown = true;
        }
      });

      if (!clickedInsideDropdown) {
        dropdownTriggers.forEach((trigger) => {
          trigger.setAttribute("aria-expanded", "false");
          const dropdownId = trigger.getAttribute("data-dropdown");
          const menu = document.querySelector(
            `[data-dropdown-menu="${dropdownId}"]`
          ) as HTMLElement;
          if (menu) {
            menu.classList.remove("dropdown-menu-open");
          }
        });
      }
    });

    // Close dropdowns on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        dropdownTriggers.forEach((trigger) => {
          trigger.setAttribute("aria-expanded", "false");
          const dropdownId = trigger.getAttribute("data-dropdown");
          const menu = document.querySelector(
            `[data-dropdown-menu="${dropdownId}"]`
          ) as HTMLElement;
          if (menu) {
            menu.classList.remove("dropdown-menu-open");
          }
        });
      }
    });
  }

  // Initialize dropdowns when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDropdowns);
  } else {
    initDropdowns();
  }
</script>

<style>
  .header {
    background-color: var(--color-white);
    position: sticky;
    top: 0;
    z-index: var(--z-index-sticky);
    height: var(--header-height);
    border-bottom: 1px solid var(--color-gray-light);
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 100%;
    gap: var(--spacing-4);
  }

  /* Left: Both logos */
  .header-left {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
  }

  .logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
  }

  .logo-dekalb {
    height: 40px;
    width: auto;
  }

  @media (max-width: 767px) {
    .logo-dekalb {
      width: var(--logo-width-mobile);
      height: auto;
    }
  }

  @media (min-width: 768px) {
    .logo-dekalb {
      width: var(--logo-width-desktop);
      height: auto;
    }
  }

  .logo-bayer {
    height: 40px;
    width: auto;
  }

  /* Right: Navigation */
  .header-nav-right {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    flex: 1;
  }

  .mobile-menu-toggle {
    display: none;
    flex-direction: column;
    gap: 4px;
    background: none;
    border: none;
    padding: var(--spacing-2);
    cursor: pointer;
  }

  .hamburger {
    width: 24px;
    height: 2px;
    background-color: var(--color-gray-900);
    transition: all var(--transition-base);
  }

  .mobile-menu-toggle-open .hamburger:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }

  .mobile-menu-toggle-open .hamburger:nth-child(2) {
    opacity: 0;
  }

  .mobile-menu-toggle-open .hamburger:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }

  .nav-list {
    display: flex;
    align-items: center;
    gap: var(--spacing-6);
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-link {
    color: var(--color-text-primary);
    text-decoration: none;
    font-weight: 700;
    font-size: 13px;
    font-family: var(--font-family-primary);
    padding: var(--spacing-2) var(--spacing-3);
    position: relative;
    transition: color var(--transition-fast);
    border-radius: 10px;
    line-height: 13px;
    display: flex;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    cursor: pointer;
  }

  .nav-link:hover {
    color: var(--color-bayer-secondary);
  }

  .nav-link-active {
    color: var(--color-bayer-secondary);
  }

  .nav-link-active::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--color-bayer-secondary);
  }

  /* Dropdown styles */
  .nav-item-dropdown {
    position: relative;
  }

  .nav-link-dropdown {
    padding-right: var(--spacing-2);
  }

  .dropdown-arrow {
    width: 13px;
    height: 13px;
    transition: transform var(--transition-base);
    flex-shrink: 0;
  }

  .nav-link-dropdown[aria-expanded="true"] .dropdown-arrow {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background-color: var(--color-white);
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    padding: var(--spacing-2);
    min-width: 200px;
    list-style: none;
    margin: 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-base);
    z-index: 1000;
  }

  .dropdown-menu-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item {
    display: block;
    padding: var(--spacing-2) var(--spacing-3);
    color: var(--color-text-primary);
    text-decoration: none;
    font-weight: 700;
    font-size: 13px;
    font-family: var(--font-family-primary);
    line-height: 13px;
    border-radius: 10px;
    transition: background-color var(--transition-fast);
  }

  .dropdown-item:hover {
    background-color: var(--color-gray-50);
  }

  .dropdown-item-active {
    color: var(--color-bayer-secondary);
    background-color: var(--color-gray-50);
  }

  /* Nested dropdown styles */
  .dropdown-item-nested {
    position: relative;
  }

  .dropdown-item-nested-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    text-align: left;
  }

  .dropdown-arrow-nested {
    margin-left: auto;
    margin-right: 0;
  }

  .dropdown-item-nested-trigger[aria-expanded="true"] .dropdown-arrow-nested {
    transform: rotate(180deg);
  }

  .dropdown-menu-nested {
    position: absolute;
    top: 0;
    left: calc(100% + 8px);
    min-width: 200px;
    z-index: 1001;
  }

  /* Adjust nested dropdown position on right edge */
  .dropdown-item-nested:last-child .dropdown-menu-nested,
  .dropdown-item-nested:nth-last-child(2) .dropdown-menu-nested {
    left: auto;
    right: calc(100% + 8px);
  }

  /* Language selector */
  .nav-item-lang {
    margin-left: var(--spacing-2);
  }

  .lang-link {
    color: var(--color-text-primary);
    text-decoration: none;
    font-weight: 700;
    font-size: 13px;
    font-family: var(--font-family-primary);
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: 10px;
    transition: all var(--transition-fast);
    display: inline-block;
  }

  .lang-link:hover {
    color: var(--color-bayer-secondary);
  }

  /* Mobile styles */
  @media (max-width: 767px) {
    .header-left {
      gap: var(--spacing-2);
    }

    .logo-bayer {
      max-height: 30px;
    }

    .mobile-menu-toggle {
      display: flex;
    }

    .nav-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      flex-direction: column;
      background-color: var(--color-white);
      box-shadow: var(--shadow-lg);
      padding: 0;
      gap: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-base);
      align-items: stretch;
    }

    .nav-list-open {
      max-height: 800px;
      padding: var(--spacing-4);
    }

    .nav-list li {
      width: 100%;
    }

    .nav-link {
      display: block;
      padding: var(--spacing-3) 0;
      width: 100%;
      justify-content: space-between;
    }

    .nav-link-dropdown {
      justify-content: flex-start;
      text-align: left;
    }

    .nav-item-dropdown {
      width: 100%;
    }

    .dropdown-menu {
      position: static;
      opacity: 1;
      visibility: visible;
      transform: none;
      box-shadow: none;
      padding: var(--spacing-2) 0 var(--spacing-2) var(--spacing-4);
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-base);
    }

    .dropdown-menu-open {
      max-height: 300px;
    }

    /* Nested dropdown styles for mobile */
    .dropdown-item-nested {
      width: 100%;
    }

    .dropdown-item-nested-trigger {
      width: 100%;
      justify-content: space-between;
    }

    .dropdown-menu-nested {
      position: static;
      opacity: 1;
      visibility: visible;
      transform: none;
      box-shadow: none;
      padding: var(--spacing-2) 0 var(--spacing-2) var(--spacing-4);
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-base);
      left: auto;
      right: auto;
    }

    .dropdown-menu-nested.dropdown-menu-open {
      max-height: 300px;
    }

    .nav-item-lang {
      margin-left: 0;
      margin-top: var(--spacing-2);
      padding-top: var(--spacing-2);
      border-top: 1px solid var(--color-gray-light);
    }
  }
</style>
