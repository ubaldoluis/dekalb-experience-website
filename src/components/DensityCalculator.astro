---
interface Props {
  lang?: "es" | "pt";
}

const { lang = "es" } = Astro.props;

const translations = {
  es: {
    title: "Calculador de Densidades",
    use: "Uso del ma칤z",
    grano: "Grano",
    silo: "Silo",
    zone: "Zona geogr치fica",
    potential: "Potencial de Producci칩n en la finca (Tn/Ha)",
    hybrid: "H칤brido DEKALB",
    surface: "Superficie a sembrar",
    calculate: "CALCULAR",
    result: {
      density: "Densidad Recomendada",
      bags: "N췈 de bolsas DEKALB",
      plantsPerHa: "miles plantas/Ha",
    },
    selectZone: "Seleccionar zona",
    selectPotential: "Seleccionar potencial",
    selectHybrid: "Seleccionar h칤brido",
    missingFields: "Por favor, completa todos los campos",
    missingDensity:
      "No hay una recomendaci칩n disponible para esta combinaci칩n. Revisa los datos o actualiza la tabla.",
  },
  pt: {
    title: "Calculadora de Densidades",
    use: "Uso do milho",
    grano: "Gr칚o",
    silo: "Silagem",
    zone: "Zona geogr치fica",
    potential: "Potencial de Produ칞칚o na quinta (Tn/Ha)",
    hybrid: "H칤brido DEKALB",
    surface: "Superf칤cie a semear",
    calculate: "CALCULAR",
    result: {
      density: "Densidade Recomendada",
      bags: "N췈 de sacos DEKALB",
      plantsPerHa: "mil plantas/Ha",
    },
    selectZone: "Selecionar zona",
    selectPotential: "Selecionar potencial",
    selectHybrid: "Selecionar h칤brido",
    missingFields: "Por favor, preenche todos os campos",
    missingDensity:
      "N칚o existe recomenda칞칚o para esta combina칞칚o. Rev칡 os dados ou atualiza a tabela.",
  },
};

const t = translations[lang];
---

<div
  class="density-calculator"
  id="density-calculator"
>
  <h2 class="calculator-title">{t.title}</h2>

  <form
    class="calculator-form"
    id="calculator-form"
  >
    <!-- Uso del ma칤z -->
    <div class="form-group">
      <label class="form-label">{t.use}</label>
      <div class="button-group">
        <button
          type="button"
          class="use-button"
          data-use="grano"
          aria-pressed="false"
        >
          {t.grano}
        </button>
        <button
          type="button"
          class="use-button"
          data-use="silo"
          aria-pressed="false"
        >
          {t.silo}
        </button>
      </div>
    </div>

    <!-- Zona geogr치fica -->
    <div class="form-group">
      <label
        for="zone-select"
        class="form-label"
        >{t.zone}</label
      >
      <select
        id="zone-select"
        class="form-select"
        required
      >
        <option value="">{t.selectZone}</option>
      </select>
    </div>

    <!-- Potencial de producci칩n -->
    <div class="form-group">
      <label
        for="potential-select"
        class="form-label"
      >
        {t.potential}
      </label>
      <select
        id="potential-select"
        class="form-select"
        required
      >
        <option value="">{t.selectPotential}</option>
      </select>
    </div>

    <!-- H칤brido DEKALB -->
    <div class="form-group">
      <label
        for="hybrid-select"
        class="form-label"
        >{t.hybrid}</label
      >
      <select
        id="hybrid-select"
        class="form-select"
        required
      >
        <option value="">{t.selectHybrid}</option>
      </select>
    </div>

    <!-- Superficie a sembrar -->
    <div class="form-group">
      <label
        for="surface-input"
        class="form-label"
        >{t.surface}</label
      >
      <input
        type="number"
        id="surface-input"
        class="form-input"
        min="0.1"
        step="0.1"
        placeholder="0.0"
        required
      />
      <span class="input-unit">Ha</span>
    </div>

    <button
      type="submit"
      class="btn btn-primary calculate-button"
    >
      {t.calculate}
    </button>
  </form>

  <!-- Results -->
  <div
    class="calculator-results"
    id="calculator-results"
    style="display: none;"
  >
    <div class="result-card">
      <div class="result-icon">游</div>
      <div class="result-content">
        <h3>{t.result.density}</h3>
        <p
          class="result-value"
          id="result-density"
        >
          -
        </p>
        <span class="result-unit">{t.result.plantsPerHa}</span>
      </div>
    </div>
    <div class="result-card">
      <div class="result-icon">游닍</div>
      <div class="result-content">
        <h3>{t.result.bags}</h3>
        <p
          class="result-value"
          id="result-bags"
        >
          -
        </p>
      </div>
    </div>
    <div class="result-image">
      <img
        src="/calculator-result.jpg"
        alt="Resultado"
        id="result-image"
      />
    </div>
  </div>
</div>

<script>
  type UseType = "grano" | "silo";

  type DensityEntry = {
    use: UseType;
    zone: string;
    potential: string;
    hybrid: string;
    densityK: number;
  };

  type DensityDatasetV1 = {
    schemaVersion: 1;
    seedsPerBag: number;
    zones: Record<UseType, string[]>;
    potentials: Record<UseType, string[]>;
    entries: DensityEntry[];
  };

  const densityDataUrl = "/density-calculator.v1.json";
  const form = document.getElementById(
    "calculator-form"
  ) as HTMLFormElement | null;
  const useButtons = Array.from(
    document.querySelectorAll(".use-button")
  ) as HTMLButtonElement[];
  const zoneSelect = document.getElementById(
    "zone-select"
  ) as HTMLSelectElement | null;
  const potentialSelect = document.getElementById(
    "potential-select"
  ) as HTMLSelectElement | null;
  const hybridSelect = document.getElementById(
    "hybrid-select"
  ) as HTMLSelectElement | null;
  const surfaceInput = document.getElementById(
    "surface-input"
  ) as HTMLInputElement | null;
  const resultsDiv = document.getElementById(
    "calculator-results"
  ) as HTMLDivElement | null;
  const resultDensity = document.getElementById(
    "result-density"
  ) as HTMLElement | null;
  const resultBags = document.getElementById(
    "result-bags"
  ) as HTMLElement | null;

  const lang = document.documentElement.lang === "pt" ? "pt" : "es";
  const i18n = {
    es: {
      selectZone: "Seleccionar zona",
      selectPotential: "Seleccionar potencial",
      selectHybrid: "Seleccionar h칤brido",
      missingFields: "Por favor, completa todos los campos",
      missingDensity:
        "No hay una recomendaci칩n disponible para esta combinaci칩n. Revisa los datos o actualiza la tabla.",
    },
    pt: {
      selectZone: "Selecionar zona",
      selectPotential: "Selecionar potencial",
      selectHybrid: "Selecionar h칤brido",
      missingFields: "Por favor, preenche todos os campos",
      missingDensity:
        "N칚o existe recomenda칞칚o para esta combina칞칚o. Rev칡 os dados ou atualiza a tabela.",
    },
  } as const;

  let selectedUse: UseType | null = null;
  let dataset: DensityDatasetV1 | null = null;

  function clearSelect(select: HTMLSelectElement) {
    while (select.firstChild) select.removeChild(select.firstChild);
  }

  function setDefaultOption(select: HTMLSelectElement, label: string) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = label;
    select.appendChild(opt);
  }

  async function loadDataset(): Promise<DensityDatasetV1> {
    if (dataset) return dataset;
    const res = await fetch(densityDataUrl, { credentials: "omit" });
    if (!res.ok) {
      throw new Error(`Failed to load density dataset: ${res.status}`);
    }
    const json = (await res.json()) as DensityDatasetV1;
    dataset = json;
    return json;
  }

  function getAvailableZones(data: DensityDatasetV1, use: UseType): string[] {
    return Array.isArray(data.zones?.[use]) ? data.zones[use] : [];
  }

  function getAvailablePotentials(
    data: DensityDatasetV1,
    use: UseType
  ): string[] {
    return Array.isArray(data.potentials?.[use]) ? data.potentials[use] : [];
  }

  function getAvailableHybrids(
    data: DensityDatasetV1,
    params: { use: UseType; zone: string; potential: string }
  ): string[] {
    const hybrids = data.entries
      .filter(
        (e) =>
          e.use === params.use &&
          e.zone === params.zone &&
          e.potential === params.potential
      )
      .map((e) => e.hybrid);
    return Array.from(new Set(hybrids)).sort((a, b) => a.localeCompare(b));
  }

  function findDensityK(
    data: DensityDatasetV1,
    params: { use: UseType; zone: string; potential: string; hybrid: string }
  ): number | null {
    const entry = data.entries.find(
      (e) =>
        e.use === params.use &&
        e.zone === params.zone &&
        e.potential === params.potential &&
        e.hybrid === params.hybrid
    );
    return typeof entry?.densityK === "number" ? entry.densityK : null;
  }

  function calculateBags(params: {
    densityK: number;
    surfaceHa: number;
    seedsPerBag: number;
  }) {
    // densityK est치 en miles de plantas/Ha. seedsPerBag por defecto 50.000.
    // bolsas = ceil( (densityK * 1000 * ha) / seedsPerBag ) === ceil( (densityK/50) * ha ) si seedsPerBag=50.000
    const totalSeeds = params.densityK * 1000 * params.surfaceHa;
    return Math.ceil(totalSeeds / params.seedsPerBag);
  }

  function resetResults() {
    if (resultsDiv) resultsDiv.style.display = "none";
    if (resultDensity) resultDensity.textContent = "-";
    if (resultBags) resultBags.textContent = "-";
  }

  function resetDependentSelects() {
    if (!zoneSelect || !potentialSelect || !hybridSelect) return;
    clearSelect(zoneSelect);
    setDefaultOption(zoneSelect, i18n[lang].selectZone);
    clearSelect(potentialSelect);
    setDefaultOption(potentialSelect, i18n[lang].selectPotential);
    clearSelect(hybridSelect);
    setDefaultOption(hybridSelect, i18n[lang].selectHybrid);
  }

  async function hydrateOptionsForUse(use: UseType) {
    if (!zoneSelect || !potentialSelect || !hybridSelect) return;
    const data = await loadDataset();

    // Zones
    clearSelect(zoneSelect);
    setDefaultOption(zoneSelect, i18n[lang].selectZone);
    getAvailableZones(data, use).forEach((zone) => {
      const opt = document.createElement("option");
      opt.value = zone;
      opt.textContent = zone;
      zoneSelect.appendChild(opt);
    });

    // Potentials
    clearSelect(potentialSelect);
    setDefaultOption(potentialSelect, i18n[lang].selectPotential);
    getAvailablePotentials(data, use).forEach((pot) => {
      const opt = document.createElement("option");
      opt.value = pot;
      opt.textContent = pot;
      potentialSelect.appendChild(opt);
    });

    // Hybrids
    clearSelect(hybridSelect);
    setDefaultOption(hybridSelect, i18n[lang].selectHybrid);
  }

  async function hydrateHybrids() {
    if (!selectedUse || !zoneSelect || !potentialSelect || !hybridSelect)
      return;
    resetResults();
    const zone = zoneSelect.value;
    const potential = potentialSelect.value;
    clearSelect(hybridSelect);
    setDefaultOption(hybridSelect, i18n[lang].selectHybrid);
    if (!zone || !potential) return;

    const data = await loadDataset();
    const hybrids = getAvailableHybrids(data, {
      use: selectedUse,
      zone,
      potential,
    });
    hybrids.forEach((hybrid) => {
      const opt = document.createElement("option");
      opt.value = hybrid;
      opt.textContent = hybrid;
      hybridSelect.appendChild(opt);
    });
  }

  useButtons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      useButtons.forEach((b) => {
        b.classList.remove("use-button-active");
        b.setAttribute("aria-pressed", "false");
      });
      btn.classList.add("use-button-active");
      btn.setAttribute("aria-pressed", "true");

      selectedUse = btn.getAttribute("data-use") as UseType;
      resetResults();
      resetDependentSelects();
      try {
        await hydrateOptionsForUse(selectedUse);
      } catch (e) {
        console.error(e);
      }
    });
  });

  zoneSelect?.addEventListener("change", () => {
    hydrateHybrids().catch((e) => console.error(e));
  });

  potentialSelect?.addEventListener("change", () => {
    hydrateHybrids().catch((e) => console.error(e));
  });

  function calculate() {
    if (
      !selectedUse ||
      !zoneSelect ||
      !potentialSelect ||
      !hybridSelect ||
      !surfaceInput
    )
      return;

    const zone = zoneSelect.value;
    const potential = potentialSelect.value;
    const hybrid = hybridSelect.value;
    const surfaceHa = parseFloat(surfaceInput.value);

    if (!zone || !potential || !hybrid || !surfaceInput.value) {
      alert(i18n[lang].missingFields);
      return;
    }

    if (Number.isNaN(surfaceHa) || surfaceHa <= 0 || surfaceHa > 10000) {
      alert(
        lang === "es"
          ? "La superficie debe ser un valor v치lido entre 0.1 y 10000 Ha"
          : "A superf칤cie deve ser um valor v치lido entre 0.1 e 10000 Ha"
      );
      return;
    }

    if (!dataset) {
      alert(i18n[lang].missingDensity);
      return;
    }

    const densityK = findDensityK(dataset, {
      use: selectedUse,
      zone,
      potential,
      hybrid,
    });
    if (densityK === null) {
      alert(i18n[lang].missingDensity);
      return;
    }

    const bags = calculateBags({
      densityK,
      surfaceHa,
      seedsPerBag: dataset.seedsPerBag || 50000,
    });

    if (resultDensity) resultDensity.textContent = densityK.toString();
    if (resultBags) resultBags.textContent = bags.toString();
    if (resultsDiv) {
      resultsDiv.style.display = "block";
      resultsDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  }

  form?.addEventListener("submit", (e) => {
    e.preventDefault();
    calculate();
  });
</script>

<style>
  .density-calculator {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--spacing-8);
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
  }

  .calculator-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    text-align: center;
    margin-bottom: var(--spacing-8);
    color: var(--color-gray-900);
  }

  .calculator-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
  }

  .form-label {
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-700);
    font-size: var(--font-size-sm);
  }

  .button-group {
    display: flex;
    gap: var(--spacing-2);
  }

  .use-button {
    flex: 1;
    padding: var(--spacing-3) var(--spacing-4);
    background: var(--color-white);
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .use-button:hover {
    border-color: var(--color-dekalb-primary);
    color: var(--color-dekalb-primary);
  }

  .use-button-active {
    background-color: var(--color-dekalb-primary);
    border-color: var(--color-dekalb-primary);
    color: var(--color-white);
  }

  .form-select,
  .form-input {
    padding: var(--spacing-3);
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    transition: border-color var(--transition-fast);
  }

  .form-select:focus,
  .form-input:focus {
    outline: none;
    border-color: var(--color-dekalb-primary);
  }

  .form-slider {
    width: 100%;
    height: 8px;
    border-radius: var(--radius-full);
    background: var(--color-gray-200);
    outline: none;
    -webkit-appearance: none;
  }

  .form-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--color-dekalb-primary);
    cursor: pointer;
  }

  .form-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--color-dekalb-primary);
    cursor: pointer;
    border: none;
  }

  .form-group:has(#surface-input) {
    position: relative;
  }

  .input-unit {
    position: absolute;
    right: var(--spacing-3);
    top: calc(var(--spacing-2) + 1.5rem + var(--spacing-2));
    color: var(--color-gray-500);
    font-size: var(--font-size-sm);
  }

  .calculate-button {
    width: 100%;
    padding: var(--spacing-4);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .calculator-results {
    margin-top: var(--spacing-8);
    padding-top: var(--spacing-8);
    border-top: 2px solid var(--color-gray-200);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-4);
  }

  .result-card {
    background: var(--color-gray-50);
    padding: var(--spacing-4);
    border-radius: var(--radius-md);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-2);
  }

  .result-icon {
    font-size: 2.5rem;
  }

  .result-content h3 {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-600);
    margin: 0;
  }

  .result-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-dekalb-primary);
    margin: 0;
  }

  .result-unit {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
  }

  .result-image {
    grid-column: 1 / -1;
    text-align: center;
  }

  .result-image img {
    max-width: 100%;
    border-radius: var(--radius-md);
  }

  @media (max-width: 767px) {
    .density-calculator {
      padding: var(--spacing-4);
    }

    .button-group {
      flex-direction: column;
    }
  }
</style>
