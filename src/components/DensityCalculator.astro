---
interface Props {
  lang?: "es" | "pt";
}

const { lang = "es" } = Astro.props;

const translations = {
  es: {
    title: "Calculador de Densidades",
    subtitle:
      "Obt√©n la densidad de siembra y el n√∫mero de bolsas DEKALB que necesitas.",
    use: "Uso del ma√≠z",
    grano: "Grano",
    silo: "Silo",
    zone: "Zona geogr√°fica",
    potential: "Potencial de producci√≥n de la finca (Tn/Ha)",
    hybrid: "H√≠brido DEKALB",
    surface: "Superficie a sembrar",
    calculate: "CALCULAR",
    result: {
      density: "Densidad Recomendada",
      bags: "N¬∫ de bolsas DEKALB",
      plantsPerHa: "miles plantas/Ha",
    },
    selectZone: "Seleccionar zona",
    selectPotential: "Seleccionar potencial",
    selectHybrid: "Seleccionar h√≠brido",
    missingFields: "Por favor, completa todos los campos",
    missingDensity:
      "No hay una recomendaci√≥n disponible para esta combinaci√≥n. Revisa los datos o actualiza la tabla.",
  },
  pt: {
    title: "Calculadora de Densidades",
    subtitle:
      "Obt√©m a densidade de sementeira e o n√∫mero de sacos DEKALB que precisas.",
    use: "Uso do milho",
    grano: "Gr√£o",
    silo: "Silagem",
    zone: "Zona geogr√°fica",
    potential: "Potencial de Produ√ß√£o na quinta (Tn/Ha)",
    hybrid: "H√≠brido DEKALB",
    surface: "Superf√≠cie a semear",
    calculate: "CALCULAR",
    result: {
      density: "Densidade Recomendada",
      bags: "N¬∫ de sacos DEKALB",
      plantsPerHa: "mil plantas/Ha",
    },
    selectZone: "Selecionar zona",
    selectPotential: "Selecionar potencial",
    selectHybrid: "Selecionar h√≠brido",
    missingFields: "Por favor, preenche todos os campos",
    missingDensity:
      "N√£o existe recomenda√ß√£o para esta combina√ß√£o. Rev√™ os dados ou atualiza a tabela.",
  },
};

const t = translations[lang];
---

<section class="density-calculator-page" id="density-calculator">
  <div class="density-calculator-bg" aria-hidden="true"></div>
  <div class="density-calculator-bg-overlay" aria-hidden="true"></div>

  <div class="density-calculator-content">
    <header class="density-calculator-hero">
      <h1 class="density-calculator-title">{t.title.toUpperCase()}</h1>
      <p class="density-calculator-subtitle">{t.subtitle}</p>
    </header>

    <div class="density-calculator-card" aria-label={t.title}>
      <form class="calculator-form" id="calculator-form">
        <!-- Uso del ma√≠z (Figma: SILO / GRANO) -->
        <div class="use-toggle" role="group" aria-label={t.use}>
          <button
            type="button"
            class="use-chip use-button"
            data-use="silo"
            aria-pressed="false"
          >
            {t.silo.toUpperCase()}
          </button>
          <button
            type="button"
            class="use-chip use-button"
            data-use="grano"
            aria-pressed="false"
          >
            {t.grano.toUpperCase()}
          </button>
        </div>

        <!-- Zona geogr√°fica -->
        <div class="pill-field">
          <label for="zone-select" class="sr-only">{t.zone}</label>
          <select id="zone-select" class="pill-select" required>
            <option value="">{t.zone}</option>
          </select>
        </div>

        <!-- Potencial de producci√≥n -->
        <div class="pill-field">
          <label for="potential-select" class="sr-only">{t.potential}</label>
          <select id="potential-select" class="pill-select" required>
            <option value="">{t.potential}</option>
          </select>
        </div>

        <!-- H√≠brido DEKALB -->
        <div class="pill-field">
          <label for="hybrid-select" class="sr-only">{t.hybrid}</label>
          <select id="hybrid-select" class="pill-select" required>
            <option value="">{t.hybrid}</option>
          </select>
        </div>

        <!-- Superficie a sembrar -->
        <div class="surface-row">
          <span class="surface-label">{t.surface}</span>
          <div class="surface-input-pill">
            <label for="surface-input" class="sr-only">{t.surface}</label>
            <input
              type="number"
              id="surface-input"
              class="surface-input"
              min="0.1"
              step="0.1"
              placeholder="00"
              required
            />
          </div>
        </div>

        <button type="submit" class="calculator-cta">
          {lang === "es" ? "Calcular" : "Calcular"}
        </button>
      </form>
    </div>
  </div>

  <!-- Results (se definir√° en el siguiente paso) -->
  <div class="calculator-results" id="calculator-results" style="display: none;">
    <div class="result-card">
      <div class="result-icon">üåæ</div>
      <div class="result-content">
        <h3>{t.result.density}</h3>
        <p class="result-value" id="result-density">-</p>
        <span class="result-unit">{t.result.plantsPerHa}</span>
      </div>
    </div>
    <div class="result-card">
      <div class="result-icon">üì¶</div>
      <div class="result-content">
        <h3>{t.result.bags}</h3>
        <p class="result-value" id="result-bags">-</p>
      </div>
    </div>
    <div class="result-image">
      <img src="/calculator-result.jpg" alt="Resultado" id="result-image" />
    </div>
  </div>
</section>

<script>
  type UseType = "grano" | "silo";

  type DensityEntry = {
    use: UseType;
    zone: string;
    potential: string;
    hybrid: string;
    densityK: number;
  };

  type DensityDatasetV1 = {
    schemaVersion: 1;
    seedsPerBag: number;
    zones: Record<UseType, string[]>;
    potentials: Record<UseType, string[]>;
    entries: DensityEntry[];
  };

  const densityDataUrl = "/density-calculator.v1.json";
  const form = document.getElementById(
    "calculator-form"
  ) as HTMLFormElement | null;
  const useButtons = Array.from(
    document.querySelectorAll(".use-button")
  ) as HTMLButtonElement[];
  const zoneSelect = document.getElementById(
    "zone-select"
  ) as HTMLSelectElement | null;
  const potentialSelect = document.getElementById(
    "potential-select"
  ) as HTMLSelectElement | null;
  const hybridSelect = document.getElementById(
    "hybrid-select"
  ) as HTMLSelectElement | null;
  const surfaceInput = document.getElementById(
    "surface-input"
  ) as HTMLInputElement | null;
  const resultsDiv = document.getElementById(
    "calculator-results"
  ) as HTMLDivElement | null;
  const resultDensity = document.getElementById(
    "result-density"
  ) as HTMLElement | null;
  const resultBags = document.getElementById(
    "result-bags"
  ) as HTMLElement | null;

  const lang = document.documentElement.lang === "pt" ? "pt" : "es";
  const i18n = {
    es: {
      selectZone: "Seleccionar zona",
      selectPotential: "Seleccionar potencial",
      selectHybrid: "Seleccionar h√≠brido",
      missingFields: "Por favor, completa todos los campos",
      missingDensity:
        "No hay una recomendaci√≥n disponible para esta combinaci√≥n. Revisa los datos o actualiza la tabla.",
    },
    pt: {
      selectZone: "Selecionar zona",
      selectPotential: "Selecionar potencial",
      selectHybrid: "Selecionar h√≠brido",
      missingFields: "Por favor, preenche todos os campos",
      missingDensity:
        "N√£o existe recomenda√ß√£o para esta combina√ß√£o. Rev√™ os dados ou atualiza a tabela.",
    },
  } as const;

  let selectedUse: UseType | null = null;
  let dataset: DensityDatasetV1 | null = null;

  function clearSelect(select: HTMLSelectElement) {
    while (select.firstChild) select.removeChild(select.firstChild);
  }

  function setDefaultOption(select: HTMLSelectElement, label: string) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = label;
    select.appendChild(opt);
  }

  async function loadDataset(): Promise<DensityDatasetV1> {
    if (dataset) return dataset;
    const res = await fetch(densityDataUrl, { credentials: "omit" });
    if (!res.ok) {
      throw new Error(`Failed to load density dataset: ${res.status}`);
    }
    const json = (await res.json()) as DensityDatasetV1;
    dataset = json;
    return json;
  }

  function getAvailableZones(data: DensityDatasetV1, use: UseType): string[] {
    return Array.isArray(data.zones?.[use]) ? data.zones[use] : [];
  }

  function getAvailablePotentials(
    data: DensityDatasetV1,
    use: UseType
  ): string[] {
    return Array.isArray(data.potentials?.[use]) ? data.potentials[use] : [];
  }

  function getAvailableHybrids(
    data: DensityDatasetV1,
    params: { use: UseType; zone: string; potential: string }
  ): string[] {
    const hybrids = data.entries
      .filter(
        (e) =>
          e.use === params.use &&
          e.zone === params.zone &&
          e.potential === params.potential
      )
      .map((e) => e.hybrid);
    return Array.from(new Set(hybrids)).sort((a, b) => a.localeCompare(b));
  }

  function findDensityK(
    data: DensityDatasetV1,
    params: { use: UseType; zone: string; potential: string; hybrid: string }
  ): number | null {
    const entry = data.entries.find(
      (e) =>
        e.use === params.use &&
        e.zone === params.zone &&
        e.potential === params.potential &&
        e.hybrid === params.hybrid
    );
    return typeof entry?.densityK === "number" ? entry.densityK : null;
  }

  function calculateBags(params: {
    densityK: number;
    surfaceHa: number;
    seedsPerBag: number;
  }) {
    // densityK est√° en miles de plantas/Ha. seedsPerBag por defecto 50.000.
    // bolsas = ceil( (densityK * 1000 * ha) / seedsPerBag ) === ceil( (densityK/50) * ha ) si seedsPerBag=50.000
    const totalSeeds = params.densityK * 1000 * params.surfaceHa;
    return Math.ceil(totalSeeds / params.seedsPerBag);
  }

  function resetResults() {
    if (resultsDiv) resultsDiv.style.display = "none";
    if (resultDensity) resultDensity.textContent = "-";
    if (resultBags) resultBags.textContent = "-";
  }

  function resetDependentSelects() {
    if (!zoneSelect || !potentialSelect || !hybridSelect) return;
    clearSelect(zoneSelect);
    setDefaultOption(zoneSelect, i18n[lang].selectZone);
    clearSelect(potentialSelect);
    setDefaultOption(potentialSelect, i18n[lang].selectPotential);
    clearSelect(hybridSelect);
    setDefaultOption(hybridSelect, i18n[lang].selectHybrid);
  }

  async function hydrateOptionsForUse(use: UseType) {
    if (!zoneSelect || !potentialSelect || !hybridSelect) return;
    const data = await loadDataset();

    // Zones
    clearSelect(zoneSelect);
    setDefaultOption(zoneSelect, i18n[lang].selectZone);
    getAvailableZones(data, use).forEach((zone) => {
      const opt = document.createElement("option");
      opt.value = zone;
      opt.textContent = zone;
      zoneSelect.appendChild(opt);
    });

    // Potentials
    clearSelect(potentialSelect);
    setDefaultOption(potentialSelect, i18n[lang].selectPotential);
    getAvailablePotentials(data, use).forEach((pot) => {
      const opt = document.createElement("option");
      opt.value = pot;
      opt.textContent = pot;
      potentialSelect.appendChild(opt);
    });

    // Hybrids
    clearSelect(hybridSelect);
    setDefaultOption(hybridSelect, i18n[lang].selectHybrid);
  }

  async function hydrateHybrids() {
    if (!selectedUse || !zoneSelect || !potentialSelect || !hybridSelect)
      return;
    resetResults();
    const zone = zoneSelect.value;
    const potential = potentialSelect.value;
    clearSelect(hybridSelect);
    setDefaultOption(hybridSelect, i18n[lang].selectHybrid);
    if (!zone || !potential) return;

    const data = await loadDataset();
    const hybrids = getAvailableHybrids(data, {
      use: selectedUse,
      zone,
      potential,
    });
    hybrids.forEach((hybrid) => {
      const opt = document.createElement("option");
      opt.value = hybrid;
      opt.textContent = hybrid;
      hybridSelect.appendChild(opt);
    });
  }

  useButtons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      useButtons.forEach((b) => {
        b.classList.remove("use-button-active");
        b.setAttribute("aria-pressed", "false");
      });
      btn.classList.add("use-button-active");
      btn.setAttribute("aria-pressed", "true");

      selectedUse = btn.getAttribute("data-use") as UseType;
      resetResults();
      resetDependentSelects();
      try {
        await hydrateOptionsForUse(selectedUse);
      } catch (e) {
        console.error(e);
      }
    });
  });

  zoneSelect?.addEventListener("change", () => {
    hydrateHybrids().catch((e) => console.error(e));
  });

  potentialSelect?.addEventListener("change", () => {
    hydrateHybrids().catch((e) => console.error(e));
  });

  function calculate() {
    if (
      !selectedUse ||
      !zoneSelect ||
      !potentialSelect ||
      !hybridSelect ||
      !surfaceInput
    )
      return;

    const zone = zoneSelect.value;
    const potential = potentialSelect.value;
    const hybrid = hybridSelect.value;
    const surfaceHa = parseFloat(surfaceInput.value);

    if (!zone || !potential || !hybrid || !surfaceInput.value) {
      alert(i18n[lang].missingFields);
      return;
    }

    if (Number.isNaN(surfaceHa) || surfaceHa <= 0 || surfaceHa > 10000) {
      alert(
        lang === "es"
          ? "La superficie debe ser un valor v√°lido entre 0.1 y 10000 Ha"
          : "A superf√≠cie deve ser um valor v√°lido entre 0.1 e 10000 Ha"
      );
      return;
    }

    if (!dataset) {
      alert(i18n[lang].missingDensity);
      return;
    }

    const densityK = findDensityK(dataset, {
      use: selectedUse,
      zone,
      potential,
      hybrid,
    });
    if (densityK === null) {
      alert(i18n[lang].missingDensity);
      return;
    }

    const bags = calculateBags({
      densityK,
      surfaceHa,
      seedsPerBag: dataset.seedsPerBag || 50000,
    });

    if (resultDensity) resultDensity.textContent = densityK.toString();
    if (resultBags) resultBags.textContent = bags.toString();
    if (resultsDiv) {
      resultsDiv.style.display = "block";
      resultsDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  }

  form?.addEventListener("submit", (e) => {
    e.preventDefault();
    calculate();
  });
</script>

<style>
  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  .density-calculator-page {
    position: relative;
    min-height: 892px;
    overflow: hidden;
  }

  .density-calculator-bg {
    position: absolute;
    inset: 64px 0 0 0;
    background-image: url("/Frame_1410119213.jpg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 0;
  }

  .density-calculator-bg-overlay {
    position: absolute;
    inset: 64px 0 0 0;
    background: rgba(0, 0, 0, 0.25);
    z-index: 1;
  }

  .density-calculator-content {
    position: relative;
    z-index: 2;
    max-width: 1600px;
    margin: 0 auto;
    padding: 136px 100px 64px;
    display: grid;
    place-items: center;
    gap: 48px;
  }

  .density-calculator-hero {
    text-align: center;
    color: #fff;
    width: 571px;
    max-width: 100%;
  }

  .density-calculator-title {
    margin: 0;
    font-family: "Bayer Sans", system-ui, -apple-system, sans-serif;
    font-weight: 700;
    font-size: 32px;
    line-height: 32px;
    text-transform: uppercase;
  }

  .density-calculator-subtitle {
    margin: 13px 0 0;
    font-family: "Bayer Sans", system-ui, -apple-system, sans-serif;
    font-weight: 400;
    font-size: 20px;
    line-height: 26px;
  }

  .density-calculator-card {
    width: 353px;
    max-width: 100%;
    border-radius: 24px;
    background: rgba(255, 255, 255, 0.7);
    padding: 12px;
  }

  .calculator-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .use-toggle {
    display: flex;
    gap: 9px;
    height: 36px;
  }

  .use-chip {
    flex: 1;
    height: 36px;
    border-radius: 12px;
    background: #ffffff;
    border: 1px solid rgba(231, 231, 231, 0.6);
    font-family: Roboto, system-ui, -apple-system, sans-serif;
    font-weight: 400;
    font-size: 12px;
    line-height: 20px;
    color: #313639;
    cursor: pointer;
  }

  .use-button-active {
    border-color: rgba(231, 231, 231, 0.9);
  }

  .pill-field {
    height: 40px;
  }

  .pill-select {
    width: 100%;
    height: 40px;
    border-radius: 9999px;
    background: #ffffff;
    border: 1px solid #dbdbdb;
    padding: 0 24px;
    font-family: Roboto, system-ui, -apple-system, sans-serif;
    font-weight: 400;
    font-size: 13px;
    line-height: 20px;
    color: #313639;
    appearance: none;
  }

  .pill-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 157, 219, 0.25);
  }

  .surface-row {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
  }

  .surface-label {
    font-family: Roboto, system-ui, -apple-system, sans-serif;
    font-weight: 400;
    font-size: 13px;
    line-height: 20px;
    color: #313639;
  }

  .surface-input-pill {
    width: 91px;
    height: 40px;
    border-radius: 9999px;
    background: #ffffff;
    border: 1px solid #dbdbdb;
    display: grid;
    place-items: center;
  }

  .surface-input {
    width: 100%;
    height: 100%;
    border: 0;
    outline: none;
    background: transparent;
    text-align: center;
    font-family: Inter, system-ui, -apple-system, sans-serif;
    font-weight: 400;
    font-size: 12px;
    line-height: 14.5px;
    color: #313639;
  }

  .calculator-cta {
    height: 40px;
    width: 100%;
    border: 0;
    border-radius: 26px;
    background: linear-gradient(90deg, #009ddb 30%, #005475 100%);
    color: #ffffff;
    font-family: "Bayer Sans", system-ui, -apple-system, sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 21px;
    cursor: pointer;
  }

  .calculator-cta:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.9);
    outline-offset: 3px;
  }

  .calculator-results {
    margin-top: var(--spacing-8);
    padding-top: var(--spacing-8);
    border-top: 2px solid var(--color-gray-200);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-4);
  }

  .result-card {
    background: var(--color-gray-50);
    padding: var(--spacing-4);
    border-radius: var(--radius-md);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-2);
  }

  .result-icon {
    font-size: 2.5rem;
  }

  .result-content h3 {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-600);
    margin: 0;
  }

  .result-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-dekalb-primary);
    margin: 0;
  }

  .result-unit {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
  }

  .result-image {
    grid-column: 1 / -1;
    text-align: center;
  }

  .result-image img {
    max-width: 100%;
    border-radius: var(--radius-md);
  }

  @media (max-width: 767px) {
    .density-calculator-content {
      padding: 120px 24px 48px;
    }
  }
</style>
