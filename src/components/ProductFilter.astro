---
import type { FilterState, TipoSemilla, UsoMaiz, ZonaGeografica, ProteccionCultivo } from '../types';
import { getDefaultFilterState } from '../utils/filterLogic';

interface Props {
  filterState?: FilterState;
  lang?: 'es' | 'pt';
}

const { filterState = getDefaultFilterState(), lang = 'es' } = Astro.props;

const translations = {
  es: {
    seedType: 'Tipo de Semilla',
    maiz: 'Ma칤z',
    colza: 'Colza',
    use: 'Uso',
    grano: 'Grano',
    silo: 'Silo',
    preceon: 'Preceon',
    zone: 'Zona Geogr치fica',
    ebro: 'Ebro',
    centroSur: 'Centro Sur, Extremadura, Andaluc칤a',
    noroeste: 'Noroeste',
    portugal: 'Portugal',
    protection: 'Protecci칩n de Cultivo',
    herbicida: 'Herbicida',
    insecticida: 'Insecticida',
    bioestimulante: 'Bioestimulante',
    todos: 'Todos',
  },
  pt: {
    seedType: 'Tipo de Semente',
    maiz: 'Milho',
    colza: 'Colza',
    use: 'Uso',
    grano: 'Gr칚o',
    silo: 'Silagem',
    preceon: 'Preceon',
    zone: 'Zona Geogr치fica',
    ebro: 'Ebro',
    centroSur: 'Centro Sul, Extremadura, Andaluzia',
    noroeste: 'Noroeste',
    portugal: 'Portugal',
    protection: 'Prote칞칚o de Cultivo',
    herbicida: 'Herbicida',
    insecticida: 'Inseticida',
    bioestimulante: 'Bioestimulante',
    todos: 'Todos',
  },
};

const t = translations[lang];
---

<div class="product-filter" id="product-filter">
  <form class="filter-form" id="filter-form">
    <!-- Nivel 1: Tipo Semilla - Siempre visible -->
    <div class="filter-group">
      <label class="filter-label">{t.seedType}</label>
      <div class="filter-buttons">
        <button
          type="button"
          class:list={['filter-button', { 'filter-button-active': filterState.tipoSemilla === 'maiz' }]}
          data-filter="tipoSemilla"
          data-value="maiz"
          aria-pressed={filterState.tipoSemilla === 'maiz'}
        >
          {t.maiz}
        </button>
        <button
          type="button"
          class:list={['filter-button', { 'filter-button-active': filterState.tipoSemilla === 'colza' }]}
          data-filter="tipoSemilla"
          data-value="colza"
          aria-pressed={filterState.tipoSemilla === 'colza'}
        >
          {t.colza}
        </button>
      </div>
    </div>

    <!-- Nivel 2: Uso - Solo si Ma칤z -->
    {filterState.tipoSemilla === 'maiz' && (
      <div class="filter-group filter-group-conditional" data-level="uso">
        <label class="filter-label">{t.use}</label>
        <div class="filter-buttons">
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.uso === 'grano' }]}
            data-filter="uso"
            data-value="grano"
            aria-pressed={filterState.uso === 'grano'}
          >
            {t.grano}
          </button>
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.uso === 'silo' }]}
            data-filter="uso"
            data-value="silo"
            aria-pressed={filterState.uso === 'silo'}
          >
            {t.silo}
          </button>
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.uso === 'preceon' }]}
            data-filter="uso"
            data-value="preceon"
            aria-pressed={filterState.uso === 'preceon'}
          >
            {t.preceon}
          </button>
        </div>
      </div>
    )}

    <!-- Nivel 3: Zona - Solo si Ma칤z -->
    {filterState.tipoSemilla === 'maiz' && (
      <div class="filter-group filter-group-conditional" data-level="zona">
        <label class="filter-label">{t.zone}</label>
        <div class="filter-buttons">
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.zona === 'ebro' }]}
            data-filter="zona"
            data-value="ebro"
            aria-pressed={filterState.zona === 'ebro'}
          >
            {t.ebro}
          </button>
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.zona === 'centro-sur-extremadura-andalucia' }]}
            data-filter="zona"
            data-value="centro-sur-extremadura-andalucia"
            aria-pressed={filterState.zona === 'centro-sur-extremadura-andalucia'}
          >
            {t.centroSur}
          </button>
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.zona === 'noroeste' }]}
            data-filter="zona"
            data-value="noroeste"
            aria-pressed={filterState.zona === 'noroeste'}
          >
            {t.noroeste}
          </button>
          <button
            type="button"
            class:list={['filter-button', { 'filter-button-active': filterState.zona === 'portugal' }]}
            data-filter="zona"
            data-value="portugal"
            aria-pressed={filterState.zona === 'portugal'}
          >
            {t.portugal}
          </button>
        </div>
      </div>
    )}

    <!-- Nivel 4: Protecci칩n - Siempre visible -->
    <div class="filter-group">
      <label class="filter-label">{t.protection}</label>
      <div class="filter-buttons">
        <button
          type="button"
          class:list={['filter-button', { 'filter-button-active': filterState.proteccion === 'todos' }]}
          data-filter="proteccion"
          data-value="todos"
          aria-pressed={filterState.proteccion === 'todos'}
        >
          {t.todos}
        </button>
        <button
          type="button"
          class:list={['filter-button', { 'filter-button-active': filterState.proteccion === 'herbicida' }]}
          data-filter="proteccion"
          data-value="herbicida"
          aria-pressed={filterState.proteccion === 'herbicida'}
        >
          {t.herbicida}
        </button>
        <button
          type="button"
          class:list={['filter-button', { 'filter-button-active': filterState.proteccion === 'insecticida' }]}
          data-filter="proteccion"
          data-value="insecticida"
          aria-pressed={filterState.proteccion === 'insecticida'}
        >
          {t.insecticida}
        </button>
        <button
          type="button"
          class:list={['filter-button', { 'filter-button-active': filterState.proteccion === 'bioestimulante' }]}
          data-filter="proteccion"
          data-value="bioestimulante"
          aria-pressed={filterState.proteccion === 'bioestimulante'}
        >
          {t.bioestimulante}
        </button>
      </div>
    </div>
  </form>
</div>

<script define:vars={{ filterStateJson: JSON.stringify(filterState) }}>
  const filterForm = document.getElementById('filter-form');
  
  // Parse filterState from JSON string (Astro serialization)
  const serverFilterState = JSON.parse(filterStateJson);
  
  // ALSO parse from current URL to ensure we have the latest state
  // This is critical because the server-side state might not match the URL
  const urlParams = new URLSearchParams(window.location.search);
  const urlFilterState = {
    tipoSemilla: urlParams.get('tipo') === 'maiz' || urlParams.get('tipo') === 'colza' ? urlParams.get('tipo') : undefined,
    uso: urlParams.get('uso') || undefined,
    zona: urlParams.get('zona') || undefined,
    proteccion: urlParams.get('proteccion') || 'todos',
  };
  
  // Use URL state as source of truth, fallback to server state
  let currentFilterState = {
    tipoSemilla: urlFilterState.tipoSemilla || serverFilterState.tipoSemilla || undefined,
    uso: urlFilterState.uso || serverFilterState.uso || undefined,
    zona: urlFilterState.zona || serverFilterState.zona || undefined,
    proteccion: urlFilterState.proteccion || serverFilterState.proteccion || 'todos',
  };
  
  console.log('游댌 [ProductFilter] Server Filter State:', serverFilterState);
  console.log('游댌 [ProductFilter] URL Filter State:', urlFilterState);
  console.log('游댌 [ProductFilter] Current Filter State:', currentFilterState);
  console.log('游댌 [ProductFilter] URL:', window.location.href);
  console.log('游댌 [ProductFilter] URL Search:', window.location.search);
  console.log('游댌 [ProductFilter] tipoSemilla:', currentFilterState.tipoSemilla);
  console.log('游댌 [ProductFilter] proteccion:', currentFilterState.proteccion);
  
  // Update button states based on current filter state
  function updateButtonStates() {
    // Update tipoSemilla buttons
    document.querySelectorAll('[data-filter="tipoSemilla"]').forEach(btn => {
      const value = btn.getAttribute('data-value');
      if (value === currentFilterState.tipoSemilla) {
        btn.classList.add('filter-button-active');
        btn.setAttribute('aria-pressed', 'true');
      } else {
        btn.classList.remove('filter-button-active');
        btn.setAttribute('aria-pressed', 'false');
      }
    });
    
    // Update uso buttons
    document.querySelectorAll('[data-filter="uso"]').forEach(btn => {
      const value = btn.getAttribute('data-value');
      if (value === currentFilterState.uso) {
        btn.classList.add('filter-button-active');
        btn.setAttribute('aria-pressed', 'true');
      } else {
        btn.classList.remove('filter-button-active');
        btn.setAttribute('aria-pressed', 'false');
      }
    });
    
    // Update zona buttons
    document.querySelectorAll('[data-filter="zona"]').forEach(btn => {
      const value = btn.getAttribute('data-value');
      if (value === currentFilterState.zona) {
        btn.classList.add('filter-button-active');
        btn.setAttribute('aria-pressed', 'true');
      } else {
        btn.classList.remove('filter-button-active');
        btn.setAttribute('aria-pressed', 'false');
      }
    });
    
    // Update proteccion buttons
    document.querySelectorAll('[data-filter="proteccion"]').forEach(btn => {
      const value = btn.getAttribute('data-value');
      if (value === currentFilterState.proteccion) {
        btn.classList.add('filter-button-active');
        btn.setAttribute('aria-pressed', 'true');
      } else {
        btn.classList.remove('filter-button-active');
        btn.setAttribute('aria-pressed', 'false');
      }
    });
  }
  
  // Initial button state update
  updateButtonStates();

  function updateFilterState(filter, value) {
    console.log('游댌 [updateFilterState] Called with:', filter, value);
    console.log('游댌 [updateFilterState] Current state before update:', JSON.stringify(currentFilterState));
    
    // Update current state
    if (filter === 'tipoSemilla') {
      // Toggle: if clicking the same value, clear it
      if (currentFilterState.tipoSemilla === value) {
        currentFilterState.tipoSemilla = undefined;
      } else {
        currentFilterState.tipoSemilla = value;
      }
      // If switching to Colza, clear uso and zona
      if (currentFilterState.tipoSemilla === 'colza') {
        currentFilterState.uso = undefined;
        currentFilterState.zona = undefined;
      }
    } else if (filter === 'uso') {
      // Toggle: if clicking the same value, clear it
      if (currentFilterState.uso === value) {
        currentFilterState.uso = undefined;
      } else {
        currentFilterState.uso = value;
      }
    } else if (filter === 'zona') {
      // Toggle: if clicking the same value, clear it
      if (currentFilterState.zona === value) {
        currentFilterState.zona = undefined;
      } else {
        currentFilterState.zona = value;
      }
    } else if (filter === 'proteccion') {
      currentFilterState.proteccion = value;
    }

    console.log('游댌 [updateFilterState] Current state after update:', JSON.stringify(currentFilterState));

    // Build URL params from current state (preserving all active filters)
    const params = new URLSearchParams();
    if (currentFilterState.tipoSemilla) {
      params.set('tipo', currentFilterState.tipoSemilla);
    }
    if (currentFilterState.uso) {
      params.set('uso', currentFilterState.uso);
    }
    if (currentFilterState.zona) {
      params.set('zona', currentFilterState.zona);
    }
    if (currentFilterState.proteccion && currentFilterState.proteccion !== 'todos') {
      params.set('proteccion', currentFilterState.proteccion);
    }

    console.log('游댌 [updateFilterState] New URL params:', params.toString());

    // Reload page with new URL to apply filter server-side
    const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    console.log('游댌 [updateFilterState] Navigating to:', newURL);
    window.location.href = newURL;
  }


  if (filterForm) {
    filterForm.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.classList && target.classList.contains('filter-button')) {
        e.preventDefault();
        const filter = target.getAttribute('data-filter');
        const value = target.getAttribute('data-value');
        
        if (filter && value) {
          updateFilterState(filter, value);
        }
      }
    });
  }

  function renderConditionalGroups() {
    const usoGroup = document.querySelector('[data-level="uso"]');
    const zonaGroup = document.querySelector('[data-level="zona"]');

    if (currentFilterState.tipoSemilla === 'maiz') {
      if (usoGroup) {
        usoGroup.style.display = 'block';
        setTimeout(() => {
          usoGroup.style.opacity = '1';
        }, 10);
      }
      if (zonaGroup) {
        zonaGroup.style.display = 'block';
        setTimeout(() => {
          zonaGroup.style.opacity = '1';
        }, 10);
      }
    } else {
      if (usoGroup) {
        usoGroup.style.opacity = '0';
        setTimeout(() => {
          usoGroup.style.display = 'none';
        }, 250);
      }
      if (zonaGroup) {
        zonaGroup.style.opacity = '0';
        setTimeout(() => {
          zonaGroup.style.display = 'none';
        }, 250);
      }
    }
  }

  // Initial render - buttons are already marked correctly in HTML
  renderConditionalGroups();
  
  // Update button states after initial render
  setTimeout(() => {
    updateButtonStates();
  }, 100);

  // Export filter state getter for other components
  window.getFilterState = () => ({ ...currentFilterState });
</script>

<style>
  .product-filter {
    background-color: var(--color-gray-50);
    padding: var(--spacing-6);
    border-radius: var(--radius-lg);
    margin-bottom: var(--spacing-8);
  }

  .filter-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
  }

  .filter-group-conditional {
    transition: opacity var(--transition-base), display var(--transition-base);
  }

  .filter-label {
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-sm);
    color: var(--color-gray-700);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
  }

  .filter-button {
    padding: var(--spacing-2) var(--spacing-4);
    background-color: var(--color-white);
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    color: var(--color-gray-700);
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-button:hover {
    border-color: var(--color-dekalb-primary);
    color: var(--color-dekalb-primary);
  }

  .filter-button-active {
    background-color: var(--color-dekalb-primary);
    border-color: var(--color-dekalb-primary);
    color: var(--color-white);
  }

  .filter-button-active:hover {
    background-color: var(--color-dekalb-primary-dark);
    border-color: var(--color-dekalb-primary-dark);
  }

  @media (max-width: 767px) {
    .product-filter {
      padding: var(--spacing-4);
    }

    .filter-buttons {
      flex-direction: column;
    }

    .filter-button {
      width: 100%;
      text-align: center;
    }
  }
</style>

