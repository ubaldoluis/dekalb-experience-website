---
import PageLayout from "../../../layouts/PageLayout.astro";
import DownloadCard from "../../../components/DownloadCard.astro";
import { getAllCatalogs } from "../../../utils/prismic";
import type { CatalogoPDF } from "../../../types";

const lang = "pt";
let catalogs: CatalogoPDF[] = [];

try {
  catalogs = await getAllCatalogs(lang);
} catch (error) {
  console.error("Error fetching catalogs:", error);
}

// Filter catalogs by type
const maizCatalogs = catalogs.filter((c) => c.tipo === "maiz");
const colzaCatalogs = catalogs.filter((c) => c.tipo === "colza");

// Helper function to get category label
const getCategoryLabel = (subcategoria: string): string => {
  const labels: Record<string, { es: string; pt: string }> = {
    "genetica-agronomia": {
      es: "GENÉTICA Y AGRONOMÍA",
      pt: "GENÉTICA E AGRONOMIA",
    },
    "proteccion-cultivo": {
      es: "PROTECCIÓN DE CULTIVO",
      pt: "PROTEÇÃO DE CULTIVO",
    },
    otros: { es: "OTROS", pt: "OUTROS" },
  };
  return labels[subcategoria]?.[lang] || subcategoria.toUpperCase();
};
---

<PageLayout
  title="Catálogos"
  description="Download de catálogos DEKALB"
  lang={lang}
>
  <div class="catalogs-wrapper">
    <div class="catalogs-container">
      <header class="catalogs-header">
        <h1 class="catalogs-title">Download de Catálogos</h1>
      </header>

      <!-- Search Bar -->
      <div class="catalogs-search-wrapper">
        <div class="catalogs-search-container">
          <svg
            class="catalogs-search-icon"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            ></path>
          </svg>
          <input
            type="text"
            id="catalog-search"
            class="catalogs-search-input"
            placeholder="Pesquisar catálogos..."
            aria-label="Pesquisar catálogos"
          />
        </div>
      </div>

      <!-- DEKALB Maíz -->
      {
        maizCatalogs.length > 0 && (
          <section
            class="catalog-section"
            data-section="maiz"
          >
            <h2 class="catalog-section-title">Deklab Maíz</h2>
            <div
              class="catalogs-grid"
              id="maiz-grid"
            >
              {maizCatalogs.map((catalog) => (
                <DownloadCard
                  imagen={catalog.imagen}
                  categoria={getCategoryLabel(catalog.subcategoria)}
                  titulo={catalog.nombre}
                  urlDescarga={catalog.url_pdf}
                  variant="catalogo"
                  lang={lang}
                  data-catalog-name={catalog.nombre.toLowerCase()}
                  data-catalog-category={catalog.subcategoria.toLowerCase()}
                />
              ))}
            </div>
          </section>
        )
      }

      <!-- DEKALB Colza -->
      {
        colzaCatalogs.length > 0 && (
          <section
            class="catalog-section"
            data-section="colza"
          >
            <h2 class="catalog-section-title">Deklab Colza</h2>
            <div
              class="catalogs-grid"
              id="colza-grid"
            >
              {colzaCatalogs.map((catalog) => (
                <DownloadCard
                  imagen={catalog.imagen}
                  categoria={getCategoryLabel(catalog.subcategoria)}
                  titulo={catalog.nombre}
                  urlDescarga={catalog.url_pdf}
                  variant="catalogo"
                  lang={lang}
                  data-catalog-name={catalog.nombre.toLowerCase()}
                  data-catalog-category={catalog.subcategoria.toLowerCase()}
                />
              ))}
            </div>
          </section>
        )
      }

      {
        catalogs.length === 0 && (
          <div class="catalogs-empty">
            <p>Não há catálogos disponíveis no momento.</p>
          </div>
        )
      }
    </div>
  </div>
</PageLayout>

<script>
  // Client-side search functionality
  const searchInput = document.getElementById("catalog-search");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      const searchTerm = (e.target as HTMLInputElement).value
        .toLowerCase()
        .trim();
      const allCards = document.querySelectorAll("[data-catalog-name]");

      allCards.forEach((card) => {
        const cardElement = card as HTMLElement;
        const catalogName = cardElement.getAttribute("data-catalog-name") || "";
        const catalogCategory =
          cardElement.getAttribute("data-catalog-category") || "";

        const matchesSearch =
          catalogName.includes(searchTerm) ||
          catalogCategory.includes(searchTerm);

        if (matchesSearch || searchTerm === "") {
          cardElement.style.display = "";
        } else {
          cardElement.style.display = "none";
        }
      });

      // Hide empty sections
      const sections = document.querySelectorAll(".catalog-section");
      sections.forEach((section) => {
        const sectionElement = section as HTMLElement;
        const grid = sectionElement.querySelector(".catalogs-grid");
        const visibleCards =
          grid?.querySelectorAll('[data-catalog-name][style=""]') ||
          grid?.querySelectorAll(
            '[data-catalog-name]:not([style*="display: none"])'
          );

        if (visibleCards && visibleCards.length === 0) {
          sectionElement.style.display = "none";
        } else {
          sectionElement.style.display = "";
        }
      });
    });
  }
</script>

<style>
  .catalogs-wrapper {
    background-image: url("/background-article.png");
    background-position: top center;
    background-repeat: no-repeat;
    background-size: contain;
    background-color: #ffffff;
    padding: var(--spacing-16) 0;
  }

  .catalogs-container {
    max-width: 1196px;
    margin: 0 auto;
    padding: 0 var(--spacing-4);
  }

  .catalogs-header {
    text-align: center;
    margin-bottom: var(--spacing-12);
  }

  .catalogs-title {
    font-size: 48px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #00527f;
    margin: 0;
    line-height: 57.6px;
    letter-spacing: 0.96px;
  }

  .catalogs-search-wrapper {
    margin-bottom: var(--spacing-12);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }

  .catalogs-search-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .catalogs-search-icon {
    position: absolute;
    left: var(--spacing-4);
    color: #9ca3af;
    pointer-events: none;
    z-index: 1;
    transition: color var(--transition-base);
  }

  .catalogs-search-container:has(.catalogs-search-input:focus)
    .catalogs-search-icon {
    color: #009ddb;
  }

  .catalogs-search-input {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-4) var(--spacing-3)
      calc(var(--spacing-4) + 28px);
    border: 1px solid #e9e7e4;
    border-radius: 100px;
    font-size: 16px;
    font-family: var(--font-family-primary);
    color: #313639;
    transition: all var(--transition-base);
    background-color: #ffffff;
  }

  .catalogs-search-input:focus {
    outline: none;
    border-color: #009ddb;
    box-shadow: 0 0 0 2px rgba(0, 157, 219, 0.1);
  }

  .catalogs-search-input::placeholder {
    color: #9ca3af;
  }

  .catalog-section {
    margin-bottom: var(--spacing-16);
  }

  .catalog-section-title {
    font-size: 32px;
    font-weight: 700;
    font-family: var(--font-family-primary);
    color: #00527f;
    margin: 0 0 var(--spacing-8) 0;
    line-height: 1.2;
    text-align: center;
  }

  .catalogs-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-6);
    justify-items: center;
  }

  /* Centrar elementos huérfanos (menos de 3 en última fila) */
  .catalogs-grid > :nth-child(3n + 1):last-child {
    grid-column: 2;
  }

  .catalogs-grid > :nth-child(3n + 1):nth-last-child(2) {
    grid-column: 1;
  }

  .catalogs-grid > :nth-child(3n + 2):last-child {
    grid-column: 3;
  }

  .catalogs-empty {
    text-align: center;
    padding: var(--spacing-12);
    color: #313639;
    font-size: 20px;
  }

  @media (max-width: 1023px) {
    .catalogs-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .catalogs-grid > :nth-child(3n + 1):last-child,
    .catalogs-grid > :nth-child(3n + 1):nth-last-child(2),
    .catalogs-grid > :nth-child(3n + 2):last-child {
      grid-column: auto;
    }

    .catalogs-grid > :nth-child(2n + 1):last-child {
      grid-column: 1;
    }
  }

  @media (max-width: 767px) {
    .catalogs-wrapper {
      padding: var(--spacing-8) 0;
    }

    .catalogs-title {
      font-size: 32px;
      line-height: 38.4px;
      letter-spacing: 0.64px;
    }

    .catalogs-grid {
      grid-template-columns: 1fr;
    }

    .catalog-section-title {
      font-size: 24px;
    }
  }
</style>
