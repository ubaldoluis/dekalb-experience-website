---
import PageLayout from "../../layouts/PageLayout.astro";
import { getProteccionCultivoContent } from "../../utils/prismic";
import { renderRichText } from "../../utils/prismic-rich-text";
import * as prismic from "@prismicio/client";

const lang = "pt";
let proteccionCultivoContent = null;

try {
  proteccionCultivoContent = await getProteccionCultivoContent(lang);
} catch (error) {
  console.error("Error fetching ProteccionCultivo content:", error);
}

// Fallback content si no hay datos de Prismic
const defaultContent = {
  hero: {
    titulo: "Proteção de Cultivo",
    descripcion: [
      {
        type: "paragraph",
        text: "Soluções integradas para proteger e otimizar as suas culturas",
        spans: [],
      },
    ],
    imagen_fondo: undefined,
    imagen_fondo_mobile: undefined,
  },
  soluciones: [
    {
      logo: undefined,
      texto_introductorio: [],
      tabla: [],
    },
    {
      logo: undefined,
      texto_introductorio: [],
      tabla: [],
    },
    {
      logo: undefined,
      texto_introductorio: [],
      tabla: [],
    },
    {
      logo: undefined,
      texto_introductorio: [],
      tabla: [],
    },
  ],
  tabla_tratamientos: [],
  seccion_imagen_texto: {
    imagen: undefined,
    texto: [],
  },
};

const content = proteccionCultivoContent || defaultContent;

// Traducciones
const translations = {
  es: {
    soluciones: "Soluciones",
  },
  pt: {
    soluciones: "Soluções",
  },
};

const t = translations[lang as keyof typeof translations] || translations.es;
---

<PageLayout
  title="Proteção de Cultivo"
  description="Soluções de proteção para suas culturas"
  lang={lang}
>
  <!-- Hero Section -->
  <section class="proteccion-hero">
    <div
      class="proteccion-hero-gradient"
      style={content.hero.imagen_fondo?.url
        ? `background-image: url("${content.hero.imagen_fondo.url}");`
        : ""}
    >
    </div>
    {
      content.hero.imagen_fondo_mobile?.url && (
        <div class="proteccion-hero-mobile-image">
          <img
            src={content.hero.imagen_fondo_mobile.url}
            alt={content.hero.imagen_fondo_mobile.alt || ""}
            loading="lazy"
          />
        </div>
      )
    }
    <div class="container">
      <div class="proteccion-hero-content">
        <h1 class="proteccion-hero-title">{content.hero.titulo}</h1>
        <div
          class="proteccion-hero-description"
          set:html={renderRichText(content.hero.descripcion)}
        />
      </div>
    </div>
  </section>

  <!-- Sección Soluciones -->
  <section class="proteccion-soluciones">
    <div class="container">
      <h2 class="proteccion-soluciones-title">{t.soluciones}</h2>
      {
        content.soluciones && content.soluciones.length > 0 ? (
          <div class="proteccion-soluciones-grid">
            {content.soluciones.map((solucion, index) => (
              <div
                class="proteccion-solucion-card"
                key={`solucion-${index}`}
              >
                <div class="proteccion-solucion-header">
                  {solucion.logo?.url && (
                    <div class="proteccion-solucion-logo">
                      <img
                        src={solucion.logo.url}
                        alt={solucion.logo.alt || `Solução ${index + 1}`}
                        loading="lazy"
                      />
                    </div>
                  )}
                  {solucion.texto_introductorio &&
                    (Array.isArray(solucion.texto_introductorio)
                      ? solucion.texto_introductorio.length > 0
                      : solucion.texto_introductorio) && (
                      <div
                        class="proteccion-solucion-texto"
                        set:html={renderRichText(solucion.texto_introductorio)}
                      />
                    )}
                </div>
                {solucion.tabla &&
                  (Array.isArray(solucion.tabla)
                    ? solucion.tabla.length > 0
                    : solucion.tabla) && (
                    <div
                      class="proteccion-solucion-tabla"
                      set:html={renderRichText(solucion.tabla)}
                    />
                  )}
              </div>
            ))}
          </div>
        ) : null
      }
    </div>
  </section>

  <!-- Sección Tabla de Tratamientos -->
  <section class="proteccion-tabla-tratamientos">
    <div class="container">
      <h2 class="proteccion-tabla-tratamientos-title">
        {lang === "es" ? "Tabla tratamientos" : "Tabela de tratamentos"}
      </h2>
      <div
        class="proteccion-tabla-tratamientos-content"
        set:html={renderRichText(content.tabla_tratamientos)}
      />
    </div>
  </section>

  <!-- Sección Imagen y Texto -->
  {
    (content.seccion_imagen_texto.imagen?.url ||
      content.seccion_imagen_texto.texto?.length > 0) && (
      <section class="proteccion-imagen-texto">
        <div class="container">
          <div class="proteccion-imagen-texto-wrapper">
            {content.seccion_imagen_texto.imagen?.url && (
              <div class="proteccion-imagen-texto-imagen">
                <img
                  src={content.seccion_imagen_texto.imagen.url}
                  alt={content.seccion_imagen_texto.imagen.alt || ""}
                  loading="lazy"
                />
              </div>
            )}
            {content.seccion_imagen_texto.texto?.length > 0 && (
              <div
                class="proteccion-imagen-texto-texto"
                set:html={renderRichText(content.seccion_imagen_texto.texto)}
              />
            )}
          </div>
        </div>
      </section>
    )
  }
</PageLayout>

<style>
  /* Hero Section */
  .proteccion-hero {
    position: relative;
    /* Mobile: sin espacio arriba, solo abajo */
    padding: 0 0 var(--spacing-16) 0;
    /* Degradado mobile */
    background: linear-gradient(135deg, #009ddb 0%, #abe2f8 100%);
    border-radius: 0 0 60px 60px;
    overflow: hidden;
    min-width: auto;
    min-height: 628px;
  }

  .proteccion-hero-gradient {
    display: none;
  }

  .proteccion-hero-mobile-image {
    position: relative;
    z-index: 1;
    width: 100%;
    display: block;
  }

  .proteccion-hero-mobile-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .proteccion-hero-content {
    position: relative;
    z-index: 1;
    max-width: 462px;
  }

  @media (min-width: 1024px) {
    .proteccion-hero-gradient {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      background-repeat: no-repeat;
      background-position: right top;
      background-size: contain;
      z-index: 0;
    }
    .proteccion-hero {
      position: relative;
      padding: var(--spacing-16) 0;
      background: linear-gradient(
        135deg,
        #abe2f8 0%,
        #009ddb 70%,
        #ffffff 100%
      );
      border-radius: 0;
      border-bottom-left-radius: 60px;
      min-width: 500px !important;
      min-height: 628px;
      display: flex;
      align-items: center;
    }
    .proteccion-hero .container {
      display: flex;
      align-items: center;
      height: 100%;
    }
    .proteccion-hero-mobile-image {
      display: none;
    }
    .proteccion-hero-content {
      padding-top: 0;
      margin-top: 0;
    }
  }

  /* Sección Soluciones */
  .proteccion-soluciones {
    padding: var(--spacing-16) 0;
  }

  .proteccion-soluciones-title {
    font-size: var(--font-size-3xl);
    font-weight: 700;
    margin-bottom: var(--spacing-12);
    color: #00527f;
    text-align: center;
  }

  .proteccion-soluciones-grid {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-8);
  }

  .proteccion-solucion-card {
    background-color: #edfcff;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }

  .proteccion-solucion-header {
    background-color: #002f47;
    border-radius: 1rem 1rem 0 0;
    padding: var(--spacing-6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-4);
    min-height: 180px;
  }

  .proteccion-solucion-logo {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }

  .proteccion-solucion-logo img {
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: none;
    object-fit: contain;
    display: block;
  }

  .proteccion-solucion-texto {
    font-size: 11px;
    line-height: 1.6;
    color: #ffffff;
    text-align: center;
  }

  .proteccion-solucion-texto :global(p) {
    margin-bottom: 0;
    color: #ffffff;
  }

  .proteccion-solucion-texto :global(p:last-child) {
    margin-bottom: 0;
  }

  .proteccion-solucion-tabla {
    overflow-x: auto;
    padding: 0;
    margin: 0;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Ocultar comentarios HTML */
  .proteccion-solucion-tabla :global(comment),
  .proteccion-solucion-tabla :global(<!--) {
    display: none;
  }

  /* Desktop: mostrar soluciones en grid de 4 columnas */
  @media (min-width: 1024px) {
    .proteccion-soluciones-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-8);
      align-items: stretch;
    }

    .proteccion-solucion-card {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .proteccion-solucion-header {
      width: 100%;
      height: 200px;
      min-height: 200px;
      max-height: 200px;
      flex-shrink: 0;
    }

    .proteccion-solucion-tabla {
      flex: 1;
      min-height: 0;
    }

    .proteccion-solucion-tabla :global(table) {
      background-color: #edfcff;
    }
  }

  /* Sección Tabla de Tratamientos */
  .proteccion-tabla-tratamientos {
    padding: var(--spacing-16) 0;
    background-color: var(--color-gray-50);
  }

  .proteccion-tabla-tratamientos-title {
    font-size: var(--font-size-3xl);
    font-weight: 700;
    margin-bottom: var(--spacing-12);
    color: #00527f;
    text-align: center;
  }

  .proteccion-tabla-tratamientos-content {
    overflow-x: auto;
  }

  /* Asegurar que el fondo de la tabla de tratamientos sea #E8F4F8 */
  .proteccion-tabla-tratamientos-content :global(table) {
    background-color: #e8f4f8 !important;
  }

  .proteccion-tabla-tratamientos-content :global(thead tr) {
    background-color: #e8f4f8 !important;
  }

  .proteccion-tabla-tratamientos-content :global(tbody) {
    background-color: #e8f4f8 !important;
  }

  /* Sección Imagen y Texto */
  .proteccion-imagen-texto {
    padding: var(--spacing-16) 0;
  }

  .proteccion-imagen-texto-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-8);
  }

  .proteccion-imagen-texto-imagen {
    width: 100%;
  }

  .proteccion-imagen-texto-imagen img {
    width: 100%;
    height: auto;
    object-fit: contain;
  }

  .proteccion-imagen-texto-texto {
    width: 100%;
  }

  /* Desktop: imagen izquierda, texto derecha */
  @media (min-width: 1024px) {
    .proteccion-imagen-texto-wrapper {
      flex-direction: row;
      align-items: flex-start;
      gap: var(--spacing-12);
    }

    .proteccion-imagen-texto-imagen {
      flex: 0 0 45%;
    }

    .proteccion-imagen-texto-texto {
      flex: 0 0 55%;
    }
  }

  /* Estilos para tablas dentro del contenido rich text */
  .proteccion-solucion-tabla :global(table),
  .proteccion-tabla-tratamientos-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 0 !important;
    border-radius: 0;
    overflow: hidden;
    height: 100%;
    flex: 1;
  }

  /* Asegurar que el fondo de la tabla sea #EDFCFF para coincidir con la card */
  .proteccion-solucion-tabla :global(table[style*="background-color"]) {
    background-color: #edfcff !important;
  }

  .proteccion-solucion-tabla :global(table th),
  .proteccion-tabla-tratamientos-content :global(table th),
  .proteccion-solucion-tabla :global(table td),
  .proteccion-tabla-tratamientos-content :global(table td) {
    padding: var(--spacing-3) var(--spacing-4);
    text-align: left;
    vertical-align: top;
    font-size: var(--font-size-sm);
  }

  /* Reducir tamaño de texto en tablas en desktop */
  @media (min-width: 1024px) {
    .proteccion-solucion-tabla :global(table th),
    .proteccion-solucion-tabla :global(table td) {
      font-size: 11px;
      padding: var(--spacing-2) var(--spacing-3);
    }
  }

  .proteccion-solucion-tabla :global(table th),
  .proteccion-tabla-tratamientos-content :global(table th) {
    background-color: var(--color-gray-100);
    font-weight: 600;
  }

  /* Preservar estilos inline de las tablas de Prismic */
  .proteccion-solucion-tabla :global(table[style]),
  .proteccion-tabla-tratamientos-content :global(table[style]) {
    border-radius: 8px;
    margin: 0 !important;
  }
</style>
