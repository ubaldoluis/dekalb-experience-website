---
import PageLayout from '../../layouts/PageLayout.astro';
import FilterDropdown from '../../components/FilterDropdown.astro';
import ProductCarousel from '../../components/ProductCarousel.astro';
import ProductModal from '../../components/ProductModal.astro';
import SolutionsHero from '../../components/SolutionsHero.astro';
import SolutionsCarousel from '../../components/SolutionsCarousel.astro';
import CTASection from '../../components/CTASection.astro';
import { getAllProducts, getAllArticles } from '../../utils/prismic';
import { filterProducts, getDefaultFilterState, searchParamsToFilterState } from '../../utils/filterLogic';
import type { Producto, FilterState } from '../../types';

const lang = 'pt';

// Fetch products and articles
let allProducts: Producto[] = [];
let articles: any[] = [];
let prismicHomeContent = null;

try {
  allProducts = await getAllProducts(lang);
  articles = await getAllArticles(lang);
  prismicHomeContent = await getHomeContent(lang);
} catch (error) {
  console.error('Error fetching data:', error);
}

// Use Prismic content if available, otherwise use mockup
const homeContent = prismicHomeContent || {
  hero: {
    title: 'DEKALB EXPERIENCE',
    claim: 'Sempre ao seu lado',
  },
  solutions: {
    integralMaiz: 'SoluÃ§Ãµes Integrais para Milho',
    fieldview: 'FieldView',
    protection: 'ProteÃ§Ã£o de Cultivo',
    preceon: 'Smart Corn System PRECEON',
    avoidProblems: 'Evite problemas com seu milho',
  },
};

// Get filter state from URL params
const url = Astro.url;
const filterState: FilterState = searchParamsToFilterState(url.searchParams);

// Filter products based on current filter state
const filteredProducts = filterProducts(allProducts, filterState);

// Get latest 3 articles for blog preview
const latestArticles = articles.slice(0, 3);
---

<PageLayout title={homeContent.hero.title} description={homeContent.hero.claim} lang={lang}>
  <!-- Hero + Products Section (Desktop) -->
  <section class="hero-products-section">
    <div class="hero-products-background"></div>
    <div class="hero-products-overlay"></div>
    <div class="hero-products-container">
      <!-- Hero Content -->
      <div class="hero-products-header">
        <h1 class="hero-products-title">{homeContent.hero.title}</h1>
        <p class="hero-products-subtitle">{homeContent.hero.claim}</p>
      </div>
      
      <!-- Filters -->
      <div class="hero-products-filters">
        <FilterDropdown filterState={filterState} lang={lang} />
      </div>
      
      <!-- Products Carousel -->
      <div class="hero-products-carousel">
        <ProductCarousel products={filteredProducts} lang={lang} carouselId="product-carousel-desktop" />
      </div>
    </div>
  </section>

  <!-- Mobile: Separate Hero Section -->
  <section class="mobile-hero-section">
    <SolutionsHero 
      title={homeContent.hero.title}
      subtitle={homeContent.hero.claim}
    />
  </section>

  <!-- Mobile: Products Section -->
  <section id="productos" class="mobile-products-section">
    <div class="container">
      <h2 class="section-title">Produtos</h2>
      <FilterDropdown filterState={filterState} lang={lang} />
      <ProductCarousel products={filteredProducts} lang={lang} carouselId="product-carousel-mobile" />
    </div>
  </section>

  <!-- Filter Script (works for both desktop and mobile) -->
  <script define:vars={{ filterStateJson: JSON.stringify(filterState), allProductsJson: JSON.stringify(allProducts), filteredProductsJson: JSON.stringify(filteredProducts) }}>
        // Parse filterState from JSON (Astro serialization)
        const filterState = JSON.parse(filterStateJson);
        const allProducts = JSON.parse(allProductsJson);
        const filteredProducts = JSON.parse(filteredProductsJson);
        
        // Expose allProducts globally for FilterDropdown component
        window.__allProducts = allProducts;
        
        // ALSO parse from current URL to ensure we have the latest state
        const urlParams = new URLSearchParams(window.location.search);
        const urlFilterState = {
          tipoSemilla: urlParams.get('tipo') === 'maiz' || urlParams.get('tipo') === 'colza' ? urlParams.get('tipo') : undefined,
          uso: urlParams.get('uso') || undefined,
          zona: urlParams.get('zona') || undefined,
          proteccion: urlParams.get('proteccion') || 'todos',
        };
        
        // Client-side filtering fallback (if server filtering didn't work correctly)
        if (allProducts.length > 0) {
          let clientFiltered = [...allProducts];
          
          if (urlFilterState.tipoSemilla) {
            clientFiltered = clientFiltered.filter(p => p.tipo_semilla?.toLowerCase() === urlFilterState.tipoSemilla);
          }
          if (urlFilterState.uso) {
            clientFiltered = clientFiltered.filter(p => p.uso?.toLowerCase() === urlFilterState.uso);
          }
          if (urlFilterState.zona) {
            clientFiltered = clientFiltered.filter(p => p.zona?.toLowerCase() === urlFilterState.zona);
          }
          if (urlFilterState.proteccion && urlFilterState.proteccion !== 'todos') {
            clientFiltered = clientFiltered.filter(p => p.proteccion?.toLowerCase() === urlFilterState.proteccion);
          }
          
          // Update carousel with client-filtered products if needed
          if (clientFiltered.length !== filteredProducts.length) {
            setTimeout(() => {
              const event = new CustomEvent('updateProducts', { detail: { products: clientFiltered } });
              document.dispatchEvent(event);
            }, 100);
          }
        }
  </script>

  <!-- Solutions Section -->
  <section id="soluciones" class="solutions-section">
    <div class="container">
      <h2 class="section-title">SoluÃ§Ãµes</h2>
      <p class="section-description">Descubra nossas soluÃ§Ãµes integrais para o cultivo de milho.</p>
      <SolutionsCarousel 
        solutions={[
          { 
            id: 'acceleron',
            name: 'Acceleron',
            description: 'Protege e nutre seu milho com AcceleronÂ® para uma cultura saudÃ¡vel e produtiva.',
            logo: '/Logo_Acceleron.svg',
            icon: '/Icon_Acceleron.svg'
          },
          { 
            id: 'fieldshield',
            name: 'FieldShield',
            description: 'Fortalece seu milho. FieldShield reduz o risco de doenÃ§as e melhora o rendimento.',
            logo: '/Logo_Fieldshield.svg',
            icon: '/Icon_FieldShield.svg'
          },
          { 
            id: 'silo-extra',
            name: 'Silo Extra',
            description: 'Mais qualidade, mais quantidade. Descubra os hÃ­bridos SiloExtra e melhore sua colheita.',
            logo: '/Logo_SiloExtra.svg',
            icon: '/Icon_SiloExtra.svg'
          },
          { 
            id: 'preceon',
            name: 'Preceon',
            description: 'Proteja seu milho desde o primeiro dia com as soluÃ§Ãµes Bayer mais eficazes.',
            logo: '/Logo_Preceon.svg',
            icon: '/Icon_Preceon.svg'
          },
          { 
            id: 'fieldview',
            name: 'FieldView',
            description: 'Aproveite seus dados. Acesse FieldView e tome decisÃµes mais inteligentes em cada campanha.',
            logo: '/Logo_Fieldview.svg',
            icon: '/Icon_FieldView.svg'
          },
        ]}
        lang={lang}
      />
    </div>
  </section>

  <!-- FieldView Section -->
  <section class="fieldview-section">
    <div class="container">
      <CTASection
        title={homeContent.solutions.fieldview}
        description="Plataforma digital para gestÃ£o agrÃ­cola avanÃ§ada"
        buttonText="Saber mais"
        buttonLink="/pt/fieldview"
        variant="primary"
        lang={lang}
      />
    </div>
  </section>

  <!-- ProtecciÃ³n de Cultivo Section -->
  <section class="protection-section">
    <div class="container">
      <CTASection
        title={homeContent.solutions.protection}
        description="SoluÃ§Ãµes inovadoras para a proteÃ§Ã£o das suas culturas"
        buttonText="Ver soluÃ§Ãµes"
        buttonLink="/pt/#soluciones"
        variant="secondary"
        lang={lang}
      />
    </div>
  </section>

  <!-- Preceon Section -->
  <section class="preceon-section">
    <div class="container">
      <div class="preceon-content">
        <h2 class="preceon-title">{homeContent.solutions.preceon}</h2>
        <p class="preceon-description">
          Sistema inteligente de gestÃ£o para milho com tecnologia de ponta.
        </p>
        <a href="/pt/preceon" class="btn btn-primary">Descobrir Preceon</a>
      </div>
    </div>
  </section>

  <!-- Evita Problemas Section -->
  <section class="avoid-problems-section">
    <div class="container">
      <CTASection
        title={homeContent.solutions.avoidProblems}
        buttonText="Ver guias"
        buttonLink="/pt/evita-problemas"
        variant="primary"
        lang={lang}
      />
    </div>
  </section>

  <!-- CatÃ¡logos Section -->
  <section class="catalogs-section">
    <div class="container">
      <h2 class="section-title">Download de CatÃ¡logos</h2>
      <div class="catalogs-grid">
        <a href="/es/catalogo" class="catalog-card">
          <span class="catalog-flag">ðŸ‡ªðŸ‡¸</span>
          <span class="catalog-name">Espanha</span>
        </a>
        <a href="/pt/catalogo" class="catalog-card">
          <span class="catalog-flag">ðŸ‡µðŸ‡¹</span>
          <span class="catalog-name">Portugal</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Blog Preview Section -->
  {latestArticles.length > 0 && (
    <section class="blog-preview-section">
      <div class="container">
        <h2 class="section-title">Ãšltimas NotÃ­cias</h2>
        <div class="blog-preview-grid">
          {latestArticles.map((article) => (
            <article class="blog-preview-card">
              {article.imagen_destacada?.url && (
                <img 
                  src={article.imagen_destacada.url} 
                  alt={article.imagen_destacada.alt || article.titulo}
                  class="blog-preview-image"
                  loading="lazy"
                />
              )}
              <div class="blog-preview-content">
                <span class="badge badge-primary">{article.categoria}</span>
                <h3 class="blog-preview-title">{article.titulo}</h3>
                <p class="blog-preview-date">
                  {new Date(article.fecha).toLocaleDateString('pt-PT')}
                </p>
                <p class="blog-preview-excerpt">{article.extracto}</p>
                <a href={`/pt/blog/${article.slug}`} class="btn btn-outline">
                  Ler mais
                </a>
              </div>
            </article>
          ))}
        </div>
        <div class="blog-preview-footer">
          <a href="/pt/blog" class="btn btn-primary">Ver todos os artigos</a>
        </div>
      </div>
    </section>
  )}

  <ProductModal lang={lang} />
</PageLayout>

<style>
  /* Hero + Products Combined Section (Desktop) */
  .hero-products-section {
    position: relative;
    min-height: 80vh;
    display: none;
    overflow: hidden;
  }

  @media (min-width: 1024px) {
    .hero-products-section {
      display: block;
    }
  }

  .hero-products-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('/Frame_1410119213.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 0;
  }

  .hero-products-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.2) 100%);
    z-index: 1;
  }

  .hero-products-container {
    position: relative;
    z-index: 2;
    padding-top: calc(var(--header-height) + var(--spacing-8));
    padding-bottom: var(--spacing-16);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
    min-height: calc(100vh - var(--header-height));
    width: 100%;
    max-width: 100%;
  }

  /* Hide section title in desktop hero-products section */
  .hero-products-section .section-title {
    display: none;
  }

  .hero-products-header {
    text-align: center;
    color: var(--color-white);
  }

  .hero-products-title {
    font-size: var(--hero-title-size);
    font-weight: var(--font-weight-bold);
    color: var(--color-white);
    margin-bottom: var(--spacing-3);
    line-height: var(--line-height-tight);
    letter-spacing: var(--letter-spacing-normal);
  }

  .hero-products-subtitle {
    font-size: var(--hero-subtitle-size);
    color: var(--color-white);
    margin: 0;
    line-height: var(--line-height-normal);
    font-weight: var(--font-weight-regular);
  }

  .hero-products-filters {
    display: flex;
    justify-content: center;
  }

  .hero-products-carousel {
    width: 100%;
  }

  /* Mobile: Separate Sections */
  .mobile-hero-section {
    display: block;
  }

  .mobile-products-section {
    display: block;
    padding: var(--spacing-16) 0;
    background-color: var(--color-white);
  }

  @media (min-width: 1024px) {
    .mobile-hero-section,
    .mobile-products-section {
      display: none;
    }
  }

  .products-section {
    padding: var(--spacing-16) 0;
    background-color: var(--color-white);
  }

  .section-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    text-align: center;
    margin-bottom: var(--spacing-4);
    color: var(--color-white);
    line-height: var(--line-height-tight);
  }

  .section-description {
    font-size: var(--font-size-lg);
    text-align: center;
    margin-bottom: var(--spacing-8);
    color: var(--color-white);
    line-height: var(--line-height-relaxed);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }

  .solutions-section {
    padding: var(--spacing-16) 0;
    background: var(--gradient-hero-solutions);
  }

  .solutions-section .section-title,
  .solutions-section .section-description {
    color: var(--color-white);
  }

  .fieldview-section,
  .protection-section {
    padding: var(--spacing-12) 0;
  }

  .preceon-section {
    padding: var(--spacing-16) 0;
    background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
    color: var(--color-white);
  }

  .preceon-content {
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
  }

  .preceon-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-white);
    margin-bottom: var(--spacing-4);
  }

  .preceon-description {
    font-size: var(--font-size-xl);
    color: var(--color-white);
    opacity: 0.95;
    margin-bottom: var(--spacing-6);
  }

  .avoid-problems-section {
    padding: var(--spacing-12) 0;
    background-color: var(--color-gray-50);
  }

  .catalogs-section {
    padding: var(--spacing-16) 0;
    background-color: var(--color-white);
  }

  .catalogs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-6);
    max-width: 600px;
    margin: 0 auto;
  }

  .catalog-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-6);
    background: var(--color-white);
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-lg);
    text-decoration: none;
    transition: all var(--transition-base);
  }

  .catalog-card:hover {
    border-color: var(--color-dekalb-primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-4px);
  }

  .catalog-flag {
    font-size: 3rem;
  }

  .catalog-name {
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-900);
  }

  .blog-preview-section {
    padding: var(--spacing-16) 0;
    background-color: var(--color-gray-50);
  }

  .blog-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-8);
  }

  .blog-preview-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
  }

  .blog-preview-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .blog-preview-image {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
  }

  .blog-preview-content {
    padding: var(--spacing-4);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
  }

  .blog-preview-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-900);
    margin: 0;
  }

  .blog-preview-date {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
    margin: 0;
  }

  .blog-preview-excerpt {
    font-size: var(--font-size-sm);
    color: var(--color-gray-600);
    margin: 0;
  }

  .blog-preview-footer {
    text-align: center;
  }

  @media (max-width: 767px) {
    .blog-preview-grid {
      grid-template-columns: 1fr;
    }

    .catalogs-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

