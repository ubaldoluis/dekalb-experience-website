---
import PageLayout from "../../layouts/PageLayout.astro";
import FilterDropdown from "../../components/FilterDropdown.astro";
import ProductCarousel from "../../components/ProductCarousel.astro";
import ProductModal from "../../components/ProductModal.astro";
import SolutionsHero from "../../components/SolutionsHero.astro";
import SolutionsCarousel from "../../components/SolutionsCarousel.astro";
import CTASection from "../../components/CTASection.astro";
import {
  getAllProducts,
  getAllArticles,
  getHomeContent,
} from "../../utils/prismic";
import {
  filterProducts,
  getDefaultFilterState,
  searchParamsToFilterState,
} from "../../utils/filterLogic";
import type { Producto, FilterState } from "../../types";

const lang = "es";

// Fetch products and articles
let allProducts: Producto[] = [];
let articles: any[] = [];
let prismicHomeContent = null;

try {
  allProducts = await getAllProducts(lang);
  articles = await getAllArticles(lang);
  prismicHomeContent = await getHomeContent(lang);
} catch (error) {
  console.error("Error fetching data:", error);
}

// Use Prismic content if available, otherwise use mockup
const homeContent = prismicHomeContent || {
  hero: {
    title: "DEKALB EXPERIENCE",
    claim: "Siempre a tu lado",
  },
  solutions: {
    integralMaiz: "Soluciones Integrales para MaÃ­z",
    fieldview: "FieldView",
    protection: "ProtecciÃ³n de Cultivo",
    preceon: "Smart Corn System PRECEON",
    avoidProblems: "Evita problemas con tu maÃ­z",
  },
};

// Get filter state from URL params
const url = Astro.url;
const filterState: FilterState = searchParamsToFilterState(url.searchParams);

// Debug: Log URL params and filter state (server-side)
console.log("ðŸ”— [SERVER] URL:", url.href);
console.log("ðŸ”— [SERVER] URL Search:", url.search);
console.log(
  "ðŸ”— [SERVER] Search Params:",
  Array.from(url.searchParams.entries())
);
console.log(
  "ðŸ“‹ [SERVER] Parsed Filter State:",
  JSON.stringify(filterState, null, 2)
);
console.log("ðŸ“‹ [SERVER] FilterState tipoSemilla:", filterState.tipoSemilla);
console.log("ðŸ“‹ [SERVER] FilterState proteccion:", filterState.proteccion);
console.log("ðŸ“‹ [SERVER] FilterState uso:", filterState.uso);
console.log("ðŸ“‹ [SERVER] FilterState zona:", filterState.zona);
console.log("ðŸ“‹ [SERVER] All Products count:", allProducts.length);
console.log(
  "ðŸ“‹ [SERVER] All Products details:",
  allProducts.map((p) => ({
    nombre: p.nombre,
    tipo_semilla: p.tipo_semilla,
    proteccion: p.proteccion,
    uso: p.uso,
    zona: p.zona,
  }))
);

// Filter products based on current filter state
const filteredProducts = filterProducts(allProducts, filterState);
console.log("ðŸ“‹ [SERVER] Filtered Products count:", filteredProducts.length);
console.log(
  "ðŸ“‹ [SERVER] Filtered Products details:",
  filteredProducts.map((p) => ({
    nombre: p.nombre,
    tipo_semilla: p.tipo_semilla,
    proteccion: p.proteccion,
    uso: p.uso,
    zona: p.zona,
  }))
);

// Get latest 3 articles for blog preview
const latestArticles = articles.slice(0, 3);
---

<PageLayout
  title={homeContent.hero.title}
  description={homeContent.hero.claim}
  lang={lang}
>
  <!-- Hero + Products Section (Desktop) -->
  <section class="hero-products-section">
    <div class="hero-products-background"></div>
    <div class="hero-products-overlay"></div>
    <div class="hero-products-container">
      <!-- Hero Content -->
      <div class="hero-products-header">
        <h1 class="hero-products-title">{homeContent.hero.title}</h1>
        <p class="hero-products-subtitle">{homeContent.hero.claim}</p>
      </div>

      <!-- Filters -->
      <div class="hero-products-filters">
        <FilterDropdown
          filterState={filterState}
          lang={lang}
        />
      </div>

      <!-- Products Carousel -->
      <div class="hero-products-carousel">
        <ProductCarousel
          products={filteredProducts}
          lang={lang}
          carouselId="product-carousel-desktop"
        />
      </div>
    </div>
  </section>

  <!-- Mobile: Separate Hero Section -->
  <section class="mobile-hero-section">
    <SolutionsHero
      title={homeContent.hero.title}
      subtitle={homeContent.hero.claim}
    />
  </section>

  <!-- Mobile: Products Section -->
  <section
    id="productos"
    class="mobile-products-section"
  >
    <div class="container">
      <h2 class="section-title">Productos</h2>
      <FilterDropdown
        filterState={filterState}
        lang={lang}
      />
      <ProductCarousel
        products={filteredProducts}
        lang={lang}
        carouselId="product-carousel-mobile"
      />
    </div>
  </section>

  <!-- Filter Script (works for both desktop and mobile) -->
  <script
    define:vars={{
      filterStateJson: JSON.stringify(filterState),
      allProductsJson: JSON.stringify(allProducts),
      filteredProductsJson: JSON.stringify(filteredProducts),
    }}
  >
    // Parse filterState from JSON (Astro serialization)
    const filterState = JSON.parse(filterStateJson);
    const allProducts = JSON.parse(allProductsJson);
    const filteredProducts = JSON.parse(filteredProductsJson);

    // Expose allProducts globally for FilterDropdown component
    window.__allProducts = allProducts;

    // ALSO parse from current URL to ensure we have the latest state
    const urlParams = new URLSearchParams(window.location.search);
    const urlFilterState = {
      tipoSemilla:
        urlParams.get("tipo") === "maiz" || urlParams.get("tipo") === "colza"
          ? urlParams.get("tipo")
          : undefined,
      uso: urlParams.get("uso") || undefined,
      zona: urlParams.get("zona") || undefined,
      proteccion: urlParams.get("proteccion") || "todos",
    };

    // Debug logs in browser console
    console.log(
      "ðŸ” [CLIENT] Server Filter State:",
      JSON.stringify(filterState, null, 2)
    );
    console.log(
      "ðŸ” [CLIENT] URL Filter State:",
      JSON.stringify(urlFilterState, null, 2)
    );
    console.log(
      "ðŸ” [CLIENT] FilterState tipoSemilla:",
      filterState.tipoSemilla
    );
    console.log("ðŸ” [CLIENT] FilterState proteccion:", filterState.proteccion);
    console.log("ðŸ“¦ All Products:", allProducts.length);
    console.log("âœ… Filtered Products (from server):", filteredProducts.length);

    if (allProducts.length > 0) {
      console.log(
        "ðŸ“‹ All Products Details:",
        allProducts.map((p) => ({
          nombre: p.nombre,
          tipo_semilla: p.tipo_semilla,
          proteccion: p.proteccion,
          uso: p.uso,
          zona: p.zona,
        }))
      );
      console.log(
        "âœ… Filtered Products Details (from server):",
        filteredProducts.map((p) => ({
          nombre: p.nombre,
          tipo_semilla: p.tipo_semilla,
          proteccion: p.proteccion,
          uso: p.uso,
          zona: p.zona,
        }))
      );

      // Client-side filtering as fallback ONLY if server filtering didn't work
      // Check if server filtering worked by comparing URL params with filtered products
      const hasActiveFilters =
        urlFilterState.tipoSemilla ||
        urlFilterState.uso ||
        urlFilterState.zona ||
        (urlFilterState.proteccion && urlFilterState.proteccion !== "todos");

      if (hasActiveFilters) {
        // Check if server filtering worked correctly
        const serverFilteredCorrectly =
          filteredProducts.length < allProducts.length ||
          filteredProducts.some((p) => {
            if (
              urlFilterState.tipoSemilla &&
              p.tipo_semilla !== urlFilterState.tipoSemilla
            )
              return false;
            if (
              urlFilterState.proteccion &&
              urlFilterState.proteccion !== "todos" &&
              p.proteccion !== urlFilterState.proteccion
            )
              return false;
            if (urlFilterState.uso && p.uso !== urlFilterState.uso)
              return false;
            if (urlFilterState.zona && p.zona !== urlFilterState.zona)
              return false;
            return true;
          });

        if (
          !serverFilteredCorrectly &&
          filteredProducts.length === allProducts.length
        ) {
          console.log(
            "âš ï¸ [CLIENT] Server filtering may have failed, applying client-side filter..."
          );
          let clientFiltered = [...allProducts];

          if (urlFilterState.tipoSemilla) {
            const before = clientFiltered.length;
            clientFiltered = clientFiltered.filter(
              (p) => p.tipo_semilla === urlFilterState.tipoSemilla
            );
            console.log(
              `ðŸ” Client filter tipoSemilla: ${before} -> ${clientFiltered.length}`
            );
          }

          if (urlFilterState.uso) {
            const before = clientFiltered.length;
            clientFiltered = clientFiltered.filter(
              (p) => p.uso === urlFilterState.uso
            );
            console.log(
              `ðŸ” Client filter uso: ${before} -> ${clientFiltered.length}`
            );
          }

          if (urlFilterState.zona) {
            const before = clientFiltered.length;
            clientFiltered = clientFiltered.filter(
              (p) => p.zona === urlFilterState.zona
            );
            console.log(
              `ðŸ” Client filter zona: ${before} -> ${clientFiltered.length}`
            );
          }

          if (
            urlFilterState.proteccion &&
            urlFilterState.proteccion !== "todos"
          ) {
            const before = clientFiltered.length;
            clientFiltered = clientFiltered.filter(
              (p) => p.proteccion === urlFilterState.proteccion
            );
            console.log(
              `ðŸ” Client filter proteccion: ${before} -> ${clientFiltered.length}`
            );
          }

          console.log(
            "âœ… Client-side Filtered Products:",
            clientFiltered.map((p) => ({
              nombre: p.nombre,
              tipo_semilla: p.tipo_semilla,
              proteccion: p.proteccion,
            }))
          );

          // Update carousel with client-filtered products
          if (clientFiltered.length !== filteredProducts.length) {
            console.log(
              "âš ï¸ [CLIENT] Updating carousel with client-filtered products"
            );
            // Wait a bit for carousel to be ready
            setTimeout(() => {
              const event = new CustomEvent("updateProducts", {
                detail: { products: clientFiltered },
              });
              document.dispatchEvent(event);
            }, 100);
          }
        } else {
          console.log(
            "âœ… [CLIENT] Server filtering worked correctly, using server-filtered products"
          );
        }
      }
    }
  </script>

  <!-- Solutions Section -->
  <section
    id="soluciones"
    class="solutions-section"
  >
    <div class="container">
      <h2 class="section-title">Soluciones</h2>
      <p class="section-description">
        Descubre nuestras soluciones integrales para el cultivo de maÃ­z.
      </p>
      <SolutionsCarousel
        solutions={[
          {
            id: "acceleron",
            name: "Acceleron",
            description:
              "Protege y nutre tu maÃ­z con AcceleronÂ® para un cultivo sano y productivo.",
            logo: "/Logo_Acceleron.svg",
            icon: "/Icon_Acceleron.svg",
          },
          {
            id: "fieldshield",
            name: "FieldShield",
            description:
              "Fortalece tu maÃ­z. FieldShield reduce el riesgo de enfermedades y mejora el rendimiento.",
            logo: "/Logo_Fieldshield.svg",
            icon: "/Icon_FieldShield.svg",
          },
          {
            id: "silo-extra",
            name: "Silo Extra",
            description:
              "MÃ¡s calidad, mÃ¡s cantidad. Descubre los hÃ­bridos SiloExtra y mejora tu cosecha.",
            logo: "/Logo_SiloExtra.svg",
            icon: "/Icon_SiloExtra.svg",
          },
          {
            id: "preceon",
            name: "Preceon",
            description:
              "Protege tu maÃ­z desde el primer dÃ­a con las soluciones Bayer mÃ¡s eficaces.",
            logo: "/Logo_Preceon.svg",
            icon: "/Icon_Preceon.svg",
          },
          {
            id: "fieldview",
            name: "FieldView",
            description:
              "SÃ¡cale partido a tus datos. Accede a FieldView y toma decisiones mÃ¡s inteligentes en cada campaÃ±a.",
            logo: "/Logo_Fieldview.svg",
            icon: "/Icon_FieldView.svg",
          },
        ]}
        lang={lang}
      />
    </div>
  </section>

  <!-- FieldView Section -->
  <section class="fieldview-section">
    <div class="container">
      <CTASection
        title={homeContent.solutions.fieldview}
        description="Plataforma digital para gestiÃ³n agrÃ­cola avanzada"
        buttonText="Conocer mÃ¡s"
        buttonLink="/es/fieldview"
        variant="primary"
        lang={lang}
      />
    </div>
  </section>

  <!-- ProtecciÃ³n de Cultivo Section -->
  <section class="protection-section">
    <div class="container">
      <CTASection
        title={homeContent.solutions.protection}
        description="Soluciones innovadoras para la protecciÃ³n de tus cultivos"
        buttonText="Ver soluciones"
        buttonLink="/es/#soluciones"
        variant="secondary"
        lang={lang}
      />
    </div>
  </section>

  <!-- Preceon Section -->
  <section class="preceon-section">
    <div class="container">
      <div class="preceon-wrapper">
        <div class="preceon-content">
          <div class="preceon-logo">
            <img
              src="/Logo_Preceon.svg"
              alt="Preceon"
            />
          </div>
          <h2 class="preceon-title">
            El futuro del maÃ­z estÃ¡ aquÃ­, accede para descubrirlo.
          </h2>
          <a
            href="/es/preceon"
            class="btn btn-primary"
            >Descubrir</a
          >
        </div>
        <div class="preceon-image">
          <img
            src="/card_background-preceon.png"
            alt="Preceon Pack"
          />
        </div>
      </div>
    </div>
  </section>

  <!-- Evita Problemas Section -->
  <section class="avoid-problems-section">
    <div class="container">
      <CTASection
        title={homeContent.solutions.avoidProblems}
        buttonText="Ver guÃ­as"
        buttonLink="/es/evita-problemas"
        variant="primary"
        lang={lang}
      />
    </div>
  </section>

  <!-- CatÃ¡logos Section -->
  <section class="catalogs-section">
    <div class="container">
      <h2 class="section-title">Descarga de CatÃ¡logos</h2>
      <div class="catalogs-grid">
        <a
          href="/es/catalogo"
          class="catalog-card"
        >
          <span class="catalog-flag">ðŸ‡ªðŸ‡¸</span>
          <span class="catalog-name">EspaÃ±a</span>
        </a>
        <a
          href="/pt/catalogo"
          class="catalog-card"
        >
          <span class="catalog-flag">ðŸ‡µðŸ‡¹</span>
          <span class="catalog-name">Portugal</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Blog Preview Section -->
  {
    latestArticles.length > 0 && (
      <section class="blog-preview-section">
        <div class="container">
          <h2 class="section-title">Ãšltimas Noticias</h2>
          <div class="blog-preview-grid">
            {latestArticles.map((article) => (
              <article class="blog-preview-card">
                {article.imagen_destacada?.url && (
                  <img
                    src={article.imagen_destacada.url}
                    alt={article.imagen_destacada.alt || article.titulo}
                    class="blog-preview-image"
                    loading="lazy"
                  />
                )}
                <div class="blog-preview-content">
                  <span class="badge badge-primary">{article.categoria}</span>
                  <h3 class="blog-preview-title">{article.titulo}</h3>
                  <p class="blog-preview-date">
                    {new Date(article.fecha).toLocaleDateString("es-ES")}
                  </p>
                  <p class="blog-preview-excerpt">{article.extracto}</p>
                  <a
                    href={`/es/blog/${article.slug}`}
                    class="btn btn-outline"
                  >
                    Leer mÃ¡s
                  </a>
                </div>
              </article>
            ))}
          </div>
          <div class="blog-preview-footer">
            <a
              href="/es/blog"
              class="btn btn-primary"
            >
              Ver todos los artÃ­culos
            </a>
          </div>
        </div>
      </section>
    )
  }

  <ProductModal lang={lang} />
</PageLayout>

<style>
  /* Hero + Products Combined Section (Desktop) */
  .hero-products-section {
    position: relative;
    min-height: 80vh;
    display: none;
    overflow: hidden;
  }

  @media (min-width: 1024px) {
    .hero-products-section {
      display: block;
    }
  }

  .hero-products-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url("/Frame_1410119213.jpg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 0;
  }

  .hero-products-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.3) 0%,
      rgba(0, 0, 0, 0.1) 50%,
      rgba(0, 0, 0, 0.2) 100%
    );
    z-index: 1;
  }

  .hero-products-container {
    position: relative;
    z-index: 2;
    padding-top: calc(var(--header-height) + var(--spacing-8));
    padding-bottom: var(--spacing-16);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-6);
    min-height: calc(100vh - var(--header-height));
    width: 100%;
    max-width: 100%;
  }

  .hero-products-header {
    text-align: center;
    color: var(--color-white);
  }

  .hero-products-title {
    font-size: var(--hero-title-size);
    font-weight: var(--font-weight-bold);
    color: var(--color-white);
    margin-bottom: var(--spacing-3);
    line-height: var(--line-height-tight);
    letter-spacing: var(--letter-spacing-normal);
  }

  .hero-products-subtitle {
    font-size: var(--hero-subtitle-size);
    color: var(--color-white);
    margin: 0;
    line-height: var(--line-height-normal);
    font-weight: var(--font-weight-regular);
  }

  .hero-products-filters {
    display: flex;
    justify-content: center;
  }

  .hero-products-carousel {
    width: 100%;
  }

  /* Hide section title in desktop hero-products section */
  .hero-products-section .section-title {
    display: none;
  }

  /* Mobile: Separate Sections */
  .mobile-hero-section {
    display: block;
  }

  .mobile-products-section {
    display: block;
    padding: var(--spacing-16) 0;
    background-color: var(--color-white);
  }

  @media (min-width: 1024px) {
    .mobile-hero-section,
    .mobile-products-section {
      display: none;
    }
  }

  .products-section {
    padding: var(--spacing-16) 0;
    background-color: var(--color-white);
  }

  .section-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    text-align: center;
    margin-bottom: var(--spacing-4);
    color: var(--color-white);
    line-height: var(--line-height-tight);
  }

  .section-description {
    font-size: var(--font-size-lg);
    text-align: center;
    margin-bottom: var(--spacing-8);
    color: var(--color-white);
    line-height: var(--line-height-relaxed);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }

  .solutions-section {
    padding: var(--spacing-16) 0;
    background: var(--gradient-hero-solutions);
  }

  .solutions-section .section-title,
  .solutions-section .section-description {
    color: var(--color-white);
  }

  .fieldview-section,
  .protection-section {
    padding: var(--spacing-12) 0;
  }

  .preceon-section {
    padding: var(--spacing-16) 0;
    background: transparent;
    color: var(--color-text-primary);
  }

  .preceon-wrapper {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    align-items: stretch;
    background: var(--color-white);
    border-radius: 12px 12px 12px 12px;
    overflow: hidden;
    min-height: 500px;
    position: relative;
  }

  .preceon-content {
    text-align: left;
    padding: var(--spacing-12) var(--spacing-8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: linear-gradient(to right, #e9e7e4 0%, #ffffff 100%);
    position: relative;
    z-index: 2;
  }

  .preceon-logo {
    margin-bottom: var(--spacing-8);
    display: block;
  }

  .preceon-logo img {
    height: 110px;
    width: auto;
    object-fit: cover;
    display: block;
  }

  .preceon-title {
    font-size: 1.5rem;
    font-weight: 300;
    font-family: var(--font-family-primary);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-8);
    line-height: 1.9rem;
    max-width: 423px;
    display: block;
  }

  .preceon-content .btn {
    width: auto;
    max-width: 212px;
    display: inline-block;
    text-align: center;
  }

  .preceon-image {
    display: none;
    position: relative;
    overflow: hidden;
  }

  .preceon-image img {
    width: 100%;
    height: 100%;
    object-fit: fill;
    display: block;
  }

  /* Desktop: Two columns layout - 30% contenido / 70% imagen */
  @media (min-width: 1024px) {
    .preceon-wrapper {
      grid-template-columns: 30% 70%;
      gap: 0;
      min-height: 400px;
      border-radius: 60px 12px 120px 12px; /* Superior izquierda e inferior derecha con radio mayor */
    }

    .preceon-content {
      padding: var(--spacing-12) var(--spacing-12);
      border-radius: 60px 0 0 0px; /* Solo esquina superior izquierda redondeada */
    }

    .preceon-image {
      display: block;
      border-radius: 0 12px 60px 0; /* Solo esquina inferior derecha redondeada */
    }
  }

  .avoid-problems-section {
    padding: var(--spacing-12) 0;
    background-color: var(--color-gray-50);
  }

  .catalogs-section {
    padding: var(--spacing-16) 0;
    background-color: var(--color-white);
  }

  .catalogs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-6);
    max-width: 600px;
    margin: 0 auto;
  }

  .catalog-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-6);
    background: var(--color-white);
    border: none;
    border-radius: var(--card-border-radius);
    text-decoration: none;
    transition: all var(--transition-base);
  }

  @media (max-width: 767px) {
    .catalog-card {
      background: var(--catalog-button-bg-mobile);
      color: var(--catalog-button-text-mobile);
    }
  }

  @media (min-width: 768px) {
    .catalog-card {
      background: var(--catalog-button-bg-desktop);
      color: var(--catalog-button-text-desktop);
    }
  }

  .catalog-card:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }

  .catalog-flag {
    font-size: 3rem;
  }

  .catalog-name {
    font-weight: var(--font-weight-bold);
    font-size: var(--button-font-size);
    color: inherit;
  }

  .blog-preview-section {
    padding: var(--spacing-16) 0;
    background-color: var(--color-gray-50);
  }

  .blog-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--spacing-6);
    margin-bottom: var(--spacing-8);
  }

  .blog-preview-card {
    background: var(--color-bayer-secondary);
    border-radius: var(--radius-sm);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
  }

  .blog-preview-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .blog-preview-image {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
  }

  .blog-preview-content {
    padding: var(--spacing-4);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
  }

  .blog-preview-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-regular);
    color: var(--color-white);
    margin: 0;
    line-height: var(--line-height-extra-relaxed);
  }

  .blog-preview-date {
    font-size: var(--font-size-base-sm);
    color: var(--color-white);
    margin: 0;
    opacity: 0.9;
  }

  .blog-preview-excerpt {
    font-size: var(--font-size-lg);
    color: var(--color-white);
    margin: 0;
    line-height: var(--line-height-extra-relaxed);
  }

  .blog-preview-footer {
    text-align: center;
  }

  @media (max-width: 767px) {
    .blog-preview-grid {
      grid-template-columns: 1fr;
    }

    .catalogs-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
