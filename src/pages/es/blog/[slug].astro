---
import BlogPost from "../../../layouts/BlogPost.astro";
import { getArticleBySlug, getAllArticles } from "../../../utils/prismic";
import { getLocalizedPath } from "../../../utils/i18n";
import { renderRichText } from "../../../utils/prismic-rich-text";

export async function getStaticPaths() {
  const articles = await getAllArticles("es");

  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;
const lang = "es";
const siteUrl = import.meta.env.SITE_URL || "https://dekalb-experience.com";
const articleUrl = `${siteUrl}/es/blog/${article.slug}`;

// Debug: log article content structure
console.log("Article contenido type:", typeof article.contenido);
console.log("Article contenido is array:", Array.isArray(article.contenido));
if (
  article.contenido &&
  Array.isArray(article.contenido) &&
  article.contenido.length > 0
) {
  console.log(
    "First content block:",
    JSON.stringify(article.contenido[0], null, 2)
  );
}

// Format date as "FEBRERO 21, 2024"
const formatDate = (dateString: string): string => {
  const date = new Date(dateString);
  const months = [
    "ENERO",
    "FEBRERO",
    "MARZO",
    "ABRIL",
    "MAYO",
    "JUNIO",
    "JULIO",
    "AGOSTO",
    "SEPTIEMBRE",
    "OCTUBRE",
    "NOVIEMBRE",
    "DICIEMBRE",
  ];
  return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
};

// Get related articles (excluding current)
let relatedArticles: any[] = [];
try {
  const allArticles = await getAllArticles(lang);
  relatedArticles = allArticles
    .filter((a) => a.id !== article.id && a.categoria === article.categoria)
    .slice(0, 3);
} catch (error) {
  console.error("Error fetching related articles:", error);
}
---

<BlogPost
  title={article.titulo}
  description={article.extracto}
  lang={lang}
  fecha={article.fecha}
  categoria={article.categoria}
  ogImage={article.imagen_destacada?.url}
>
  <div class="article-wrapper">
    <div class="article-container">
      {
        article.imagen_destacada?.url && (
          <img
            src={article.imagen_destacada.url}
            alt={article.imagen_destacada.alt || article.titulo}
            class="article-featured-image"
            loading="eager"
          />
        )
      }

      <div class="article-header">
        <p class="article-date">{formatDate(article.fecha)}</p>
        <h1 class="article-title">{article.titulo}</h1>
        {article.extracto && <p class="article-intro">{article.extracto}</p>}
        {
          article.tags && article.tags.length > 0 && (
            <div class="article-tags">
              <span class="tags-label">TAGS:</span>
              {article.tags.map((tag) => (
                <span class="tag-badge">{tag}</span>
              ))}
            </div>
          )
        }
      </div>

      <div class="article-content">
        {
          article.contenido && (
            <div
              class="rich-text-content"
              set:html={renderRichText(article.contenido)}
            />
          )
        }
      </div>

      <div class="article-share">
        <span class="share-label">SHARE:</span>
        <div class="share-buttons">
          <a
            href={`https://www.youtube.com/share?url=${encodeURIComponent(articleUrl)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="share-button share-youtube"
            aria-label="Compartir en YouTube"
          >
            <img
              src="/icon_share-youtube.svg"
              alt=""
              aria-hidden="true"
            />
          </a>
          <a
            href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(articleUrl)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="share-button share-facebook"
            aria-label="Compartir en Facebook"
          >
            <img
              src="/icon_share-facebook.svg"
              alt=""
              aria-hidden="true"
            />
          </a>
          <button
            type="button"
            class="share-button share-instagram"
            aria-label="Copiar enlace para compartir en Instagram"
            data-share-url={articleUrl}
          >
            <img
              src="/icon_share-instagram.svg"
              alt=""
              aria-hidden="true"
            />
          </button>
        </div>
      </div>
    </div>
  </div>

  {
    relatedArticles.length > 0 && (
      <section class="related-articles">
        <div class="container">
          <h2>Art√≠culos relacionados</h2>
          <div class="related-grid">
            {relatedArticles.map((related) => (
              <article class="related-card">
                {related.imagen_destacada?.url && (
                  <img
                    src={related.imagen_destacada.url}
                    alt={related.imagen_destacada.alt || related.titulo}
                    class="related-image"
                    loading="lazy"
                  />
                )}
                <div class="related-content">
                  <h3>
                    <a href={getLocalizedPath(`/blog/${related.slug}`, lang)}>
                      {related.titulo}
                    </a>
                  </h3>
                  <time datetime={related.fecha}>
                    {new Date(related.fecha).toLocaleDateString("es-ES")}
                  </time>
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>
    )
  }
</BlogPost>

<style>
  .article-wrapper {
    background-image: url("/background-article.png");
    background-position: top center;
    background-repeat: no-repeat;
    background-size: contain;
    background-color: #ffffff;
    padding: var(--spacing-16) 0;
  }

  .article-container {
    max-width: 1196px;
    margin: 0 auto;
    padding: 0 var(--spacing-4);
  }

  .article-featured-image {
    width: 100%;
    max-width: 1196px;
    height: 560px;
    object-fit: cover;
    border-radius: 60px;
    margin-bottom: var(--spacing-12);
    display: block;
  }

  .article-header {
    max-width: 708px;
    margin: 0 auto var(--spacing-12);
  }

  .article-date {
    font-size: 20px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #009ddb;
    margin: 0 0 var(--spacing-4) 0;
    line-height: 26px;
    text-transform: uppercase;
  }

  .article-title {
    font-size: 48px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #009ddb;
    margin: 0 0 var(--spacing-6) 0;
    line-height: 57.6px;
    letter-spacing: 0.96px;
  }

  .article-intro {
    font-size: 34px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #313639;
    margin: 0 0 var(--spacing-8) 0;
    line-height: 44.2px;
  }

  .article-tags {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    flex-wrap: wrap;
  }

  .tags-label {
    font-size: 16px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #313639;
    line-height: 20.8px;
  }

  .tag-badge {
    background-color: #e9e7e4;
    color: #313639;
    padding: 4px 12px;
    border-radius: 100px;
    font-size: 14px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    line-height: 18.2px;
    text-transform: capitalize;
  }

  .article-content {
    max-width: 708px;
    margin: 0 auto var(--spacing-12);
  }

  .rich-text-content {
    font-size: 20px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #292929;
    line-height: 30px;
  }

  .rich-text-content :global(h2) {
    font-size: 32px;
    font-weight: 700;
    margin-top: var(--spacing-8);
    margin-bottom: var(--spacing-4);
    color: #292929;
    line-height: 1.2;
  }

  .rich-text-content :global(h3) {
    font-size: 24px;
    font-weight: 600;
    margin-top: var(--spacing-6);
    margin-bottom: var(--spacing-3);
    color: #292929;
    line-height: 1.3;
  }

  .rich-text-content :global(p) {
    margin-bottom: var(--spacing-6);
  }

  .rich-text-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 60px;
    margin: var(--spacing-8) 0;
    display: block;
  }

  .rich-text-content :global(blockquote) {
    border-left: 4px solid #009ddb;
    padding-left: var(--spacing-4);
    margin: var(--spacing-6) 0;
    font-style: italic;
    color: #313639;
  }

  .article-share {
    max-width: 708px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
  }

  .share-label {
    font-size: 16px;
    font-weight: 400;
    font-family: var(--font-family-primary);
    color: #292929;
    line-height: 20.8px;
  }

  .share-buttons {
    display: flex;
    gap: var(--spacing-4);
  }

  .share-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #009ddb;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
    text-decoration: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .share-button:hover {
    background-color: #005475;
    transform: scale(1.1);
  }

  .share-button img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }

  .related-articles {
    margin-top: var(--spacing-16);
    padding: var(--spacing-12) 0;
    border-top: 2px solid var(--color-gray-200);
    background-color: var(--color-white);
  }

  .related-articles .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-4);
  }

  .related-articles h2 {
    font-size: var(--font-size-2xl);
    margin-bottom: var(--spacing-6);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
  }

  .related-card {
    background: var(--color-white);
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
  }

  .related-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .related-image {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
  }

  .related-content {
    padding: var(--spacing-3);
  }

  .related-content h3 {
    font-size: var(--font-size-base);
    margin-bottom: var(--spacing-2);
  }

  .related-content a {
    color: var(--color-gray-900);
    text-decoration: none;
  }

  .related-content a:hover {
    color: #009ddb;
  }

  .related-content time {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
  }

  @media (max-width: 1023px) {
    .article-featured-image {
      height: 400px;
      border-radius: 40px;
    }

    .article-title {
      font-size: 36px;
      line-height: 44px;
    }

    .article-intro {
      font-size: 28px;
      line-height: 36px;
    }
  }

  @media (max-width: 767px) {
    .article-featured-image {
      height: 300px;
      border-radius: 24px;
    }

    .article-title {
      font-size: 32px;
      line-height: 40px;
      letter-spacing: 0.5px;
    }

    .article-intro {
      font-size: 24px;
      line-height: 32px;
    }

    .article-share {
      flex-direction: column;
      align-items: flex-start;
    }

    .share-buttons {
      flex-wrap: wrap;
    }
  }
</style>

<script>
  // Handle Instagram share button (copy to clipboard)
  document.addEventListener("DOMContentLoaded", () => {
    const instagramButton = document.querySelector(".share-instagram");
    if (instagramButton) {
      instagramButton.addEventListener("click", async () => {
        const url = instagramButton.getAttribute("data-share-url");
        if (url && navigator.clipboard) {
          try {
            await navigator.clipboard.writeText(url);
            // Optional: Show a toast notification
            const originalAriaLabel =
              instagramButton.getAttribute("aria-label");
            instagramButton.setAttribute("aria-label", "Enlace copiado");
            setTimeout(() => {
              instagramButton.setAttribute(
                "aria-label",
                originalAriaLabel || ""
              );
            }, 2000);
          } catch (err) {
            console.error("Failed to copy:", err);
          }
        }
      });
    }
  });
</script>
